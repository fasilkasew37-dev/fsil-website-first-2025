áŠ <!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>á‹áˆ²áˆ á‹Œá‰¥ áŠ á• - Fasil Web App (V15.0 - First Fix)</title>
    <style>
        /* --- áˆ˜á‹°á‰ áŠ› CSS --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center;
            padding: 20px;
            background-color: #f0f4f8;
            color: #333;
            margin: 0;
        }
        .section {
            max-width: 700px;
            margin: 20px auto;
            padding: 25px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            border-top: 6px solid #007bff;
            text-align: left;
            display: none; 
            padding-bottom: 80px;
        }
        /* --- áˆ˜áŒ€áˆ˜áˆªá‹« á‹¨áˆšá‰³á‹¨á‹ áŒˆáŒ½ --- */
        #agreement-view { display: block; }
        
        h1 { color: #007bff; font-size: 28px; margin-bottom: 10px; text-align: center; }
        h2 { color: #555; font-size: 22px; margin-top: 20px; margin-bottom: 20px; text-align: center; }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 8px;
            box-sizing: border-box;
            font-size: 16px;
        }
        
        /*Buttons*/
        button, .button-link {
            display: block; width: 100%; padding: 15px; margin: 12px 0;
            text-align: center; border-radius: 8px; font-weight: bold; cursor: pointer;
            border: none; font-size: 16px; color: white; transition: 0.3s;
        }
        .main-btn { background-color: #007bff; }
        .success-btn { background-color: #28a745; }
        .delete-btn { background-color: #dc3545; }
        .premium-btn { background-color: #ffc107; color: #333; }
        .feature-btn { background-color: #8c5aee; }
        .business-btn { background-color: #00a08e; }
        .social-btn { background-color: #ff7043; }

        /* --- Custom Modal (Center Alert) --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.6); display: none;
            justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-box {
            background: white; padding: 25px; border-radius: 12px;
            width: 85%; max-width: 400px; text-align: center;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); animation: popIn 0.3s ease;
        }
        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .modal-title { font-size: 20px; margin-bottom: 10px; font-weight: bold; }

        /* --- Cards --- */
        .user-card, .chat-message {
            display: flex; align-items: center; padding: 10px;
            border: 1px solid #eee; border-radius: 8px; margin-bottom: 8px;
            background-color: #fff;
        }
        .user-card img { width: 45px; height: 45px; border-radius: 50%; margin-right: 12px; object-fit: cover; }
        .chat-container {
            height: 400px; overflow-y: auto; border: 1px solid #ddd;
            padding: 10px; background: #f9f9f9; margin-bottom: 10px; border-radius: 8px;
        }
        .chat-message { align-items: flex-start; flex-direction: column; }
        .chat-message.self { align-items: flex-end; background-color: #e3f2fd; border-color: #bbdefb; }
        .chat-bubble { padding: 8px 12px; background: #eee; border-radius: 10px; margin-top: 5px; display: inline-block; }
        .self .chat-bubble { background: #007bff; color: white; }

        /* --- Loading --- */
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.9); display: none;
            justify-content: center; align-items: center; z-index: 1000; flex-direction: column;
        }
        .spinner {
            border: 6px solid #f3f3f3; border-top: 6px solid #007bff;
            border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="spinner"></div>
        <p>... áŠ¥á‹¨á‰°áŒ«áŠ áŠá‹ ...</p>
    </div>

    <!-- Custom Center Modal (Alerts) -->
    <div class="modal-overlay" id="custom-modal">
        <div class="modal-box">
            <div class="modal-title" id="modal-title">áˆ›áˆµáŒ áŠ•á‰€á‰‚á‹«</div>
            <div id="modal-text" style="margin-bottom: 20px;"></div>
            <button class="main-btn" onclick="closeModal()">áŠ¥áˆº (OK)</button>
        </div>
    </div>
    
    <!-- Password Prompt Modal for Withdraw -->
    <div class="modal-overlay" id="password-modal">
        <div class="modal-box">
            <div class="modal-title">á‹¨á‹­áˆˆá á‰ƒáˆ áˆ›áˆ¨áŒ‹áŒˆáŒ«</div>
            <p>á‹­áˆ…áŠ•áŠ• áˆˆáˆ›á‹µáˆ¨áŒ áŠ¥á‰£áŠ­á‹ á‹¨á‹­áˆˆá á‰ƒáˆ á‹«áˆµáŒˆá‰¡á¡</p>
            <input type="password" id="modal-password-input" placeholder="á‹¨á‹­áˆˆá á‰ƒáˆ" style="text-align: center;">
            <button class="success-btn" onclick="confirmWithdrawWithPassword()">áŠ áˆ¨áŒ‹áŒáŒ¥</button>
            <button class="delete-btn" onclick="document.getElementById('password-modal').style.display='none'">áˆ°áˆ­á‹</button>
        </div>
    </div>

    <!-- 1. Agreement View -->
    <div class="section" id="agreement-view">
        <h1>á‹áˆ²áˆ á‹Œá‰¥ áŠ á• (Fasil Web)</h1>
        <div style="background:#e9ecef; padding:15px; border-radius:8px;">
            <h3>ğŸŒ áˆµáˆˆ áŠ á•áˆŠáŠ¬áˆ½áŠ‘</h3>
            <p>á‹áˆ²áˆ á‹Œá‰¥ áŠ á• á‹²áŒ‚á‰³áˆ áˆ˜áŒ‹áˆªá‹« áˆ˜á‹µáˆ¨áŠ­ áŠá‹á¢ á“á‹ˆáˆ­ á–á‹­áŠ•á‰µá£ á’á‹²áŠ¤á áŠ¥áŠ“ á‰ªá‹²á‹®á‹á‰½áŠ• áˆ›áŒ‹áˆ«á‰µ á‹«áˆµá‰½áˆ‹áˆá¢</p>
        </div>
        <div style="background:#ffe0b2; padding:15px; margin-top:20px; border-left:5px solid orange;">
            <h3>âš ï¸ áŒ¥á‰¥á‰… áˆ˜áˆ˜áˆªá‹«</h3>
            <p>á–áˆˆá‰²áŠ«á‹Šá£ á‹˜áˆ¨áŠáŠá‰µ áŠ¥áŠ“ áŒ¥áˆ‹á‰» áŠ•áŒáŒáˆ®á‰½ á‰ áŒ¥á‰¥á‰… á‹¨á‰°áŠ¨áˆˆáŠ¨áˆ‰ áŠ“á‰¸á‹á¢</p>
        </div>
        <h2>á‹­á‰€á‰ áˆ‹áˆ‰?</h2>
        <button class="success-btn" onclick="showView('home-view')">âœ… áŠ¥áˆµáˆ›áˆ›áˆˆáˆ</button>
        <button class="delete-btn" onclick="closeModalAlert('áˆ˜á‰°áŒá‰ áˆªá‹«á‹áŠ• áˆˆáˆ˜áŒ á‰€áˆ áˆ˜áˆµáˆ›áˆ›á‰µ áŒá‹´á‰³ áŠá‹á¢', 'error')">âŒ áŠ áˆáˆµáˆ›áˆ›áˆ</button>
    </div>

    <!-- 2. Home -->
    <div class="section" id="home-view">
        <h1>áŠ¥áŠ•áŠ³áŠ• á‹°áˆ…áŠ“ áˆ˜áŒ¡</h1>
        <h2>áŠ¥áŠ•á‹´á‰µ áˆ˜áŒ á‰€áˆ á‹­áˆáˆáŒ‹áˆ‰?</h2>
        <button class="main-btn" onclick="showView('signup-form')">á‰ áŠáƒ áˆˆáˆ˜áˆ˜á‹áŒˆá‰¥ / áˆˆáˆ˜áŒá‰£á‰µ</button>
        <button class="premium-btn" onclick="showView('premium-options')">á•áˆªáˆšá‹¨áˆ áŠ áˆ›áˆ«áŒ®á‰½</button>
    </div>

    <!-- 3. Signup Form -->
    <div class="section" id="signup-form">
        <h2>áŠ á‹²áˆµ á‰°áŒ á‰ƒáˆš áˆá‹áŒˆá‰£</h2>
        <input type="text" id="signup-name" placeholder="áˆ™áˆ‰ áˆµáˆ" required>
        <input type="text" id="signup-phone" placeholder="áˆµáˆáŠ­ á‰áŒ¥áˆ­" required>
        <input type="email" id="signup-email" placeholder="áŠ¢áˆœáˆ (@gmail.com á‰¥á‰»)" required>
        <input type="password" id="signup-password" placeholder="á‹¨á‹­áˆˆá á‰ƒáˆ (6 áŠ áˆ€á‹)" maxlength="6" required>
        <p>**á‹¨á•áˆ®á‹á‹­áˆ áá‰¶ áŒá‹´á‰³ áŠá‹**</p>
        <input type="file" id="signup-profile-photo" accept="image/*">
        
        <button class="success-btn" onclick="handleSignUp()">áˆ˜á‹áŒá‰¥ (Sign Up)</button>
        <p onclick="showView('login-form')" style="cursor:pointer; color:#007bff; text-decoration:underline;">á‰°áˆ˜á‹áŒá‰ á‹‹áˆ? á‹­áŒá‰¡ (Log In)</p>
    </div>

    <!-- 4. Login Form -->
    <div class="section" id="login-form">
        <h2>áˆ˜áŒá‰¢á‹« (Log In)</h2>
        <input type="text" id="login-phone" placeholder="áˆµáˆáŠ­ á‰áŒ¥áˆ­">
        <input type="password" id="login-password" placeholder="á‹¨á‹­áˆˆá á‰ƒáˆ">
        <button class="main-btn" onclick="handleLogin()">áŒá‰£</button>
        <p onclick="showView('signup-form')" style="cursor:pointer; color:#007bff; text-decoration:underline;">áŠ á‹²áˆµ áŠá‹á‰µ? á‹­áˆ˜á‹áŒˆá‰¡</p>
    </div>

    <!-- 5. Dashboard -->
    <div class="section" id="dashboard-view">
        <h1 id="dash-title">á‹³áˆ½á‰¦áˆ­á‹µ</h1>
        
        <button class="main-btn" onclick="showView('view-select')">ğŸ“„ áˆ˜áˆ¨áŒƒ áˆ˜áˆ˜áˆáŠ¨á‰µ (View)</button>
        <button class="main-btn" onclick="showView('post-select')">âœï¸ áˆ˜áˆ¨áŒƒ áˆ˜áˆˆáŒ á (Post)</button>
        
        <h3 style="border-bottom:1px solid #ddd;">áˆ›áˆ…á‰ áˆ«á‹Š</h3>
        <button class="social-btn" onclick="handlePrivateChatStart()">ğŸ’¬ á‰ á‹áˆµáŒ¥ áˆ˜áˆµáˆ˜áˆ­ áˆ›á‹áˆ«á‰µ</button>
        <button class="social-btn" onclick="handleGroupCreation()">ğŸ‘¥ áŠ á‹²áˆµ á‰¡á‹µáŠ• áˆ˜ááŒ áˆ­</button>
        <button class="social-btn" style="background-color: #5e35b1;" onclick="showMyGroupsList()">ğŸ“‚ á‹¨áˆáŒ áˆ©á‰µáŠ• áŒáˆ©á• áˆˆáˆ˜áˆ˜áˆáŠ¨á‰µ</button>
        
        <h3 style="border-bottom:1px solid #ddd;">á‰¢á‹áŠáˆµ</h3>
        <button class="business-btn" onclick="checkAuthAndRedirect('business-dashboard')">ğŸ’° á‰¢á‹áŠáˆµ áˆ›á‹•áŠ¨áˆ</button>
        
        <button class="success-btn" style="background-color: #00bcd4;" onclick="showView('feedback-to-admin')">ğŸ“ áˆˆáŠ á• áˆáŒ£áˆª áŠ áˆµá‰°á‹«á‹¨á‰µ áˆˆáˆ˜áˆµáŒ á‰µ</button>

        <button class="delete-btn" style="margin-top:30px; background:#6c757d;" onclick="handleLogout()">á‹áŒ£ (Log Out)</button>
    </div>

    <!-- 6. Private Chat View -->
    <div class="section" id="private-chat-room">
        <h2 id="chat-partner-name">á‹á‹­á‹­á‰µ</h2>
        <div class="chat-container" id="private-chat-messages"></div>
        <div style="display:flex; gap:5px;">
            <input type="text" id="chat-input-text" placeholder="áˆ˜áˆáŠ¥áŠ­á‰µ..." style="flex:1;">
            <button style="width:auto;" class="main-btn" onclick="sendPrivateMessage('text')">áˆ‹áŠ­</button>
        </div>
        <div style="display:flex; gap:5px; margin-top:5px;">
             <button class="feature-btn" onclick="triggerChatMedia('image')">ğŸ“·</button>
             <button class="feature-btn" onclick="triggerChatMedia('video')">ğŸ¥</button>
             <button class="feature-btn" onclick="triggerChatMedia('audio')">ğŸ™ï¸</button>
        </div>
        <input type="file" id="chat-file-input" style="display:none;">
        <button class="delete-btn" onclick="showView('dashboard-view')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 7. Group List -->
    <div class="section" id="my-groups-view">
        <h2>ğŸ“‚ áŒáˆ©á–á‰½</h2>
        <div id="groups-list-container"></div>
        <button class="delete-btn" onclick="showView('dashboard-view')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 8. Group Manage -->
    <div class="section" id="single-group-manage">
        <h2 id="group-manage-title">áŒáˆ©á•</h2>
        <div class="chat-container" id="group-posts-container"></div>
        <button class="main-btn" onclick="postToGroup('text')">âœï¸ áŒ½áˆá</button>
        <button class="feature-btn" onclick="postToGroup('media')">ğŸ“·/ğŸ¥ áˆšá‹²á‹«</button>
        <button class="delete-btn" onclick="showMyGroupsList()">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 9. Feedback -->
    <div class="section" id="feedback-to-admin">
        <h2>ğŸ“ áŠ áˆµá‰°á‹«á‹¨á‰µ á‹­áˆµáŒ¡</h2>
        <button class="main-btn" onclick="handleAdminFeedback('text')">á‰ á…áˆá</button>
        <button class="feature-btn" onclick="handleAdminFeedback('voice')">á‰ á‹µáˆá…</button>
        <button class="premium-btn" onclick="handleAdminFeedback('video')">á‰ á‰ªá‹²á‹® (Live)</button>
        <input type="file" id="feedback-media-input" style="display:none;">
        <button class="delete-btn" onclick="showView('dashboard-view')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 10. View Posts -->
    <div class="section" id="view-select">
        <h2>áˆ˜áˆ¨áŒƒ áˆ˜áˆ˜áˆáŠ¨á‰µ</h2>
        <button class="main-btn" onclick="displayPosts('text')">áŒ½áˆáá‰½</button>
        <button class="main-btn" onclick="displayPosts('image')">áˆáˆµáˆá‰½</button>
        <button class="main-btn" onclick="displayPosts('audio')">á‰ªá‹²á‹®/áŠ¦á‹²á‹®</button>
        <button class="delete-btn" onclick="showView('dashboard-view')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>
    
    <div class="section" id="posts-viewer">
        <h2 id="viewer-title">á‹áˆ­á‹áˆ­</h2>
        <div id="posts-container"></div>
        <button class="delete-btn" onclick="showView('view-select')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 11. Post Info -->
    <div class="section" id="post-select">
        <h2>áˆ˜áˆ¨áŒƒ áˆ˜áˆˆáŒ á</h2>
        <input type="text" id="post-title-input" placeholder="áˆ­á‹•áˆµ">
        <textarea id="post-content-input" placeholder="áŒ½áˆá..."></textarea>
        <input type="file" id="post-file-input">
        <button class="success-btn" onclick="createNewPost()">á‹­áˆˆáŒ¥á‰</button>
        <button class="delete-btn" onclick="showView('dashboard-view')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 12. User List (Reusable) -->
    <div class="section" id="user-list-view">
        <h2 id="user-list-title">á‰°áŒ á‰ƒáˆš á‹­áˆáˆ¨áŒ¡</h2>
        <div id="user-list-container"></div>
        <button id="user-list-action-btn" class="success-btn" style="display:none;">áŒ¨áˆ­áˆ»áˆˆáˆ</button>
        <button class="delete-btn" onclick="showView('dashboard-view')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 13. Business Dashboard -->
    <div class="section" id="business-dashboard">
        <h2>ğŸ’° á‹¨á‰¢á‹áŠáˆµ áˆ›á‹•áŠ¨áˆ</h2>
        <div style="background:#00a08e; color:white; padding:20px; border-radius:8px; margin-bottom:20px;">
            <h3>áˆšá‹›áŠ• (Balance):</h3>
            <p id="business-balance-display" style="font-size:30px; font-weight:bold;">0.00 USD</p>
        </div>
        <button class="success-btn" onclick="showView('deposit-view')">áŒˆáŠ•á‹˜á‰¥ áˆˆáˆ›áˆµáŒˆá‰£á‰µ</button>
        <button class="main-btn" onclick="showView('withdraw-view')">áŒˆáŠ•á‹˜á‰¥ áˆˆáˆ›á‹áŒ£á‰µ</button>
        <button class="delete-btn" onclick="showView('dashboard-view')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 14. Withdraw View -->
    <div class="section" id="withdraw-view">
        <h2>ğŸ’¸ áŒˆáŠ•á‹˜á‰¥ áˆ›á‹áŒ£á‰µ</h2>
        <input type="number" id="withdraw-amount" placeholder="áˆ˜áŒ áŠ• ($)">
        <select id="withdraw-method" onchange="toggleReceiverInput()">
            <option value="">á‹˜á‹´ á‹­áˆáˆ¨áŒ¡</option>
            <option value="Telebirr">á‰´áˆŒá‰¥áˆ­</option>
            <option value="CBE">CBE (áŠ•áŒá‹µ á‰£áŠ•áŠ­)</option>
            <option value="PayPal">PayPal</option>
        </select>
        <input type="text" id="withdraw-receiver" placeholder="á‰áŒ¥áˆ­/áŠ áŠ«á‹áŠ•á‰µ á‹«áˆµáŒˆá‰¡" style="display:none;">
        <button class="main-btn" onclick="initiateWithdraw()">áŒˆáŠ•á‹˜á‰¥ áŠ á‹áŒ£</button>
        <button class="delete-btn" onclick="showView('business-dashboard')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <!-- 15. Deposit View -->
    <div class="section" id="deposit-view">
        <h2>ğŸ’µ áŒˆáŠ•á‹˜á‰¥ áˆ›áˆµáŒˆá‰£á‰µ</h2>
        <input type="number" id="deposit-amount" placeholder="ETB áˆ˜áŒ áŠ•">
        <p>á‹°áˆ¨áˆ°áŠ áá‰¶á¡</p>
        <input type="file" id="deposit-receipt">
        <button class="success-btn" onclick="handleDeposit()">áŠ áˆµáŒˆá‰£</button>
        <button class="delete-btn" onclick="showView('business-dashboard')">á‰°áˆ˜áˆˆáˆµ</button>
    </div>

    <script>
        // --- Global State ---
        let currentUser = JSON.parse(localStorage.getItem('fasil_user')) || null;
        let users = JSON.parse(localStorage.getItem('fasil_users')) || [];
        let posts = JSON.parse(localStorage.getItem('fasil_posts')) || [];
        let groups = JSON.parse(localStorage.getItem('fasil_groups')) || [];
        let privateChats = JSON.parse(localStorage.getItem('fasil_chats')) || {};
        let activeChatUser = null;
        let activeGroup = null;

        // --- Basic Utils ---
        function showView(viewId) {
            document.querySelectorAll('.section').forEach(el => el.style.display = 'none');
            document.getElementById(viewId).style.display = 'block';
            if(viewId === 'business-dashboard') updateBalance();
        }

        function closeModalAlert(msg, type) {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').textContent = type==='error'?"âŒ áˆµáˆ…á‰°á‰µ":"âœ… áˆµáŠ¬á‰µ";
            document.getElementById('modal-title').style.color = type==='error'?"red":"green";
            document.getElementById('modal-text').textContent = msg;
            modal.style.display = 'flex';
        }
        function closeModal() { document.getElementById('custom-modal').style.display = 'none'; }

        // --- Auth ---
        function handleSignUp() {
            const name = document.getElementById('signup-name').value;
            const phone = document.getElementById('signup-phone').value;
            const email = document.getElementById('signup-email').value;
            const pass = document.getElementById('signup-password').value;
            const photo = document.getElementById('signup-profile-photo').files[0];

            if(!email.endsWith('@gmail.com')) return closeModalAlert("áŠ¢áˆœáˆ @gmail.com á‰¥á‰»", "error");
            if(users.some(u=>u.phone===phone || u.email===email)) return closeModalAlert("á‰°áˆ˜á‹áŒá‰§áˆ!", "error");
            if(!photo) return closeModalAlert("áá‰¶ áŒá‹´á‰³ áŠá‹", "error");

            const reader = new FileReader();
            reader.onload = e => {
                const newUser = { name, phone, email, password: pass, photo: e.target.result, balance: 0 };
                users.push(newUser);
                localStorage.setItem('fasil_users', JSON.stringify(users));
                closeModalAlert("á‰°áˆ˜á‹áŒá‰ á‹‹áˆ!", "success");
                showView('login-form');
            };
            reader.readAsDataURL(photo);
        }

        function handleLogin() {
            const p = document.getElementById('login-phone').value;
            const pass = document.getElementById('login-password').value;
            const u = users.find(user => user.phone === p && user.password === pass);
            if(u) {
                currentUser = u;
                localStorage.setItem('fasil_user', JSON.stringify(u));
                showView('dashboard-view');
            } else closeModalAlert("áˆµáˆ…á‰°á‰µ", "error");
        }

        function handleLogout() { currentUser=null; localStorage.removeItem('fasil_user'); showView('home-view'); }
        function checkAuthAndRedirect(v) { if(!currentUser) showView('login-form'); else showView(v); }
        function checkFreeSignupForPremium() { if(!currentUser) { closeModalAlert("áˆ˜áŒ€áˆ˜áˆªá‹« á‹­áˆ˜á‹áŒˆá‰¡", "error"); showView('signup-form'); } }

        // --- Posts ---
        function createNewPost() {
            const t = document.getElementById('post-title-input').value;
            const c = document.getElementById('post-content-input').value;
            const f = document.getElementById('post-file-input').files[0];
            if(!t) return closeModalAlert("áˆ­á‹•áˆµ á‹­áŒ»á‰", "error");

            const save = (d, type) => {
                posts.unshift({ id: Date.now(), title: t, content: c, fileData: d, type, author: currentUser.name, comments: [] });
                localStorage.setItem('fasil_posts', JSON.stringify(posts));
                closeModalAlert("á‰°áˆˆáŒ¥ááˆ", "success");
                showView('dashboard-view');
            };
            if(f) {
                let type = f.type.startsWith('image')?'image':(f.type.startsWith('video')?'video':'audio');
                const r = new FileReader();
                r.onload = e => save(e.target.result, type);
                r.readAsDataURL(f);
            } else save(null, 'text');
        }

        function displayPosts(type) {
            const c = document.getElementById('posts-container');
            c.innerHTML = '';
            const filtered = posts.filter(p => p.type === type || (type==='audio' && p.type==='video')); // Group A/V
            if(!filtered.length) c.innerHTML = "<p>á‹¨áˆˆáˆ</p>";
            filtered.forEach(p => {
                let m = '';
                if(p.fileData) {
                    if(p.type==='image') m=`<img src="${p.fileData}" style="width:100%">`;
                    else if(p.type==='video') m=`<video src="${p.fileData}" controls style="width:100%"></video>`;
                    else m=`<audio src="${p.fileData}" controls></audio>`;
                }
                const coms = p.comments.map(cm => `<div><b>${cm.u}:</b> ${cm.t}</div>`).join('');
                const d = document.createElement('div');
                d.style.background="#fff"; d.style.padding="10px"; d.style.marginBottom="10px";
                d.innerHTML = `<h3>${p.title}</h3><p>${p.content}</p>${m}<hr>
                <div>${coms}</div>
                <input type="text" id="cm-${p.id}" placeholder="Comment...">
                <button onclick="addComment(${p.id})">Comment</button>`;
                c.appendChild(d);
            });
            showView('posts-viewer');
        }
        function addComment(pid) {
            const t = document.getElementById(`cm-${pid}`).value;
            if(!t) return;
            const p = posts.find(i=>i.id===pid);
            p.comments.push({u:currentUser.name, t});
            localStorage.setItem('fasil_posts', JSON.stringify(posts));
            // Refresh logic omitted for brevity, user can re-open view
            closeModalAlert("áŠ áˆµá‰°á‹«á‹¨á‰µ á‰°áˆ°áŒ¥á‰·áˆ", "success");
        }

        // --- Groups ---
        function handleGroupCreation() {
            const n = prompt("Group Name:");
            if(!n) return;
            showView('user-list-view');
            const c = document.getElementById('user-list-container');
            c.innerHTML='';
            let sel = [currentUser.phone];
            users.forEach(u=>{
                if(u.phone===currentUser.phone)return;
                const d=document.createElement('div');
                d.className='user-card';
                d.innerHTML=`<img src="${u.photo}"> ${u.name}`;
                d.onclick=()=>{
                    if(sel.includes(u.phone)) { sel=sel.filter(x=>x!==u.phone); d.style.background="white"; }
                    else { sel.push(u.phone); d.style.background="#ccc"; }
                };
                c.appendChild(d);
            });
            const btn = document.getElementById('user-list-action-btn');
            btn.style.display='block';
            btn.onclick=()=>{
                if(sel.length<2) return closeModalAlert("á‰¢á‹«áŠ•áˆµ 1 áˆ°á‹ á‹­áŒ¨áˆáˆ©", "error");
                groups.push({id:Date.now(), name:n, members:sel, creator:currentUser.phone, posts:[]});
                localStorage.setItem('fasil_groups', JSON.stringify(groups));
                closeModalAlert("áŒáˆ©á• á‰°áˆáŒ¥áˆ¯áˆ", "success");
                showView('dashboard-view');
            };
        }
        function showMyGroupsList() {
            const c = document.getElementById('groups-list-container');
            c.innerHTML = groups.filter(g=>g.members.includes(currentUser.phone)).map(g=>
                `<div onclick="openGroup(${g.id})" class="user-card" style="cursor:pointer"><b>${g.name}</b></div>`
            ).join('');
            showView('my-groups-view');
        }
        function openGroup(gid) {
            activeGroup = groups.find(g=>g.id===gid);
            document.getElementById('group-manage-title').textContent = activeGroup.name;
            const c = document.getElementById('group-posts-container');
            c.innerHTML = activeGroup.posts.map(p=>`<div><b>${p.s}:</b> ${p.t}</div>`).join('');
            showView('single-group-manage');
        }
        function postToGroup(type) {
            if(type==='text') {
                const t=prompt("Text:");
                if(t) {
                    activeGroup.posts.push({s:currentUser.name, t});
                    localStorage.setItem('fasil_groups', JSON.stringify(groups));
                    openGroup(activeGroup.id);
                }
            } else alert("Media upload simulation");
        }

        // --- Chat ---
        function handlePrivateChatStart() {
            showView('user-list-view');
            const c = document.getElementById('user-list-container');
            c.innerHTML='';
            document.getElementById('user-list-action-btn').style.display='none';
            users.forEach(u=>{
                if(u.phone===currentUser.phone)return;
                const d=document.createElement('div');
                d.className='user-card';
                d.innerHTML=`<img src="${u.photo}"> ${u.name}`;
                d.onclick=()=>{
                    activeChatUser=u;
                    document.getElementById('chat-partner-name').textContent = "Chat with " + u.name;
                    renderChat();
                    showView('private-chat-room');
                };
                c.appendChild(d);
            });
        }
        function renderChat() {
            const id=[currentUser.phone, activeChatUser.phone].sort().join('_');
            const msgs=privateChats[id]||[];
            document.getElementById('private-chat-messages').innerHTML = msgs.map(m=>
                `<div class="chat-message ${m.s===currentUser.phone?'self':''}">
                    <div class="chat-bubble">${m.t||'[Media]'}</div>
                </div>`
            ).join('');
        }
        function sendPrivateMessage(type, data=null) {
            const t = document.getElementById('chat-input-text').value;
            if(type==='text' && !t) return;
            const id=[currentUser.phone, activeChatUser.phone].sort().join('_');
            if(!privateChats[id]) privateChats[id]=[];
            privateChats[id].push({s:currentUser.phone, t:type==='text'?t:null, d:data, type});
            localStorage.setItem('fasil_chats', JSON.stringify(privateChats));
            document.getElementById('chat-input-text').value='';
            renderChat();
        }
        function triggerChatMedia(t) {
            const i=document.getElementById('chat-file-input');
            i.onchange=e=>{
                const r=new FileReader();
                r.onload=evt=>sendPrivateMessage(t, evt.target.result);
                r.readAsDataURL(e.target.files[0]);
            };
            i.click();
        }

        // --- Business ---
        function updateBalance() { document.getElementById('business-balance-display').textContent = currentUser.balance.toFixed(2)+" USD"; }
        function handleDeposit() {
            if(parseFloat(document.getElementById('deposit-amount').value) >= 100) {
                currentUser.balance += 10; // Demo
                localStorage.setItem('fasil_user', JSON.stringify(currentUser));
                closeModalAlert("áŒˆáŠ•á‹˜á‰¥ áŒˆá‰¢ áˆ†áŠ—áˆ", "success");
                showView('business-dashboard');
            } else closeModalAlert("á‰¢á‹«áŠ•áˆµ 100 á‰¥áˆ­", "error");
        }
        function toggleReceiverInput() {
            const m = document.getElementById('withdraw-method').value;
            const i = document.getElementById('withdraw-receiver');
            if(m) { i.style.display='block'; i.placeholder = m==='CBE'?'1000... (13 Digits)':'Phone/Email'; }
        }
        function initiateWithdraw() {
            const amt = parseFloat(document.getElementById('withdraw-amount').value);
            const m = document.getElementById('withdraw-method').value;
            const r = document.getElementById('withdraw-receiver').value;
            if(!amt || !m || !r) return closeModalAlert("áˆ˜áˆ¨áŒƒ áŠ áˆŸáˆ‹", "error");
            if(m==='CBE' && (!r.startsWith('1000') || r.length!==13)) return closeModalAlert("CBE á‰áŒ¥áˆ­ áˆµáˆ…á‰°á‰µ", "error");
            document.getElementById('password-modal').style.display='flex';
        }
        function confirmWithdrawWithPassword() {
            if(document.getElementById('modal-password-input').value === currentUser.password) {
                currentUser.balance -= parseFloat(document.getElementById('withdraw-amount').value);
                localStorage.setItem('fasil_user', JSON.stringify(currentUser));
                document.getElementById('password-modal').style.display='none';
                closeModalAlert("á‰°áˆ³áŠ­á‰·áˆ", "success");
                showView('business-dashboard');
            } else alert("á“áˆµá‹ˆáˆ­á‹µ áˆµáˆ…á‰°á‰µ");
        }

        // --- Misc ---
        function handleAdminFeedback(t) {
            if(t==='text') prompt("Feedback:");
            else { 
                const i=document.getElementById('feedback-media-input');
                if(t==='video') i.setAttribute('capture','camcorder'); else i.removeAttribute('capture');
                i.click();
            }
        }
        
        // Init
        document.getElementById('loading-overlay').style.display='none';
        if(currentUser) showView('dashboard-view');
    </script>
</body>
</html>
