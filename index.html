<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·çã·à≤·àç ·ãå·â• ·ä†·çï - Fasil Web App (Firebase Online)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- ALL ORIGINAL CSS REMAINS THE SAME --- */
        /* Your complete original CSS code here - unchanged */
    </style>
</head>
<body>

    <!-- ALL ORIGINAL HTML REMAINS THE SAME -->
    <!-- Your complete original HTML structure here - unchanged -->

    <!-- ONLY ADDING THESE NEW MODALS AT THE END OF MODALS SECTION -->
    
    <!-- New Modals for the requested features -->
    <div class="modal-overlay" id="profile-options-modal">
        <div class="modal-box">
            <h3>Profile Options</h3>
            <button class="btn-blue" onclick="changeLoginPassword()">Change Login Password</button>
            <button class="btn-red" onclick="confirmLogout()">Logout</button>
            <button class="btn-gray" onclick="closeModalById('profile-options-modal')">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="confirm-logout-modal">
        <div class="modal-box">
            <h3>Confirm Logout</h3>
            <p>Are you sure you want to logout?</p>
            <button class="btn-red" onclick="performLogout()">Yes, Logout</button>
            <button class="btn-blue" onclick="closeModalById('confirm-logout-modal')">Cancel</button>
        </div>
    </div>

    <div class="modal-overlay" id="total-users-modal">
        <div class="modal-box">
            <h3>Total Registered Users</h3>
            <div id="total-users-display" style="font-size: 48px; font-weight: bold; color: #007bff;">0</div>
            <button class="btn-red" onclick="closeModalById('total-users-modal')">Close</button>
        </div>
    </div>

    <div class="modal-overlay" id="your-posts-modal">
        <div class="modal-box">
            <h3>Your Posts & Engagement</h3>
            <div id="your-posts-container"></div>
            <button class="btn-red" onclick="closeModalById('your-posts-modal')">Close</button>
        </div>
    </div>

    <script>
        // --- ORIGINAL DATA AND SETUP REMAINS ---
        let user = JSON.parse(localStorage.getItem('fg_user')) || null;
        let users = JSON.parse(localStorage.getItem('fg_users')) || [];
        let posts = JSON.parse(localStorage.getItem('fg_posts')) || [];
        // ... all other original data variables

        // --- ADD THESE NEW VARIABLES ---
        let blockedUsers = JSON.parse(localStorage.getItem('fg_blocked_users')) || [];
        let userStatus = JSON.parse(localStorage.getItem('fg_user_status')) || {};
        let activeSessions = JSON.parse(localStorage.getItem('fg_active_sessions')) || {};

        // --- MODIFIED FUNCTIONS ---

        // 1. MODIFIED: FWA Images with correct names
        function showFWAImage(amount) {
            const imageMap = {
                1: 'image_fwa_1note.jpg',
                5: 'image_fwa_5note.jpg',
                10: 'image_fwa_10note.jpg',
                50: 'image_fwa_50note.jpg',
                100: 'image_fwa_100note.jpg',
                200: 'image_fwa_200note.jpg',
                500: 'image_fwa_500note.jpg',
                1000: 'image_fwa_1000note.jpg'
            };
            
            const imgName = imageMap[amount];
            // ... rest of original function
        }

        // 2. MODIFIED: Balance system to actually count
        function upBal() {
            if (!user) return;
            
            // Update display
            document.getElementById('bal-usd').innerText = (user.balUSD || 0).toFixed(2);
            document.getElementById('bal-gbp').innerText = (user.balGBP || 0).toFixed(2);
            document.getElementById('bal-eur').innerText = (user.balEUR || 0).toFixed(2);
            document.getElementById('bal-etb').innerText = (user.balETB || 0).toFixed(2);
            document.getElementById('bal-fwa').innerText = (user.balFWA || 0).toFixed(2);
            
            // Calculate totals correctly
            const totUSD = (user.balUSD || 0) + 
                          ((user.balGBP || 0) * 1.25) + 
                          ((user.balEUR || 0) * 1.1) + 
                          ((user.balETB || 0) / 120) + 
                          ((user.balFWA || 0) / 120);
            
            const totETB = (user.balETB || 0) + 
                          ((user.balUSD || 0) * 120) + 
                          ((user.balGBP || 0) * 150) + 
                          ((user.balEUR || 0) * 130) + 
                          (user.balFWA || 0);
            
            document.getElementById('bal-total').innerText = totUSD.toFixed(2);
            document.getElementById('bal-total-etb').innerText = totETB.toFixed(2);
        }

        // 3. MODIFIED: Deposit function
        function finalizeDeposit() {
            if(!pendingDeposit) return;
            
            const a = pendingDeposit.amount;
            const c = pendingDeposit.currency;
            
            if(a > 0) {
                // ACTUALLY UPDATE THE BALANCE
                if(c === 'USD') user.balUSD = (user.balUSD || 0) + a;
                else if(c === 'GBP') user.balGBP = (user.balGBP || 0) + a;
                else if(c === 'EUR') user.balEUR = (user.balEUR || 0) + a;
                else if(c === 'FWA') user.balFWA = (user.balFWA || 0) + a;
                else user.balETB = (user.balETB || 0) + a;
                
                localStorage.setItem('fg_user', JSON.stringify(user));
                showAlert(`Deposited ${a} ${c}!`, "success");
                upBal(); // Refresh display
            }
        }

        // 4. MODIFIED: Withdraw function
        function reqWithdraw() {
            const a = parseFloat(document.getElementById('w-amt').value);
            const c = document.getElementById('w-cur').value;
            
            // Check balance
            let balance = 0;
            if(c === 'USD') balance = user.balUSD || 0;
            else if(c === 'GBP') balance = user.balGBP || 0;
            else if(c === 'EUR') balance = user.balEUR || 0;
            else if(c === 'ETB') balance = user.balETB || 0;
            else if(c === 'FWA') balance = user.balFWA || 0;
            
            if(balance < a) {
                return showAlert(`Insufficient ${c} balance`, "error");
            }
            
            pendingAct = () => {
                // ACTUALLY DEDUCT
                if(c === 'USD') user.balUSD -= a;
                else if(c === 'GBP') user.balGBP -= a;
                else if(c === 'EUR') user.balEUR -= a;
                else if(c === 'ETB') user.balETB -= a;
                else if(c === 'FWA') user.balFWA -= a;
                
                localStorage.setItem('fg_user', JSON.stringify(user));
                showAlert(`Withdrew ${a} ${c}`, "success");
                upBal();
            };
            
            document.getElementById('pass-modal').style.display = 'flex';
        }

        // 5. MODIFIED: Profile button asks for password
        function navTab(t) {
            if(t === 'profile') {
                if(!user) return showAlert("Please login first", "error");
                pendingAct = () => {
                    document.getElementById('profile-options-modal').style.display = 'flex';
                };
                document.getElementById('pass-modal').style.display = 'flex';
                return;
            }
            // ... rest of original function
        }

        // 6. NEW: Change login password
        function changeLoginPassword() {
            closeModalById('profile-options-modal');
            const old = prompt("Old password:");
            if(old !== user.password) return showAlert("Wrong password", "error");
            
            const newPass = prompt("New password (min 6 chars):");
            if(!newPass || newPass.length < 6) return showAlert("Invalid password", "error");
            
            const confirm = prompt("Confirm new password:");
            if(newPass !== confirm) return showAlert("Passwords don't match", "error");
            
            user.password = newPass;
            localStorage.setItem('fg_user', JSON.stringify(user));
            
            // Update in users array
            const idx = users.findIndex(u => u.phone === user.phone);
            if(idx !== -1) {
                users[idx].password = newPass;
                localStorage.setItem('fg_users', JSON.stringify(users));
            }
            
            showAlert("Password changed!", "success");
        }

        // 7. NEW: Logout functions
        function confirmLogout() {
            closeModalById('profile-options-modal');
            document.getElementById('confirm-logout-modal').style.display = 'flex';
        }

        function performLogout() {
            // Remove from active sessions
            if(user && activeSessions[user.phone]) {
                delete activeSessions[user.phone];
                localStorage.setItem('fg_active_sessions', JSON.stringify(activeSessions));
            }
            
            user = null;
            localStorage.removeItem('fg_user');
            location.reload();
        }

        // 8. NEW: User live status
        function updateUserStatus(phone, isLive) {
            userStatus[phone] = { isLive, timestamp: Date.now() };
            localStorage.setItem('fg_user_status', JSON.stringify(userStatus));
        }

        function getUserLiveStatus(phone) {
            const status = userStatus[phone];
            if(!status) return false;
            // Consider offline if last update > 5 minutes
            return status.isLive && (Date.now() - status.timestamp < 300000);
        }

        // 9. MODIFIED: User list with live status
        function showUserList(selMode) {
            const c = document.getElementById('ul-cont'); 
            c.innerHTML = '';
            
            users.forEach(u => {
                if(u.phone === user.phone) return;
                
                const isLive = getUserLiveStatus(u.phone);
                const statusBadge = isLive ? 
                    '<span style="color:green; font-size:10px;">‚óè Live</span>' : 
                    '<span style="color:black; font-size:10px;">‚óè Offline</span>';
                
                const isBlocked = blockedUsers.includes(u.phone);
                
                c.innerHTML += `<div class="user-item">
                    <img src="${u.photo || 'lion_image.jpg'}"> 
                    <div>
                        <b>${u.name}</b> ${statusBadge}
                        <div>
                            <button class="btn-tiny btn-blue" onclick="viewChatWith('${u.phone}')">View Chat</button>
                            ${isBlocked ? 
                                `<button class="btn-tiny btn-green" onclick="unblockUser('${u.phone}')">Unblock</button>` :
                                `<button class="btn-tiny btn-red" onclick="blockUser('${u.phone}')">Block</button>`
                            }
                        </div>
                    </div>
                </div>`;
            });
            
            navTo('user-list-sec');
        }

        // 10. NEW: Block/Unblock user
        function blockUser(phone) {
            if(!blockedUsers.includes(phone)) {
                blockedUsers.push(phone);
                localStorage.setItem('fg_blocked_users', JSON.stringify(blockedUsers));
                showAlert("User blocked", "success");
                showUserList(false);
            }
        }

        function unblockUser(phone) {
            blockedUsers = blockedUsers.filter(p => p !== phone);
            localStorage.setItem('fg_blocked_users', JSON.stringify(blockedUsers));
            showAlert("User unblocked", "success");
            showUserList(false);
        }

        // 11. NEW: View chat with user
        function viewChatWith(targetPhone) {
            const chatKey = [user.phone, targetPhone].sort().join('_');
            const messages = chats[chatKey] || [];
            
            if(messages.length === 0) {
                return showAlert("No messages yet", "info");
            }
            
            let chatHTML = '<h4>Chat History</h4>';
            messages.forEach(msg => {
                chatHTML += `<div><b>${msg.u}:</b> ${msg.t}</div>`;
            });
            
            document.getElementById('custom-modal').innerHTML = `
                <div class="modal-box">
                    <h3>Chat with ${targetPhone}</h3>
                    <div style="max-height:300px; overflow-y:auto;">${chatHTML}</div>
                    <button class="btn-blue" onclick="closeModal()">Close</button>
                </div>
            `;
            document.getElementById('custom-modal').style.display = 'flex';
        }

        // 12. MODIFIED: Free services list - add "View Your Own Info"
        function toggleList(t) { 
            const l = document.getElementById('list-' + t); 
            l.style.display = l.style.display === 'none' ? 'block' : 'none'; 
            
            // Add button if it doesn't exist
            if(t === 'free' && !document.querySelector('#btn-own-info')) {
                const ownInfoBtn = document.createElement('button');
                ownInfoBtn.id = 'btn-own-info';
                ownInfoBtn.className = 'btn-green btn-small';
                ownInfoBtn.textContent = '·ã®·ä•·à≠·àµ·ãé·äï ·àò·à®·åÉ ·ã≠·àò·àç·ä®·â±';
                ownInfoBtn.onclick = viewYourOwnInfo;
                l.appendChild(ownInfoBtn);
            }
        }

        // 13. NEW: View your own info
        function viewYourOwnInfo() {
            if(!user) return showAlert("Please login first", "error");
            
            pendingAct = () => {
                const userPosts = posts.filter(p => p.uid === user.phone);
                
                if(userPosts.length === 0) {
                    return showAlert("You have no posts", "info");
                }
                
                let html = '<h4>Your Posts</h4>';
                let totalLikes = 0;
                let totalComments = 0;
                let totalFollows = 0;
                
                userPosts.forEach((post, idx) => {
                    const likes = post.likes || 0;
                    const comments = (post.comments || []).length;
                    const follows = post.follows || 0;
                    
                    totalLikes += likes;
                    totalComments += comments;
                    totalFollows += follows;
                    
                    html += `
                        <div class="post-card">
                            <h5>${post.t}</h5>
                            <p>Type: ${post.type}</p>
                            <div style="display:flex; justify-content:space-around;">
                                <span>üëç ${likes}</span>
                                <span>üí¨ ${comments}</span>
                                <span>üë• ${follows}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `
                    <div style="background:#f0f0f0; padding:10px; margin-top:10px; border-radius:5px;">
                        <h5>Summary</h5>
                        <p>Total Posts: ${userPosts.length}</p>
                        <p>Total Likes: ${totalLikes}</p>
                        <p>Total Comments: ${totalComments}</p>
                        <p>Total Follows: ${totalFollows}</p>
                    </div>
                `;
                
                document.getElementById('your-posts-container').innerHTML = html;
                document.getElementById('your-posts-modal').style.display = 'flex';
            };
            
            document.getElementById('pass-modal').style.display = 'flex';
        }

        // 14. MODIFIED: Admin functions - add Total Users
        function promptAdminAction(action) {
            pendingAdminAction = action;
            document.getElementById('admin-action-modal').style.display = 'flex';
        }

        function runAdminAction() {
            const p = document.getElementById('admin-act-pass').value;
            if(p === adminPass) {
                document.getElementById('admin-action-modal').style.display = 'none';
                
                if(pendingAdminAction === 'totalUsers') {
                    showTotalUsers();
                }
                // ... other actions
            }
        }

        // 15. NEW: Show total users
        function showTotalUsers() {
            const total = users.length;
            document.getElementById('total-users-display').textContent = total;
            document.getElementById('total-users-modal').style.display = 'flex';
            
            // Also show in admin panel
            document.getElementById('admin-dynamic-content').innerHTML = `
                <div style="text-align:center; padding:20px;">
                    <h3>Total Users: ${total}</h3>
                    <p>Registered users count</p>
                </div>
            `;
        }

        // 16. NEW: Helper function
        function closeModalById(id) {
            document.getElementById(id).style.display = 'none';
        }

        // --- INITIALIZE NEW FEATURES ---
        document.addEventListener('DOMContentLoaded', function() {
            // Add Total Users button to admin section
            setTimeout(() => {
                const adminSection = document.getElementById('list-free');
                if(adminSection) {
                    const totalUsersBtn = document.createElement('button');
                    totalUsersBtn.className = 'btn-green btn-small';
                    totalUsersBtn.style.backgroundColor = '#9c27b0';
                    totalUsersBtn.textContent = '·å†·âÖ·àã·àã ·â∞·å†·âÉ·àö·ãé·âΩ';
                    totalUsersBtn.onclick = () => promptAdminAction('totalUsers');
                    adminSection.appendChild(totalUsersBtn);
                }
            }, 1000);
        });

        // --- ALL ORIGINAL FUNCTIONS REMAIN BELOW ---
        // ... rest of your original JavaScript code

    </script>
</body>
</html>
