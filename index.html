<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ፋሲል ዌብ አፕ - Fasil Web App (Firebase Online)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ADDED STYLES FOR NEW FEATURES */
        
        /* User Live Status Indicator */
        .live-status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: bold;
            margin-left: 8px;
            text-transform: uppercase;
        }
        .live-online-badge {
            background-color: #28a745;
            color: white;
            animation: pulse-green 1.5s infinite;
        }
        .live-offline-badge {
            background-color: #333;
            color: white;
        }
        
        /* Chat Management */
        .chat-management {
            display: flex;
            gap: 5px;
            margin-top: 5px;
            justify-content: center;
        }
        .chat-block-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        .chat-unblock-btn {
            background-color: #28a745;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
        }
        
        /* User Stats Display */
        .user-stats-container {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border: 1px solid #dee2e6;
        }
        .user-stat-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }
        .user-stat-label {
            font-weight: bold;
            color: #333;
        }
        .user-stat-value {
            color: #007bff;
            font-weight: bold;
        }
        
        /* Your Posts Display */
        .your-post-item {
            border: 2px solid #007bff;
            background: #e3f2fd;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
        .engagement-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #ccc;
        }
        .engagement-item {
            text-align: center;
        }
        .engagement-count {
            font-weight: bold;
            color: #dc3545;
            font-size: 18px;
        }
        .engagement-label {
            font-size: 12px;
            color: #666;
        }
        
        /* Profile Password Modal */
        .profile-options-modal {
            background: white;
            padding: 20px;
            border-radius: 10px;
            width: 85%;
            max-width: 400px;
            text-align: center;
        }
        .profile-option-btn {
            width: 100%;
            margin: 8px 0;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            cursor: pointer;
            display: block;
        }
        
        /* Existing CSS remains unchanged */
        /* ... all existing CSS from the original code ... */
    </style>
</head>
<body>

    <!-- MODALS FOR NEW FEATURES -->

    <!-- Profile Options Modal -->
    <div class="modal-overlay" id="profile-options-modal">
        <div class="profile-options-modal">
            <h3>Profile Options</h3>
            <button class="profile-option-btn" style="background:#007bff; color:white;" onclick="changeLoginPassword()">Change Login Password</button>
            <button class="profile-option-btn" style="background:#dc3545; color:white;" onclick="confirmLogout()">Logout</button>
            <button class="profile-option-btn" style="background:#6c757d; color:white;" onclick="document.getElementById('profile-options-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <!-- Confirm Logout Modal -->
    <div class="modal-overlay" id="confirm-logout-modal">
        <div class="modal-box">
            <h3>Confirm Logout</h3>
            <p>Are you sure you want to logout? You will need to login again to access your account.</p>
            <button class="btn-red" onclick="performLogout()">Yes, Logout</button>
            <button class="btn-blue" onclick="document.getElementById('confirm-logout-modal').style.display='none'">Cancel</button>
        </div>
    </div>

    <!-- Total Users Modal -->
    <div class="modal-overlay" id="total-users-modal">
        <div class="modal-box">
            <h3>Total Registered Users</h3>
            <div id="total-users-display" style="font-size: 48px; font-weight: bold; color: #007bff; margin: 20px 0;"></div>
            <p>Total number of users registered on Fasil Web App</p>
            <button class="btn-red" onclick="document.getElementById('total-users-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- Your Posts Modal -->
    <div class="modal-overlay" id="your-posts-modal">
        <div class="modal-box" style="max-width: 90%;">
            <h3>Your Posts & Engagement</h3>
            <div id="your-posts-container" style="max-height: 400px; overflow-y: auto; margin: 15px 0;"></div>
            <button class="btn-red" onclick="document.getElementById('your-posts-modal').style.display='none'">Close</button>
        </div>
    </div>

    <!-- Rest of your HTML remains unchanged until the script section -->
    <!-- ... all existing HTML from the original code ... -->

    <script>
        // --- NEW DATA STRUCTURES ---
        let blockedUsers = JSON.parse(localStorage.getItem('fg_blocked_users')) || [];
        let userStatus = JSON.parse(localStorage.getItem('fg_user_status')) || {};
        let activeSessions = JSON.parse(localStorage.getItem('fg_active_sessions')) || {};

        // --- NEW FUNCTIONS ---

        // 1. UPDATED FWA Notes Images with specific filenames
        function showFWAImage(amount) {
            // Hide buttons
            document.getElementById('fwa-buttons-container').style.display = 'none';
            
            // Show image container
            const imageContainer = document.getElementById('fwa-image-display');
            imageContainer.style.display = 'block';
            
            // Show back button
            document.querySelector('.fwa-back-btn').style.display = 'block';
            
            // Specific image filenames as requested
            const imageMap = {
                1: 'image_fwa_1note.jpg',
                5: 'image_fwa_5note.jpg',
                10: 'image_fwa_10note.jpg',
                50: 'image_fwa_50note.jpg',
                100: 'image_fwa_100note.jpg',
                200: 'image_fwa_200note.jpg',
                500: 'image_fwa_500note.jpg',
                1000: 'image_fwa_1000note.jpg'
            };
            
            const imgName = imageMap[amount] || `image_fwa_${amount}note.jpg`;
            imageContainer.innerHTML = `
                <h4>${amount} FWA Note Design</h4>
                <img src="${imgName}" alt="${amount} FWA Note" class="fwa-note-image" onerror="this.src='lion_image.jpg'">
                <p style="font-size: 14px; color: #333; margin-top: 10px;">
                    Official ${amount} FWA Currency Note Design
                </p>
                <p style="font-size: 12px; color: #666; margin-top: 5px;">
                    File: ${imgName}
                </p>
            `;
        }

        // 2. UPDATED Balance Functions - ACTUAL COUNTING
        function upBal() {
            if (!user) return;
            
            // Ensure all balance fields exist
            user.balUSD = user.balUSD || 0;
            user.balGBP = user.balGBP || 0;
            user.balEUR = user.balEUR || 0;
            user.balETB = user.balETB || 0;
            user.balFWA = user.balFWA || 0;
            
            // Update displayed balances with actual values
            document.getElementById('bal-usd').innerText = user.balUSD.toFixed(2);
            document.getElementById('bal-gbp').innerText = user.balGBP.toFixed(2);
            document.getElementById('bal-eur').innerText = user.balEUR.toFixed(2);
            document.getElementById('bal-etb').innerText = user.balETB.toFixed(2);
            document.getElementById('bal-fwa').innerText = user.balFWA.toFixed(2);
            
            // Calculate totals using current rates
            const totUSD = user.balUSD + 
                          (user.balGBP * 1.25) + 
                          (user.balEUR * 1.1) + 
                          (user.balETB / RATES.USD) + 
                          (user.balFWA / RATES.USD);
            
            const totETB = user.balETB + 
                          (user.balUSD * RATES.USD) + 
                          (user.balGBP * RATES.GBP) + 
                          (user.balEUR * RATES.EUR) + 
                          user.balFWA;
            
            const totFWA = user.balFWA + 
                          (user.balUSD * RATES.USD) + 
                          (user.balGBP * RATES.GBP) + 
                          (user.balEUR * RATES.EUR) + 
                          user.balETB;
            
            document.getElementById('bal-total').innerText = totUSD.toFixed(2);
            document.getElementById('bal-total-etb').innerText = totETB.toFixed(2);
            document.getElementById('bal-total-fwa').innerText = totFWA.toFixed(2);
            
            // Save updated user data
            localStorage.setItem('fg_user', JSON.stringify(user));
            
            // Update Firebase if available
            if(window.firebaseTools && user.id) {
                // Update user document in Firebase
                console.log("Balance updated locally, Firebase update needed");
            }
        }

        // 3. UPDATED Deposit Function with actual balance update
        function finalizeDeposit() {
            if(!pendingDeposit) return;
            
            const a = pendingDeposit.amount;
            const c = pendingDeposit.currency;
            
            if(a > 0) {
                // Update user balance based on currency
                if(c === 'USD') {
                    user.balUSD = (user.balUSD || 0) + a;
                    console.log(`Deposited ${a} USD, new balance: ${user.balUSD}`);
                }
                else if(c === 'GBP') {
                    user.balGBP = (user.balGBP || 0) + a;
                }
                else if(c === 'EUR') {
                    user.balEUR = (user.balEUR || 0) + a;
                }
                else if(c === 'FWA') {
                    user.balFWA = (user.balFWA || 0) + a;
                }
                else { // ETB
                    user.balETB = (user.balETB || 0) + a;
                }
                
                // Update local storage
                localStorage.setItem('fg_user', JSON.stringify(user));
                
                // Update Firebase if available
                if(window.firebaseTools && window.firebaseTools.updateUserBalance && user.id) {
                    window.firebaseTools.updateUserBalance(user.id, c, a)
                        .then(result => {
                            if(result.success) {
                                console.log(`Firebase balance updated for ${c}`);
                            }
                        });
                }
                
                showAlert(`Successfully deposited ${a} ${c}!`, "success"); 
                upBal(); // Refresh display
                
                // Reset deposit form
                document.getElementById('dep-step-1').style.display = 'block'; 
                document.getElementById('dep-step-2').style.display = 'none'; 
                document.getElementById('dep-amt').value = '';
                pendingDeposit = null;
                
                navTo('business-sec');
            } else {
                showAlert("Please enter a valid amount", "error");
            }
        }

        // 4. UPDATED Withdrawal Function with actual balance update
        function reqWithdraw() {
            const m = document.getElementById('w-method').value; 
            const d = document.getElementById('w-dest').value;
            const a = parseFloat(document.getElementById('w-amt').value);
            const c = document.getElementById('w-cur').value;
            
            if(!a || a <= 0) return showAlert("Please enter amount", "error");
            
            // Check if user has sufficient balance
            let currentBalance = 0;
            let hasBalance = false;
            
            if(c === 'USD') {
                currentBalance = user.balUSD || 0;
                hasBalance = currentBalance >= a;
            } else if(c === 'GBP') {
                currentBalance = user.balGBP || 0;
                hasBalance = currentBalance >= a;
            } else if(c === 'EUR') {
                currentBalance = user.balEUR || 0;
                hasBalance = currentBalance >= a;
            } else if(c === 'ETB') {
                currentBalance = user.balETB || 0;
                hasBalance = currentBalance >= a;
            } else if(c === 'FWA') {
                currentBalance = user.balFWA || 0;
                hasBalance = currentBalance >= a;
            }
            
            if(!hasBalance) {
                return showAlert(`Insufficient ${c} balance. You have ${currentBalance.toFixed(2)} ${c}`, "error");
            }
            
            // Validate destination based on method
            if(m === 'Telebirr' && !/^09\d{8}$/.test(d)) {
                return showAlert("Telebirr must be 09... (10 digits)", "error");
            }
            if(m === 'PayPal' && !d.includes('@')) {
                return showAlert("Valid email required for PayPal", "error");
            }
            if(m === 'CBE' && !d.match(/^\d{13}$/)) {
                return showAlert("CBE account must be 13 digits", "error");
            }
            if(m === 'FWA' && !d) {
                return showAlert("FWA Account required", "error");
            }

            document.getElementById('pass-modal').style.display = 'flex';
            pendingAct = () => {
                // Deduct from balance
                if(c === 'USD') {
                    user.balUSD = (user.balUSD || 0) - a;
                } else if(c === 'GBP') {
                    user.balGBP = (user.balGBP || 0) - a;
                } else if(c === 'EUR') {
                    user.balEUR = (user.balEUR || 0) - a;
                } else if(c === 'ETB') {
                    user.balETB = (user.balETB || 0) - a;
                } else if(c === 'FWA') {
                    user.balFWA = (user.balFWA || 0) - a;
                }
                
                // Update local storage
                localStorage.setItem('fg_user', JSON.stringify(user));
                
                // Update Firebase if available
                if(window.firebaseTools && window.firebaseTools.updateUserBalance && user.id) {
                    window.firebaseTools.updateUserBalance(user.id, c, -a);
                }
                
                showAlert(`Successfully withdrew ${a} ${c} to ${m} (${d})`, "success"); 
                upBal(); // Refresh display
                
                // Clear form
                document.getElementById('w-amt').value = '';
                document.getElementById('w-dest').value = '';
                
                navTo('business-sec');
            };
        }

        // 5. UPDATED International Payment with balance update
        function triggerIntlPay(item) {
            const amount = prompt(`Enter amount for ${item} purchase (USD):`, "10");
            if(!amount || isNaN(amount) || parseFloat(amount) <= 0) {
                return showAlert("Invalid amount", "error");
            }
            
            const amt = parseFloat(amount);
            
            // Check USD balance
            if((user.balUSD || 0) < amt) {
                return showAlert(`Insufficient USD balance. You have ${(user.balUSD || 0).toFixed(2)} USD`, "error");
            }
            
            pendingAct = () => {
                // Deduct from USD balance
                user.balUSD = (user.balUSD || 0) - amt;
                localStorage.setItem('fg_user', JSON.stringify(user));
                
                // Update Firebase if available
                if(window.firebaseTools && window.firebaseTools.updateUserBalance && user.id) {
                    window.firebaseTools.updateUserBalance(user.id, 'USD', -amt);
                }
                
                showAlert(`Successfully purchased ${item} for ${amt} USD`, "success");
                upBal(); // Refresh display
                promptUpload('intl');
            };
            
            document.getElementById('pass-modal').style.display = 'flex';
        }

        // 6. UPDATED Profile Button with Password Verification
        function navTab(t) {
            if(t === 'home') {
                if(!hasAgreed) return showAlert(lang === 'am' ? 'እባክዎ መጀመሪያ ፖሊሲውን ይስማሙ' : 'Please agree to policy', "error");
                if(!user) return showAlert(lang === 'am' ? 'እባክዎ ይግቡ/ይመዝገቡ' : 'Please Login/Register', "error");
                showView('view-home');
                return;
            }

            if(!hasAgreed) return showAlert(lang === 'am' ? 'እባክዎ መጀመሪያ ፖሊሲውን ይስማሙ' : 'Please agree to policy', "error");
            if(!user) return showAlert(lang === 'am' ? 'እባክዎ ይግቡ/ይመዝገቡ' : 'Please Login/Register', "error");
            
            document.querySelectorAll('.section').forEach(e => e.classList.remove('show'));
            
            if(t === 'live') openRealLiveStream();
            else if(t === 'profile') {
                // Ask for password first
                pendingAct = () => {
                    showView('view-profile');
                    document.getElementById('prof-phone').innerText = user.phone;
                    document.getElementById('prof-name-edit').value = user.name || '';
                };
                document.getElementById('pass-modal').style.display = 'flex';
            }
        }

        // 7. NEW: Profile Options Functions
        function showProfileOptions() {
            document.getElementById('profile-options-modal').style.display = 'flex';
        }

        function changeLoginPassword() {
            document.getElementById('profile-options-modal').style.display = 'none';
            
            const oldPass = prompt("Enter current password:");
            if(!oldPass) return;
            
            if(oldPass !== user.password) {
                return showAlert("Current password is incorrect", "error");
            }
            
            const newPass = prompt("Enter new password (min 6 characters):");
            if(!newPass || newPass.length < 6) {
                return showAlert("Password must be at least 6 characters", "error");
            }
            
            const confirmPass = prompt("Confirm new password:");
            if(newPass !== confirmPass) {
                return showAlert("Passwords do not match", "error");
            }
            
            // Update password
            user.password = newPass;
            localStorage.setItem('fg_user', JSON.stringify(user));
            
            // Update all users array
            const userIndex = users.findIndex(u => u.phone === user.phone);
            if(userIndex !== -1) {
                users[userIndex].password = newPass;
                localStorage.setItem('fg_users', JSON.stringify(users));
            }
            
            showAlert("Password changed successfully!", "success");
        }

        function confirmLogout() {
            document.getElementById('profile-options-modal').style.display = 'none';
            document.getElementById('confirm-logout-modal').style.display = 'flex';
        }

        function performLogout() {
            // Remove from active sessions
            if(activeSessions[user.phone]) {
                delete activeSessions[user.phone];
                localStorage.setItem('fg_active_sessions', JSON.stringify(activeSessions));
            }
            
            // Clear user data
            user = null;
            localStorage.removeItem('fg_user');
            
            // Stop live stream if active
            if (liveStreamActive) {
                stopRealLiveStream();
            }
            
            // Unsubscribe from Firebase
            if(firebaseUnsubscribe) {
                firebaseUnsubscribe();
            }
            
            // Hide logout modal
            document.getElementById('confirm-logout-modal').style.display = 'none';
            
            // Reload to login screen
            location.reload();
        }

        // 8. NEW: User Live Status Management
        function updateUserStatus(phone, isLive) {
            userStatus[phone] = {
                isLive: isLive,
                lastUpdate: Date.now()
            };
            localStorage.setItem('fg_user_status', JSON.stringify(userStatus));
        }

        function getUserStatus(phone) {
            const status = userStatus[phone];
            if(!status) return { isLive: false, lastUpdate: 0 };
            
            // Consider user offline if no update in last 5 minutes
            const isOnline = status.isLive && (Date.now() - status.lastUpdate < 5 * 60 * 1000);
            return {
                isLive: isOnline,
                lastUpdate: status.lastUpdate
            };
        }

        // 9. UPDATED User List with Live Status
        function showUserList(selMode) {
            const c = document.getElementById('ul-cont'); 
            c.innerHTML = '';
            
            users.forEach(u => {
                if(u.phone === user.phone) return;
                
                const userStatus = getUserStatus(u.phone);
                const statusBadge = userStatus.isLive ? 
                    '<span class="live-status-badge live-online-badge">Live</span>' : 
                    '<span class="live-status-badge live-offline-badge">Offline</span>';
                
                const isBlocked = blockedUsers.includes(u.phone);
                const blockBtn = isBlocked ? 
                    `<button class="chat-unblock-btn" onclick="toggleBlockUser('${u.phone}', false)">Unblock</button>` :
                    `<button class="chat-block-btn" onclick="toggleBlockUser('${u.phone}', true)">Block</button>`;
                
                c.innerHTML += `<div class="user-item" onclick="${selMode ? 'togBlue(this)' : `openChat('${u.phone}')`}">
                    <img src="${u.photo || 'lion_image.jpg'}"> 
                    <div style="flex:1;">
                        <b>${u.name}</b> ${statusBadge}
                        <div class="chat-management">
                            <button class="btn-blue btn-tiny" onclick="viewChatHistory('${u.phone}')">View Chat</button>
                            ${blockBtn}
                        </div>
                    </div>
                </div>`;
            });
            
            document.getElementById('btn-grp-done').style.display = selMode ? 'block' : 'none';
            navTo('user-list-sec');
        }

        // 10. NEW: Block/Unblock User
        function toggleBlockUser(targetPhone, block) {
            if(block) {
                if(!blockedUsers.includes(targetPhone)) {
                    blockedUsers.push(targetPhone);
                    showAlert(`Blocked messages from ${targetPhone}`, "success");
                }
            } else {
                blockedUsers = blockedUsers.filter(phone => phone !== targetPhone);
                showAlert(`Unblocked messages from ${targetPhone}`, "success");
            }
            
            localStorage.setItem('fg_blocked_users', JSON.stringify(blockedUsers));
            
            // Refresh user list
            showUserList(false);
        }

        // 11. NEW: View Chat History
        function viewChatHistory(targetPhone) {
            const chatKey = [user.phone, targetPhone].sort().join('_');
            const messages = chats[chatKey] || [];
            
            if(messages.length === 0) {
                return showAlert("No chat history with this user", "info");
            }
            
            const chatWindow = window.open('', '_blank', 'width=400,height=600');
            chatWindow.document.write(`
                <html>
                <head>
                    <title>Chat with ${targetPhone}</title>
                    <style>
                        body { font-family: Arial; padding: 10px; }
                        .message { margin: 10px 0; padding: 10px; border-radius: 5px; }
                        .sent { background: #007bff; color: white; text-align: right; }
                        .received { background: #f0f0f0; color: black; }
                        .message-info { font-size: 12px; color: #666; }
                    </style>
                </head>
                <body>
                    <h3>Chat History</h3>
                    <div id="chat-container"></div>
                    <hr>
                    <input type="text" id="new-message" placeholder="Type message..." style="width: 70%;">
                    <button onclick="sendMessage()">Send</button>
                    <button onclick="window.close()">Close</button>
                    
                    <script>
                        const messages = ${JSON.stringify(messages)};
                        const currentUser = '${user.phone}';
                        const targetUser = '${targetPhone}';
                        
                        function displayMessages() {
                            const container = document.getElementById('chat-container');
                            container.innerHTML = messages.map(msg => \`
                                <div class="message \${msg.u === '${user.name}' ? 'sent' : 'received'}">
                                    <div class="message-info">\${msg.u} • \${new Date().toLocaleTimeString()}</div>
                                    \${msg.t}
                                </div>
                            \`).join('');
                        }
                        
                        function sendMessage() {
                            const input = document.getElementById('new-message');
                            const text = input.value.trim();
                            if(text) {
                                messages.push({
                                    u: '${user.name}',
                                    t: text,
                                    type: 'text',
                                    time: new Date().toISOString()
                                });
                                input.value = '';
                                displayMessages();
                                
                                // Save to parent window
                                window.opener.saveChatMessage('${targetPhone}', text);
                            }
                        }
                        
                        displayMessages();
                    <\/script>
                </body>
                </html>
            `);
        }

        // 12. NEW: Save Chat Message
        function saveChatMessage(targetPhone, message) {
            const chatKey = [user.phone, targetPhone].sort().join('_');
            if(!chats[chatKey]) chats[chatKey] = [];
            
            chats[chatKey].push({
                u: user.name,
                t: message,
                type: 'text',
                time: new Date().toISOString()
            });
            
            localStorage.setItem('fg_chats', JSON.stringify(chats));
        }

        // 13. UPDATED Free Service List with "View Your Own Info"
        function toggleList(t) { 
            const l = document.getElementById('list-' + t); 
            l.style.display = l.style.display === 'none' ? 'block' : 'none'; 
            
            // Add "View Your Own Info" button if it doesn't exist
            if(t === 'free' && !document.getElementById('btn-own-info')) {
                const freeList = document.getElementById('list-free');
                const ownInfoBtn = document.createElement('button');
                ownInfoBtn.id = 'btn-own-info';
                ownInfoBtn.className = 'btn-green btn-small';
                ownInfoBtn.innerText = lang === 'am' ? 'የእርስዎን መረጃ ይመልከቱ' : 'View Your Own Info';
                ownInfoBtn.onclick = () => viewYourOwnInfo();
                freeList.appendChild(ownInfoBtn);
            }
        }

        // 14. NEW: View Your Own Info
        function viewYourOwnInfo() {
            if(!user) return showAlert("Please login first", "error");
            
            pendingAct = () => {
                // Get user's posts
                const userPosts = posts.filter(p => p.uid === user.phone && !p.isHidden);
                
                if(userPosts.length === 0) {
                    return showAlert("You haven't created any posts yet", "info");
                }
                
                let html = '<h4>Your Posts & Engagement</h4>';
                
                let totalLikes = 0;
                let totalComments = 0;
                let totalFollows = 0;
                
                userPosts.forEach((post, index) => {
                    // Count engagement
                    const likes = post.likes || 0;
                    const comments = (post.comments || []).length;
                    const follows = post.follows || 0;
                    
                    totalLikes += likes;
                    totalComments += comments;
                    totalFollows += follows;
                    
                    // Display post
                    html += `
                        <div class="your-post-item">
                            <h5>${index + 1}. ${post.t}</h5>
                            <p>Type: ${post.type}</p>
                            <p>${post.c || ''}</p>
                            <div class="engagement-stats">
                                <div class="engagement-item">
                                    <div class="engagement-count">${likes}</div>
                                    <div class="engagement-label">Likes</div>
                                </div>
                                <div class="engagement-item">
                                    <div class="engagement-count">${comments}</div>
                                    <div class="engagement-label">Comments</div>
                                </div>
                                <div class="engagement-item">
                                    <div class="engagement-count">${follows}</div>
                                    <div class="engagement-label">Follows</div>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                // Add totals
                html += `
                    <div class="user-stats-container">
                        <h4>Total Engagement Summary</h4>
                        <div class="user-stat-item">
                            <span class="user-stat-label">Total Posts:</span>
                            <span class="user-stat-value">${userPosts.length}</span>
                        </div>
                        <div class="user-stat-item">
                            <span class="user-stat-label">Total Likes Received:</span>
                            <span class="user-stat-value">${totalLikes}</span>
                        </div>
                        <div class="user-stat-item">
                            <span class="user-stat-label">Total Comments Received:</span>
                            <span class="user-stat-value">${totalComments}</span>
                        </div>
                        <div class="user-stat-item">
                            <span class="user-stat-label">Total Follows Received:</span>
                            <span class="user-stat-value">${totalFollows}</span>
                        </div>
                        <div class="user-stat-item">
                            <span class="user-stat-label">Average Engagement per Post:</span>
                            <span class="user-stat-value">${((totalLikes + totalComments + totalFollows) / userPosts.length).toFixed(1)}</span>
                        </div>
                    </div>
                `;
                
                document.getElementById('your-posts-container').innerHTML = html;
                document.getElementById('your-posts-modal').style.display = 'flex';
            };
            
            document.getElementById('pass-modal').style.display = 'flex';
        }

        // 15. UPDATED Admin Functions with Total Users
        function promptAdminAction(action) {
            pendingAdminAction = action;
            
            if(action === 'totalUsers') {
                // Directly show total users after password verification
                document.getElementById('admin-action-modal').style.display = 'flex';
            } else {
                document.getElementById('admin-action-modal').style.display = 'flex';
            }
        }

        function runAdminAction() {
            const p = document.getElementById('admin-act-pass').value;
            if(p === adminPass) {
                document.getElementById('admin-action-modal').style.display = 'none';
                document.getElementById('admin-act-pass').value = '';
                
                if(pendingAdminAction === 'changePass') {
                    document.getElementById('admin-chg-modal').style.display = 'block';
                } else if(pendingAdminAction === 'userStats') {
                    showUserStats();
                } else if(pendingAdminAction === 'premPay') {
                    document.getElementById('adm-prem-modal').style.display = 'block';
                } else if(pendingAdminAction === 'viewRep') {
                    renderReports();
                } else if(pendingAdminAction === 'totalUsers') {
                    showTotalUsers();
                }
            } else {
                alert("Wrong Admin Code");
            }
        }

        // 16. NEW: Show Total Users
        function showTotalUsers() {
            const totalUsers = users.length;
            const activeNow = Object.keys(activeSessions).length;
            
            document.getElementById('total-users-display').innerHTML = totalUsers;
            document.getElementById('total-users-modal').style.display = 'flex';
            
            // Also show in admin panel
            document.getElementById('admin-dynamic-content').innerHTML = `
                <div class="user-stats-container">
                    <h4>User Statistics</h4>
                    <div class="user-stat-item">
                        <span class="user-stat-label">Total Registered Users:</span>
                        <span class="user-stat-value">${totalUsers}</span>
                    </div>
                    <div class="user-stat-item">
                        <span class="user-stat-label">Currently Active:</span>
                        <span class="user-stat-value">${activeNow}</span>
                    </div>
                    <div class="user-stat-item">
                        <span class="user-stat-label">Users with Posts:</span>
                        <span class="user-stat-value">${new Set(posts.map(p => p.uid)).size}</span>
                    </div>
                    <div class="user-stat-item">
                        <span class="user-stat-label">Total Posts:</span>
                        <span class="user-stat-value">${posts.length}</span>
                    </div>
                </div>
            `;
        }

        // 17. UPDATED Dashboard with new admin button
        // Add this button to the free services list in your HTML or create dynamically
        function addTotalUsersButton() {
            const adminRepBtn = document.getElementById('btn-admin-rep');
            if(adminRepBtn) {
                // Create and insert new button
                const totalUsersBtn = document.createElement('button');
                totalUsersBtn.className = 'btn-green btn-small';
                totalUsersBtn.style.backgroundColor = '#9c27b0';
                totalUsersBtn.innerText = lang === 'am' ? 'ጠቅላላ ተጠቃሚዎች' : 'Total Users';
                totalUsersBtn.onclick = () => promptAdminAction('totalUsers');
                adminRepBtn.parentNode.insertBefore(totalUsersBtn, adminRepBtn.nextSibling);
            }
        }

        // 18. Initialize Active Sessions
        function initActiveSession() {
            if(user) {
                activeSessions[user.phone] = {
                    loginTime: Date.now(),
                    lastActivity: Date.now(),
                    isLive: false
                };
                localStorage.setItem('fg_active_sessions', JSON.stringify(activeSessions));
                
                // Mark user as online
                updateUserStatus(user.phone, false);
            }
        }

        // 19. Update session activity
        function updateSessionActivity() {
            if(user && activeSessions[user.phone]) {
                activeSessions[user.phone].lastActivity = Date.now();
                localStorage.setItem('fg_active_sessions', JSON.stringify(activeSessions));
            }
        }

        // 20. Update live status when starting/stopping live stream
        async function startRealLiveStream() {
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ 
                        video: true, 
                        audio: true 
                    });
                    
                    liveStream = stream;
                    liveStreamActive = true;
                    
                    // Update user status to live
                    if(user) {
                        updateUserStatus(user.phone, true);
                        if(activeSessions[user.phone]) {
                            activeSessions[user.phone].isLive = true;
                            localStorage.setItem('fg_active_sessions', JSON.stringify(activeSessions));
                        }
                    }
                    
                    const videoElement = document.getElementById('live-video-element');
                    videoElement.srcObject = stream;
                    
                    // ... rest of existing code ...
                    
                } catch (error) {
                    console.error("Error accessing camera:", error);
                    showAlert("Could not access camera. Please check permissions.", "error");
                }
            } else {
                showAlert("Your device does not support live streaming", "error");
            }
        }
        
        async function stopRealLiveStream() {
            if (liveStream) {
                liveStream.getTracks().forEach(track => track.stop());
                liveStream = null;
            }
            
            liveStreamActive = false;
            
            // Update user status to offline
            if(user) {
                updateUserStatus(user.phone, false);
                if(activeSessions[user.phone]) {
                    activeSessions[user.phone].isLive = false;
                    localStorage.setItem('fg_active_sessions', JSON.stringify(activeSessions));
                }
            }
            
            // ... rest of existing code ...
        }

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize active session
            initActiveSession();
            
            // Add activity tracker
            document.addEventListener('click', updateSessionActivity);
            document.addEventListener('keypress', updateSessionActivity);
            
            // Add total users button to admin section
            setTimeout(() => {
                addTotalUsersButton();
                
                // Update balances on load
                if(user) {
                    upBal();
                }
            }, 1000);
            
            // Clean up old sessions (older than 30 minutes)
            const now = Date.now();
            for(const phone in activeSessions) {
                if(now - activeSessions[phone].lastActivity > 30 * 60 * 1000) {
                    delete activeSessions[phone];
                    updateUserStatus(phone, false);
                }
            }
            localStorage.setItem('fg_active_sessions', JSON.stringify(activeSessions));
            
            // Load existing code
            setTimeout(() => {
                loadFirebaseData();
            }, 2000);
        });

        // Keep all existing functions that aren't modified
        // ... rest of your existing JavaScript code ...
    </script>
</body>
</html>
