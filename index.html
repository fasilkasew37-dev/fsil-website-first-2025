<script>
    let currentSubscription = 'free';
    let selectedPlan = null;

    const PLANS = {
        'daily': { name: 'á‹•áˆˆá‰³á‹Š', price: '5 á‰¥áˆ­' },
        'weekly': { name: 'áˆ³áˆáŠ•á‰³á‹Š', price: '25 á‰¥áˆ­' },
        'monthly': { name: 'á‹ˆáˆ­áˆƒá‹Š', price: '30 á‰¥áˆ­' },
        'yearly': { name: 'á‹“áˆ˜á‰³á‹Š', price: '100 á‰¥áˆ­' }
    };

    // Local StorageáŠ• á‰ áˆ˜áŒ á‰€áˆ á‹¨áˆá‹áŒˆá‰£ áˆ˜áˆ¨áŒƒáŠ• áˆ›á‰†á‹¨á‰µ
    function getRegisteredUser() {
        const user = localStorage.getItem('fasil_app_user');
        return user ? JSON.parse(user) : null;
    }

    // áŠ á‹²áˆµ á‰°áŒ á‰ƒáˆš á‹­áˆ˜á‹˜áŒá‰£áˆ á‹ˆá‹­áˆ á‹«áˆˆá‹áŠ• á‹«á‹˜áˆáŠ“áˆ
    function setRegisteredUser(phone, password, tier) {
        // á‹¨á‹³á‰³á‰¤á‹ áˆá‰µáŠ­: áˆáˆ‰áŠ•áˆ á‰°áŒ á‰ƒáˆšá‹á‰½ á‰ á‰áŒ¥áˆ­ á‹­á‹­á‹›áˆ
        let users = JSON.parse(localStorage.getItem('fasil_app_users') || '[]');
        
        const existingIndex = users.findIndex(u => u.phone === phone);

        if (existingIndex > -1) {
            // á‹«áˆˆá‹áŠ• á‹«á‹˜áˆáŠ“áˆ
            users[existingIndex] = { phone, password, tier: tier || 'free' };
        } else {
            // áŠ á‹²áˆµ á‹­áˆ˜á‹˜áŒá‰£áˆ
            users.push({ phone, password, tier: tier || 'free' });
        }
        
        localStorage.setItem('fasil_app_users', JSON.stringify(users));
        localStorage.setItem('fasil_current_user_phone', phone); // áŠ áˆáŠ• á‹¨áŒˆá‰£á‹áŠ• á‹«áˆµá‰€áˆáŒ£áˆ
    }

    function getCurrentUserTier() {
        const phone = localStorage.getItem('fasil_current_user_phone');
        if (!phone) return 'free';

        const users = JSON.parse(localStorage.getItem('fasil_app_users') || '[]');
        const user = users.find(u => u.phone === phone);
        
        return user ? user.tier : 'free';
    }

    // á‹¨áŒˆáŒ½á‰³ á‰áŒ¥áŒ¥áˆ­ (View Controller)
    function updateView(tier = null) {
        const sections = [
            'home-view', 'signup-form', 'login-form', 'pricing', 'payment-methods', 'privacy-policy', 'dashboard',
            'post-text', 'post-image', 'post-audio', 'view-text', 'view-image', 'view-audio', 'post-pdf', 'view-premium',
            'entertainment', 'news', 'create-group', 'premium-services'
        ];

        const hash = window.location.hash.substring(1) || 'home-view';

        sections.forEach(id => {
            const element = document.getElementById(id);
            if (element) {
                element.style.display = (id === hash) ? 'block' : 'none';
            }
        });

        // á‹¨áˆá‹áŒˆá‰£ áŒˆáŒ½ áˆ­á‹•áˆµ
        if (hash === 'signup-form') {
            if (tier) currentSubscription = tier;
            const titleElement = document.getElementById('signup-title');
            titleElement.textContent = (currentSubscription === 'premium') ? 'áˆ˜áˆ˜á‹áŒˆá‰¢á‹« (Sign Up - á‰ áŠ­áá‹«)' : 'áˆ˜áˆ˜á‹áŒˆá‰¢á‹« (Sign Up - áŠáƒ)';
        }

        const userTier = getCurrentUserTier();

        // á‹¨á•áˆªáˆšá‹¨áˆ áˆ›áˆ³á‹ˆá‰‚á‹«á‹á‰½
        if (hash === 'post-image') {
            const notice = document.getElementById('image-quality-notice');
            notice.innerHTML = (userTier === 'free') ?
                'âš ï¸ **áŠáƒ á‰°áŒ á‰ƒáˆš:** á‹¨áˆáˆµáˆ áŒ¥áˆ«á‰µáŠ“ áˆ˜áŒ áŠ• áˆˆá‹³á‰³ á‰†áŒ£á‰¢áŠá‰µ áˆ²á‰£áˆ **á‹­á‰€áŠáˆ³áˆ**á¢' :
                'âœ… **á‰ áŠ­áá‹« á‰°áŒ á‰ƒáˆš:** áˆáˆµáˆá‰½á‹ á‰ **áˆ™áˆ‰ áŒ¥áˆ«á‰µ** áŠ¥áŠ“ ááŒ¥áŠá‰µ á‹­áˆˆáŒ á‹áˆ‰á¢';
        }
        if (hash === 'entertainment') {
            document.getElementById('entertainment-notice').textContent =
                (userTier === 'free') ?
                'âš ï¸ áˆˆáˆ™áˆ‰ áˆáˆá‹µ áŠ¥áŠ“ AI á‹¨á‰³áŒˆá‹˜ á‹­á‹˜á‰µ á‹ˆá‹° á•áˆªáˆšá‹¨áˆ á‹­á‰€á‹­áˆ©á¢' :
                'âœ… á‰ áŠ¨áá‰°áŠ› áŒ¥áˆ«á‰µ áˆ˜á‹áŠ“áŠ“á‰µ á‹­áŒ€áˆáˆ©!';
        }
        if (hash === 'news') {
            document.getElementById('news-notice').textContent =
                (userTier === 'free') ?
                'âš ï¸ á‹œáŠ“á‹á‰½ á‰ áŒ¥áˆ«á‰µ á‰€áŠ•áˆ°á‹ á‹­á‰€áˆ­á‰£áˆ‰á¢ á‰ªá‹²á‹® á‹¨áˆˆáˆá¢' :
                'âœ… AI á‹¨á‰³áŒˆá‹˜ áŠ¥áŠ“ áŠ¨áá‰°áŠ› áŒ¥áˆ«á‰µ á‹«áˆˆá‹ á‹œáŠ“á‹á‰½áŠ• á‹«áŠ•á‰¥á‰¡á¢';
        }

        // á‹³áˆ½á‰¦áˆ­á‹µ áˆ‹á‹­ á•áˆªáˆšá‹¨áˆ áŠ áˆ›áˆ«áŒ®á‰½áŠ• áˆ›áˆ³á‹¨á‰µ
        if (hash === 'dashboard') {
            const premiumContainer = document.getElementById('premium-features-container');
            const premiumTitle = document.getElementById('premium-features-title');

            premiumContainer.style.display = (userTier === 'premium') ? 'block' : 'none';
            premiumTitle.style.display = (userTier === 'premium') ? 'block' : 'none';
        }
    }

    // 1. áˆ³á‹­áŠ• áŠ á• (Sign Up) - áŠ áˆáŠ• Local StorageáŠ• á‹­áŒ á‰€áˆ›áˆ
    function handleSignUp() {
        const phone = document.getElementById('signup-phone').value;
        const email = document.getElementById('signup-email').value;
        const password = document.getElementById('signup-password').value;

        const nextStep = (currentSubscription === 'premium') ? '#pricing' : '#privacy-policy';

        if (phone && email && password.length === 6) {
            let users = JSON.parse(localStorage.getItem('fasil_app_users') || '[]');
            const existingUser = users.find(u => u.phone === phone);

            if (existingUser) {
                alert('ğŸ”´ áŠ áˆá‰°áˆ˜á‹˜áŒˆá‰ áˆ! á‹­áˆ… áˆµáˆáŠ­ á‰áŒ¥áˆ­ áŠ¨á‹šáˆ… á‰ áŠá‰µ á‰°áˆ˜á‹áŒá‰§áˆá¢');
                return;
            }
            
            // áŠ á‹²áˆµ á‰°áŒ á‰ƒáˆšáŠ• á‹­áˆ˜á‹˜áŒá‰£áˆ
            setRegisteredUser(phone, password, 'free'); // áˆ˜áŒ€áˆ˜áˆªá‹« áŠáŒ» áŠá‹
            
            alert('âœ… áˆ˜áˆ˜á‹áŒˆá‰¥ á‰°áˆ³áŠ­á‰·áˆ!');
            window.location.hash = nextStep;
        } else {
            alert("áŠ¥á‰£áŠ­á‹ á‰µáŠ­áŠ­áˆˆáŠ› áˆ˜áˆ¨áŒƒ (áˆµáˆáŠ­á£ áŠ¢áˆœáˆ áŠ¥áŠ“ á‰£áˆˆ 6 áŠ áˆ€á‹ á“áˆµá‹ˆáˆ­á‹µ) á‹«áˆµáŒˆá‰¡á¢");
        }
    }

    // 2. áˆáŒ áŠ¢áŠ• (Log In) - áŠ áˆáŠ• Local StorageáŠ• á‹­áŒ á‰€áˆ›áˆ
    function handleLogin() {
        const phone = document.getElementById('login-phone').value;
        const password = document.getElementById('login-password').value;

        if (phone && password) {
            let users = JSON.parse(localStorage.getItem('fasil_app_users') || '[]');
            const user = users.find(u => u.phone === phone && u.password === password);

            if (user) {
                localStorage.setItem('fasil_current_user_phone', phone);
                alert(`âœ… áˆ˜áŒá‰£á‰µ á‰°áˆ³áŠ­á‰·áˆ! (Tier: ${user.tier.toUpperCase()})`);
                window.location.hash = '#privacy-policy';
            } else {
                alert('ğŸ”´ áˆµáˆáŠ­ á‰áŒ¥áˆ­ á‹ˆá‹­áˆ á‹¨á‹­áˆˆá á‰ƒáˆ á‰µáŠ­áŠ­áˆ áŠ á‹­á‹°áˆˆáˆá¢');
            }
        } else {
            alert("áŠ¥á‰£áŠ­á‹ áˆµáˆáŠ­ á‰áŒ¥áˆ­ áŠ¥áŠ“ á‹¨á‹­áˆˆá á‰ƒáˆ á‹«áˆµáŒˆá‰¡á¢");
        }
    }


    // 3. á‹¨áŠ­áá‹« áŠ¥á‰…á‹µ áˆ˜áˆáˆ¨áŒ¥
    function selectPlan(planKey) {
        selectedPlan = planKey;
        window.location.hash = '#payment-methods';
        document.getElementById('selected-plan-info').textContent = 
           `áŠ¥áˆ­áˆµá‹ á‹¨áˆ˜áˆ¨áŒ¡á‰µ áŠ¥á‰…á‹µ: ${PLANS[planKey].name} (${PLANS[planKey].price})`;
    }

    // 4. á‹¨áŠ­áá‹« á‹˜á‹´ áˆ˜áˆáˆ¨áŒ¥
    function processPayment(method) {
        if (!selectedPlan) { alert("áŠ¥á‰£áŠ­á‹ áˆ˜áŒ€áˆ˜áˆªá‹« á‹¨áŠ­áá‹« áŠ¥á‰…á‹µ á‹­áˆáˆ¨áŒ¡!"); window.location.hash = '#pricing'; return; }

        const planInfo = PLANS[selectedPlan];
        const currentUserPhone = localStorage.getItem('fasil_current_user_phone');
        
        if (!currentUserPhone) {
            alert("ğŸ”´ áŠ¥á‰£áŠ­á‹ áˆ˜áŒ€áˆ˜áˆªá‹« á‹­áŒá‰¡á¢");
            window.location.hash = '#login-form';
            return;
        }

        if (confirm(`á‰  ${method.toUpperCase()} áˆˆ ${planInfo.name} (${planInfo.price}) áˆˆáˆ˜áŠ­áˆáˆ áˆ˜áˆ­áŒ á‹‹áˆ:: áˆˆáŒŠá‹œá‹ áŠ­áá‹« áŠ á‹­á‰€á‰ áˆáˆá¢ á‹ˆá‹° á•áˆªáˆšá‹¨áˆ áŠ¥áŠ•á‰€á‹­áˆ­á‹?`)) {
            
            let users = JSON.parse(localStorage.getItem('fasil_app_users') || '[]');
            const userIndex = users.findIndex(u => u.phone === currentUserPhone);

            if (userIndex > -1) {
                // á‹¨áŒˆá‰£á‹áŠ• á‰°áŒ á‰ƒáˆš á‹ˆá‹° 'premium' á‹«á‹˜áˆáŠ“áˆ
                users[userIndex].tier = 'premium';
                localStorage.setItem('fasil_app_users', JSON.stringify(users));
                
                alert("âœ… á‹ˆá‹° á•áˆªáˆšá‹¨áˆ á‰°á‰€á‹­áˆ¨á‹‹áˆá¢ áŠ áˆáŠ• á‹¨áŠ­áá‹« áŠ áŒˆáˆáŒáˆá‰¶á‰½áŠ• áˆ˜áŒ á‰€áˆ á‹­á‰½áˆ‹áˆ‰!");
                window.location.hash = '#privacy-policy';
            } else {
                alert("ğŸ”´ á‹¨áˆµáˆ…á‰°á‰µ! á‰°áŒ á‰ƒáˆš áŠ áˆá‰°áŒˆáŠ˜áˆá¢ áŠ¥á‰£áŠ­á‹ áŠ¥áŠ•á‹°áŒˆáŠ“ á‹­áŒá‰¡á¢");
                window.location.hash = '#login-form';
            }
        } else {
            alert("áŠ­áá‹« áˆ³á‹­áˆá€áˆ á‹ˆá‹° áˆ˜áŠáˆ» á‹­áˆ˜áˆˆáˆ³áˆ‰::");
            window.location.hash = '#home-view';
        }
    }


    // 5. á‹¨áŒ½áˆá áˆ˜áˆˆáŒ á áŠ áˆ˜áŠ­áŠ•á‹®
    function handlePostText() {
        const title = document.getElementById('post-text-title').value;
        const content = document.getElementById('post-text-content').value;

        // á‹¨áˆ˜áŒá‰¢á‹« áˆ›áˆ¨áŒ‹áŒˆáŒ« (Login Check)
        if (!localStorage.getItem('fasil_current_user_phone')) {
             alert("ğŸ”´ áˆ˜áŒ€áˆ˜áˆªá‹« áˆ˜áŒá‰£á‰µ á‹«áˆµáˆáˆáŒá‹á‰³áˆá¢");
             window.location.hash = '#login-form';
             return;
        }

        const policyViolations = ['á–áˆˆá‰²áŠ«', 'á‰…áˆµá‰€áˆ³', 'áŒ¥áˆ‹á‰»', 'áŒáŒ­á‰µ', 'áˆ›áŒ¥á‰ƒá‰µ', 'á‹˜áˆ­'];
        const textToCheck = (title + " " + content).toLowerCase();
        const isViolating = policyViolations.some(word => textToCheck.includes(word));

        if (isViolating) {
            alert("âŒ áŠ áˆá‰°áˆˆáŒ áˆáˆ! áˆ˜áˆá‹•áŠ­á‰µá‹ áŠ¨áŒ¥á‰¥á‰… á–áˆŠáˆ²á‹«á‰½áŠ• á‹áŒ­ á‹¨áˆ†áŠ‘ á‰ƒáˆ‹á‰µ á‹­á‹Ÿáˆá¢");
        } else if (title.trim() === "" || content.trim() === "") {
            alert("áŠ¥á‰£áŠ­á‹ áˆ­á‹•áˆµ áŠ¥áŠ“ áˆ˜áˆá‹•áŠ­á‰µ á‹­áŒ»á‰á¢");
        } else {
            // áˆ˜áˆˆáŒ á á‰°áˆ³áŠ­á‰·áˆ - á‹¨ Frontend á‹³á‰³á‰¤á‹ áˆáˆ³áˆŒ
            let posts = JSON.parse(localStorage.getItem('fasil_posts') || '[]');
            posts.unshift({
                id: Date.now(),
                title: title,
                content: content,
                date: new Date().toLocaleDateString('am-ET')
            });
            localStorage.setItem('fasil_posts', JSON.stringify(posts));

            alert("âœ… áˆ˜áˆá‹•áŠ­á‰µá‹ á‰°áˆˆáŒ¥ááˆ! (á‰ áŠ áŠ«á‰£á‰¢á‹ á‰°á‰€áˆáŒ§áˆ)");
            document.getElementById('post-text-title').value = '';
            document.getElementById('post-text-content').value = '';
        }
    }
    
    // 6. á‹¨á‰°áˆˆáŒ á‰ áŒ½áˆáá‰½áŠ• áˆ˜áˆ˜áˆáŠ¨á‰µ
    function renderPosts() {
        const postContainer = document.querySelector('#view-text .section-content');
        let posts = JSON.parse(localStorage.getItem('fasil_posts') || '[]');
        
        if (!postContainer) {
            // áˆˆ view-text áŠ­ááˆ áŠ á‹²áˆµ div á‹­áŒ¨áˆáˆ«áˆ
            const viewTextSection = document.getElementById('view-text');
            const newContainer = document.createElement('div');
            newContainer.className = 'section-content';
            viewTextSection.insertBefore(newContainer, viewTextSection.querySelector('.back-btn'));
            postContainer = newContainer;
        }
        
        postContainer.innerHTML = ''; // á‹«áˆˆá‹áŠ• á‹«áŒ¸á‹³áˆ

        if (posts.length === 0) {
            postContainer.innerHTML = '<p style="text-align: center; color: #6c757d;">áˆáŠ•áˆ á‹¨á‰°áˆˆáŒ áˆ á…áˆ‘á á‹¨áˆˆáˆá¢</p>';
        } else {
            posts.forEach(post => {
                postContainer.innerHTML += `
                    <div style="border: 1px solid #007bff; padding: 15px; margin-bottom: 10px; border-radius: 6px; text-align: left; background: #e6f7ff;">
                        <h4 style="margin-top: 0; color: #0056b3;">${post.title}</h4>
                        <p style="font-size: 14px; color: #333;">${post.content}</p>
                        <small style="color: #6c757d;">á‹¨á‰°áˆˆáŒ áˆá‰ á‰µ á‰€áŠ•: ${post.date}</small>
                    </div>
                `;
            });
        }
    }

    // 7. á‹¨áˆáˆµáˆ áˆ˜áˆˆáŒ á áŠ áˆ˜áŠ­áŠ•á‹®
    function handlePostImage() {
         // á‹¨áˆ˜áŒá‰¢á‹« áˆ›áˆ¨áŒ‹áŒˆáŒ« (Login Check)
        if (!localStorage.getItem('fasil_current_user_phone')) {
             alert("ğŸ”´ áˆ˜áŒ€áˆ˜áˆªá‹« áˆ˜áŒá‰£á‰µ á‹«áˆµáˆáˆáŒá‹á‰³áˆá¢");
             window.location.hash = '#login-form';
             return;
        }
        
        const userTier = getCurrentUserTier();
        const msg = (userTier === 'free') ?
            "áˆáˆµáˆ‰ á‰°áˆáŠ³áˆ! (áˆˆáŠáƒ á‰°áŒ á‰ƒáˆšá‹á‰½ áŒ¥áˆ«á‰µ á‰€áŠ•áˆ¶ á‰°áˆáŠ³áˆ)" :
            "áˆáˆµáˆ‰ á‰°áˆáŠ³áˆ! (áˆˆáŠ­áá‹« á‰°áŒ á‰ƒáˆšá‹á‰½ á‰ áˆ™áˆ‰ áŒ¥áˆ«á‰µ á‰°áˆáŠ³áˆ)";
        alert(msg);
    }
    
    // á‹¨áŒˆáŒ½ áˆˆá‹áŒ¥ áˆ²áŠ¨áˆ°á‰µ á–áˆµá‰¶á‰½áŠ• áˆ›á‹˜áˆ˜áŠ•
    window.addEventListener('hashchange', () => {
        updateView(null);
        if (window.location.hash.substring(1) === 'view-text') {
            renderPosts();
        }
    });
    window.addEventListener('load', () => {
        updateView(null);
        if (window.location.hash.substring(1) === 'view-text') {
            renderPosts();
        }
    });
</script>
