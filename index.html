ሠ<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ፋሲል ዌብ አፕ - Fasil Web App (Firebase Version)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- All CSS remains exactly the same --- */
        /* [All your CSS code here - unchanged] */
    </style>
</head>
<body>

    <!-- [All HTML content remains exactly the same] -->
    
    <!-- Firebase and Firestore scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc, 
            getDoc, 
            getDocs, 
            updateDoc, 
            deleteDoc,
            query,
            orderBy,
            onSnapshot,
            serverTimestamp 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAWS8PJ0kmu56hixesxV1KrMH8NRciH6U0",
            authDomain: "fasil-web-app-3a732.firebaseapp.com",
            projectId: "fasil-web-app-3a732",
            storageBucket: "fasil-web-app-3a732.firebasestorage.app",
            messagingSenderId: "239133072986",
            appId: "1:239133072986:web:0dcbd768e1e916b9b64263"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // Firebase collections
        const usersRef = collection(db, "users");
        const postsRef = collection(db, "posts");
        const groupsRef = collection(db, "groups");
        const feedbacksRef = collection(db, "feedbacks");
        const reportsRef = collection(db, "reports");
        const chatsRef = collection(db, "chats");

        console.log("Firebase initialized successfully!");
    </script>

    <script>
        // --- DATA ---
        let user = JSON.parse(localStorage.getItem('fg_user')) || null;
        let users = [];
        let posts = [];
        let groups = [];
        let feedbacks = [];
        let reports = [];
        let chats = {};
        
        let adminPass = localStorage.getItem('fg_admin_pass') || 'abc123456abc';
        let lang = 'am';
        let hasAgreed = false;
        let viewHistory = [];
        let activePostType = 'text';
        let activeChat = null;
        let activeCommentPostId = null;
        let pendingAct = null;
        let uploadTarget = '';
        let liveStream = null;
        let comMode = 'view'; 
        let pendingAdminAction = null;
        let lastReceiptUrl = '';

        const RATES = {USD:120, GBP:150, EUR:130};

        // --- FIREBASE FUNCTIONS ---
        async function saveUserToFirebase(userData) {
            try {
                await setDoc(doc(db, "users", userData.phone), {
                    ...userData,
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp()
                });
                console.log("User saved to Firebase:", userData.phone);
                return true;
            } catch (error) {
                console.error("Error saving user:", error);
                return false;
            }
        }

        async function getUserFromFirebase(phone) {
            try {
                const docRef = doc(db, "users", phone);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    return docSnap.data();
                } else {
                    return null;
                }
            } catch (error) {
                console.error("Error getting user:", error);
                return null;
            }
        }

        async function savePostToFirebase(postData) {
            try {
                const postId = postData.id || Date.now().toString();
                await setDoc(doc(db, "posts", postId.toString()), {
                    ...postData,
                    timestamp: serverTimestamp()
                });
                console.log("Post saved to Firebase:", postId);
                return true;
            } catch (error) {
                console.error("Error saving post:", error);
                return false;
            }
        }

        async function getPostsFromFirebase() {
            try {
                const q = query(postsRef, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                const postsArray = [];
                querySnapshot.forEach((doc) => {
                    postsArray.push({ id: doc.id, ...doc.data() });
                });
                return postsArray;
            } catch (error) {
                console.error("Error getting posts:", error);
                return [];
            }
        }

        async function updatePostInFirebase(postId, updates) {
            try {
                const postRef = doc(db, "posts", postId.toString());
                await updateDoc(postRef, updates);
                console.log("Post updated in Firebase:", postId);
                return true;
            } catch (error) {
                console.error("Error updating post:", error);
                return false;
            }
        }

        async function deletePostFromFirebase(postId) {
            try {
                await deleteDoc(doc(db, "posts", postId.toString()));
                console.log("Post deleted from Firebase:", postId);
                return true;
            } catch (error) {
                console.error("Error deleting post:", error);
                return false;
            }
        }

        async function saveGroupToFirebase(groupData) {
            try {
                const groupId = groupData.id || Date.now().toString();
                await setDoc(doc(db, "groups", groupId.toString()), {
                    ...groupData,
                    createdAt: serverTimestamp()
                });
                console.log("Group saved to Firebase:", groupId);
                return true;
            } catch (error) {
                console.error("Error saving group:", error);
                return false;
            }
        }

        async function getGroupsFromFirebase() {
            try {
                const querySnapshot = await getDocs(groupsRef);
                const groupsArray = [];
                querySnapshot.forEach((doc) => {
                    groupsArray.push({ id: doc.id, ...doc.data() });
                });
                return groupsArray;
            } catch (error) {
                console.error("Error getting groups:", error);
                return [];
            }
        }

        async function saveFeedbackToFirebase(feedbackData) {
            try {
                const feedbackId = Date.now().toString();
                await setDoc(doc(db, "feedbacks", feedbackId), {
                    ...feedbackData,
                    timestamp: serverTimestamp()
                });
                console.log("Feedback saved to Firebase");
                return true;
            } catch (error) {
                console.error("Error saving feedback:", error);
                return false;
            }
        }

        async function getFeedbacksFromFirebase() {
            try {
                const q = query(feedbacksRef, orderBy("timestamp", "desc"));
                const querySnapshot = await getDocs(q);
                const feedbacksArray = [];
                querySnapshot.forEach((doc) => {
                    feedbacksArray.push(doc.data());
                });
                return feedbacksArray;
            } catch (error) {
                console.error("Error getting feedbacks:", error);
                return [];
            }
        }

        async function saveReportToFirebase(reportData) {
            try {
                const reportId = Date.now().toString();
                await setDoc(doc(db, "reports", reportId), {
                    ...reportData,
                    timestamp: serverTimestamp()
                });
                console.log("Report saved to Firebase");
                return true;
            } catch (error) {
                console.error("Error saving report:", error);
                return false;
            }
        }

        async function getReportsFromFirebase() {
            try {
                const querySnapshot = await getDocs(reportsRef);
                const reportsArray = [];
                querySnapshot.forEach((doc) => {
                    reportsArray.push(doc.data());
                });
                return reportsArray;
            } catch (error) {
                console.error("Error getting reports:", error);
                return [];
            }
        }

        async function saveChatMessage(chatKey, message) {
            try {
                const chatId = Date.now().toString();
                await setDoc(doc(db, "chats", chatKey + "_" + chatId), {
                    ...message,
                    chatKey: chatKey,
                    timestamp: serverTimestamp()
                });
                console.log("Chat message saved to Firebase");
                return true;
            } catch (error) {
                console.error("Error saving chat:", error);
                return false;
            }
        }

        async function getChatMessages(chatKey) {
            try {
                const q = query(chatsRef, orderBy("timestamp", "asc"));
                const querySnapshot = await getDocs(q);
                const messages = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.chatKey === chatKey) {
                        messages.push(data);
                    }
                });
                return messages;
            } catch (error) {
                console.error("Error getting chat messages:", error);
                return [];
            }
        }

        // Load all data from Firebase on startup
        async function loadAllData() {
            try {
                console.log("Loading data from Firebase...");
                
                // Load users
                const usersSnapshot = await getDocs(usersRef);
                users = [];
                usersSnapshot.forEach((doc) => {
                    users.push(doc.data());
                });
                
                // Load posts
                posts = await getPostsFromFirebase();
                
                // Load groups
                groups = await getGroupsFromFirebase();
                
                // Load feedbacks
                feedbacks = await getFeedbacksFromFirebase();
                
                // Load reports
                reports = await getReportsFromFirebase();
                
                console.log("Data loaded successfully from Firebase!");
                console.log("Users:", users.length);
                console.log("Posts:", posts.length);
                console.log("Groups:", groups.length);
                
                // If user is logged in, update UI
                if (user) {
                    const updatedUser = users.find(u => u.phone === user.phone);
                    if (updatedUser) {
                        user = updatedUser;
                        localStorage.setItem('fg_user', JSON.stringify(user));
                    }
                }
                
            } catch (error) {
                console.error("Error loading data from Firebase:", error);
            }
        }

        // Call this on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAllData();
        });

        // --- MODIFIED AUTH FUNCTIONS for Firebase ---
        async function finalSignup() {
            const n=document.getElementById('reg-name').value; 
            const p=document.getElementById('reg-phone').value; 
            const e=document.getElementById('reg-email').value; 
            const pw=document.getElementById('reg-pass').value; 
            const f=document.getElementById('file-profile').files[0];
            
            if(!f) return showAlert("Photo required", "error");
            
            // Check if user already exists in Firebase
            const existingUser = users.find(u => u.phone === p || u.email === e);
            if(existingUser) {
                return showAlert(lang==='am'?'ይህ ስልክ/ኢሜል ተመዝግቧል':'Already Registered', "error");
            }
            
            // Create user object
            const newUser = {
                name: n, 
                phone: p, 
                email: e, 
                password: pw, 
                balUSD: 0, 
                balGBP: 0, 
                balEUR: 0, 
                balETB: 0, 
                photo: '', 
                regDate: Date.now()
            };
            
            // Save to Firebase
            const saved = await saveUserToFirebase(newUser);
            if(saved) {
                // Add to local array
                users.push(newUser);
                showAlert("Registered successfully in Firebase!", "success"); 
                showAuth('login');
            } else {
                showAlert("Registration failed. Please try again.", "error");
            }
        }

        async function doLogin() {
            const p=document.getElementById('log-phone').value; 
            const pw=document.getElementById('log-pass').value;
            
            // First check Firebase
            const firebaseUser = await getUserFromFirebase(p);
            
            if(firebaseUser && firebaseUser.password === pw) {
                user = firebaseUser;
                localStorage.setItem('fg_user', JSON.stringify(user));
                if(user.name === 'Admin' || user.name === 'Fasil') {
                    document.getElementById('btn-admin-rep').style.display='block';
                }
                document.getElementById('view-agreement').classList.remove('show'); 
                showView('view-home');
                showAlert("Welcome back!", "success");
            } else {
                // Fallback to local storage (for backward compatibility)
                const localUser = users.find(x => x.phone === p && x.password === pw);
                if(localUser) {
                    user = localUser;
                    localStorage.setItem('fg_user', JSON.stringify(user));
                    document.getElementById('view-agreement').classList.remove('show'); 
                    showView('view-home');
                    showAlert("Welcome back! (Local login)", "success");
                } else {
                    showAlert("Invalid phone or password", "error");
                }
            }
        }

        // --- MODIFIED POST FUNCTIONS for Firebase ---
        async function submitPost() {
            const t=document.getElementById('p-title').value; 
            const c=document.getElementById('p-content').value;
            
            if(!t) return showAlert("Title required", "error");
            if(activePostType==='text' && !c) return showAlert("Content required", "error");
            
            const forbidden = ['politics', 'hate', 'war', 'racism', 'ፖለቲካ', 'ዘረኝነት', 'ጦርነት'];
            if(forbidden.some(w => (t+' '+c).toLowerCase().includes(w))) {
                return showAlert("ከፖሊሲያችን ውጭ ነው መለጠፍ አይቻልም", "error");
            }

            const saveToFirebase = async (d) => {
                const postData = {
                    t, 
                    c, 
                    d, 
                    type: activePostType, 
                    u: user.name, 
                    uid: user.phone, 
                    photo: user.photo, 
                    likes: 0, 
                    follows: 0, 
                    isHidden: false, 
                    comments: [],
                    timestamp: Date.now()
                };
                
                const saved = await savePostToFirebase(postData);
                if(saved) {
                    posts.unshift({ id: Date.now().toString(), ...postData });
                    showAlert(lang==='am'?'በፋየርቤዝ ላይ ተሳክቷል':'Successfully posted to Firebase!', "success"); 
                    
                    // Clear and Reset
                    clearPostForm();
                    document.getElementById('post-form-area').style.display='none'; 
                    document.getElementById('post-type-select').style.display='block';
                    renderPosts(activePostType); 
                    navTo('view-info');
                } else {
                    showAlert("Failed to save post. Please try again.", "error");
                }
            };
            
            if(activePostType!=='text') { 
                const f=document.getElementById('file-post').files[0]; 
                if(f){ 
                    const r=new FileReader(); 
                    r.onload=async e=>{
                        await saveToFirebase(e.target.result);
                    }; 
                    r.readAsDataURL(f); 
                } else {
                    await saveToFirebase(null);
                }
            } else {
                await saveToFirebase(null);
            }
        }

        async function renderPosts(type) {
            const c=document.getElementById('feed-container'); 
            c.innerHTML='<p>Loading posts from Firebase...</p>';
            
            // Get fresh posts from Firebase
            posts = await getPostsFromFirebase();
            
            const fs = posts.filter(p => p.type === type && !p.isHidden);
            
            if(!fs.length) {
                c.innerHTML='<p>No posts yet. Be the first to post!</p>';
                return;
            }
            
            c.innerHTML = '';
            fs.forEach(p => {
                let m = ''; 
                if(p.d) { 
                    if(p.type==='image') m=`<img src="${p.d}" width="100%" style="max-height:300px;object-fit:contain;">`; 
                    else if(p.type==='video') m=`<video src="${p.d}" controls playsinline width="100%" style="max-height:300px;"></video>`; 
                    else m=`<audio src="${p.d}" controls></audio>`; 
                }
                
                const isMine = p.uid === user.phone;
                const delHtml = isMine ? 
                    `<button class="btn-red btn-tiny" style="width:100%; margin-top:5px;" onclick="tryDelete('${p.id}', '${p.uid}')">Delete Post</button>` : 
                    '';
                
                c.innerHTML += `<div class="post-card">
                    <div class="post-header"><img src="lion_image.jpg"> <b>${p.u}</b></div>
                    <h4>${p.t}</h4><p>${p.c||''}</p>${m}
                    <div class="post-actions">
                        <button class="action-icon" onclick="likePost('${p.id}', this)">Like ${p.likes||0}</button>
                        <button class="action-icon" onclick="openComModal('${p.id}')">Comment</button>
                        <button class="action-icon" onclick="sharePost()">Share</button>
                        <button class="action-icon" onclick="promptReport('${p.id}', '${p.u}')">Report</button>
                        <button class="action-icon" onclick="followUser('${p.id}', this)">Follow ${p.follows||0}</button>
                    </div>
                    ${delHtml}
                </div>`;
            });
        }

        async function tryDelete(id, uid) {
            if(uid === user.phone) { 
                const confirmed = confirm("Are you sure you want to delete this post?");
                if(confirmed) {
                    const deleted = await deletePostFromFirebase(id);
                    if(deleted) {
                        posts = posts.filter(p => p.id !== id);
                        showAlert('Post deleted from Firebase!', 'success'); 
                        renderPosts(activePostType); 
                    } else {
                        showAlert('Failed to delete post.', 'error');
                    }
                }
            } else {
                showAlert(lang==='am'?'የእርስዎ አይደለም የሰዎችን መደለት አይችሉም':'Not yours', 'error'); 
            }
        }

        async function likePost(id, btn) { 
            const p = posts.find(x => x.id === id);
            if(p) {
                p.likes = (p.likes || 0) + 1;
                await updatePostInFirebase(id, { likes: p.likes });
                btn.innerHTML = `Like ${p.likes}`;
            }
        }

        async function followUser(id, btn) { 
            const p = posts.find(x => x.id === id);
            if(p) {
                p.follows = (p.follows || 0) + 1;
                await updatePostInFirebase(id, { follows: p.follows });
                btn.innerHTML = `Follow ${p.follows}`;
            }
        }

        async function saveComment(pid, type, txt) {
            const p = posts.find(x => x.id === pid);
            if(!p) return;
            
            if(!p.comments) p.comments = [];
            p.comments.push({u: user.name, type, txt});
            
            await updatePostInFirebase(pid, { comments: p.comments });
            showAlert("Comment saved to Firebase!", "success");
        }

        // --- MODIFIED GROUP FUNCTIONS for Firebase ---
        async function createGroup(){
            const n = prompt("Group Name:");
            if(n && n.trim()) {
                const groupData = {
                    id: Date.now().toString(),
                    name: n.trim(),
                    creator: user.phone,
                    creatorName: user.name,
                    members: [user.phone],
                    msgs: [],
                    createdAt: Date.now()
                };
                
                const saved = await saveGroupToFirebase(groupData);
                if(saved) {
                    groups.push(groupData);
                    showAlert("Group created in Firebase!", "success"); 
                    goBack();
                } else {
                    showAlert("Failed to create group.", "error");
                }
            }
        }

        async function showMyGroups(){
            const c = document.getElementById('grp-list'); 
            c.innerHTML='<p>Loading groups from Firebase...</p>';
            
            // Get fresh groups from Firebase
            groups = await getGroupsFromFirebase();
            
            const myGroups = groups.filter(g => g.creator === user.phone);
            
            if(!myGroups.length) {
                c.innerHTML='<p>You haven\'t created any groups yet.</p>';
                navTo('my-groups-sec');
                return;
            }
            
            c.innerHTML = '';
            myGroups.forEach(g => {
                const memberCount = g.members ? g.members.length : 1;
                c.innerHTML += `
                    <div class="user-item" onclick="openGrp('${g.id}')">
                        <b>${g.name}</b> 
                        <span style="font-size:12px;color:#666;">(Members: ${memberCount})</span>
                    </div>`;
            });
            navTo('my-groups-sec');
        }

        // --- MODIFIED FEEDBACK FUNCTIONS for Firebase ---
        async function giveFb(t) {
            if(t === 'live') {
                openLiveCamera();
            } else { 
                const x = prompt("Your feedback:");
                if(x && x.trim()) {
                    const feedbackData = {
                        u: user.name,
                        uPhone: user.phone,
                        c: x.trim(),
                        type: 'text'
                    };
                    
                    const saved = await saveFeedbackToFirebase(feedbackData);
                    if(saved) {
                        feedbacks.push(feedbackData);
                        showAlert("Feedback saved to Firebase!", "success");
                    } else {
                        showAlert("Failed to save feedback.", "error");
                    }
                }
            }
        }

        async function viewFbs() {
            const listDiv = document.getElementById('fb-list');
            listDiv.innerHTML = '<p>Loading feedbacks from Firebase...</p>';
            
            // Get fresh feedbacks from Firebase
            feedbacks = await getFeedbacksFromFirebase();
            
            if(!feedbacks.length) {
                listDiv.innerHTML = '<p>No feedbacks yet.</p>';
                return;
            }
            
            listDiv.innerHTML = feedbacks.map(f => 
                `<div class="post-card" style="margin:5px 0;padding:10px;">
                    <b>${f.u}:</b> ${f.c}
                    <div style="font-size:10px;color:#888;">${new Date(f.timestamp?.toDate() || Date.now()).toLocaleString()}</div>
                </div>`
            ).join('');
        }

        // --- MODIFIED REPORT FUNCTIONS for Firebase ---
        async function promptReport(id, uname) { 
            const r = prompt("Reason for reporting:");
            if(r && r.trim()) {
                const p = posts.find(x => x.id === id);
                const reportData = {
                    id, 
                    reason: r.trim(), 
                    reporter: user.name, 
                    reporterPhone: user.phone,
                    reporterPhoto: user.photo, 
                    target: uname, 
                    postContent: p ? p.t : 'Unknown',
                    timestamp: Date.now()
                };
                
                const saved = await saveReportToFirebase(reportData);
                if(saved) {
                    reports.push(reportData);
                    showAlert("Report submitted to Firebase!", "success");
                } else {
                    showAlert("Failed to submit report.", "error");
                }
            } 
        }

        async function renderReports() {
            const c = document.getElementById('admin-dynamic-content'); 
            c.innerHTML='<p>Loading reports from Firebase...</p>';
            
            // Get fresh reports from Firebase
            reports = await getReportsFromFirebase();
            
            if(reports.length === 0) { 
                c.innerHTML = "<p>No reports yet.</p>"; 
                return; 
            }
            
            c.innerHTML = '';
            reports.forEach(r => {
                const p = posts.find(x => x.id === r.id);
                const isBanned = p ? p.isHidden : false;
                const statusClass = isBanned ? 'banned-text' : 'open-text';
                const containerClass = isBanned ? 'banned-indicator' : '';
                const statusTxt = isBanned ? "BANNED (Black)" : "OPEN (Blue)";

                c.innerHTML += `<div class="post-card ${containerClass}">
                    <b>Reporter:</b> ${r.reporter} <img src="lion_image.jpg" width="20"><br> 
                    <b>Post:</b> ${r.postContent} <br> 
                    <b>Reason:</b> ${r.reason}<br>
                    <b>Time:</b> ${new Date(r.timestamp).toLocaleString()}<br>
                    Status: <span class="${statusClass}">${statusTxt}</span><br>
                    <button class="btn-red btn-small" onclick="banPost('${r.id}')">Ban</button> 
                    <button class="btn-blue btn-small" onclick="unbanPost('${r.id}')">Open/Unban</button>
                </div>`;
            });
        }

        async function banPost(id) { 
            const p = posts.find(x => x.id === id); 
            if(p) {
                p.isHidden = true; 
                await updatePostInFirebase(id, { isHidden: true });
                showAlert("Post banned in Firebase!", "success"); 
                renderReports(); 
            }
        }

        async function unbanPost(id) { 
            const p = posts.find(x => x.id === id); 
            if(p) {
                p.isHidden = false; 
                await updatePostInFirebase(id, { isHidden: false });
                showAlert("Post unbanned in Firebase!", "success"); 
                renderReports(); 
            }
        }

        // --- MODIFIED CHAT FUNCTIONS for Firebase ---
        async function sendChat(t) {
            const txt = document.getElementById('chat-in').value;
            if(!txt.trim()) return;
            
            const msg = {
                u: user.name,
                uPhone: user.phone,
                t: txt.trim(),
                type: t,
                timestamp: Date.now()
            };
            
            let chatKey;
            if(activeChat.type === 'p') {
                chatKey = [user.phone, activeChat.id].sort().join('_');
            } else {
                chatKey = 'group_' + activeChat.id;
            }
            
            const saved = await saveChatMessage(chatKey, msg);
            if(saved) {
                document.getElementById('chat-in').value = '';
                renderChat();
            } else {
                showAlert("Failed to send message.", "error");
            }
        }

        async function renderChat() {
            const c = document.getElementById('chat-box'); 
            c.innerHTML = '<p>Loading messages...</p>';
            
            let chatKey;
            if(activeChat.type === 'p') {
                chatKey = [user.phone, activeChat.id].sort().join('_');
            } else {
                chatKey = 'group_' + activeChat.id;
            }
            
            const messages = await getChatMessages(chatKey);
            
            if(!messages.length) {
                c.innerHTML = '<p>No messages yet. Start the conversation!</p>';
                return;
            }
            
            c.innerHTML = messages.map(m => 
                `<div style="margin:5px 0;padding:5px;background:${m.uPhone === user.phone ? '#e3f2fd' : '#f5f5f5'};border-radius:5px;">
                    <b>${m.u}:</b> ${m.t}
                    <div style="font-size:10px;color:#888;text-align:right;">
                        ${new Date(m.timestamp?.toDate() || m.timestamp).toLocaleTimeString()}
                    </div>
                </div>`
            ).join('');
            
            // Scroll to bottom
            c.scrollTop = c.scrollHeight;
        }

        // --- BUSINESS FUNCTIONS (Keep local for now, can upgrade later) ---
        function upBal(){
            // Business functions remain using local storage for now
            document.getElementById('bal-usd').innerText = (user.balUSD || 0).toFixed(2);
            document.getElementById('bal-gbp').innerText = (user.balGBP || 0).toFixed(2);
            document.getElementById('bal-eur').innerText = (user.balEUR || 0).toFixed(2);
            document.getElementById('bal-etb').innerText = (user.balETB || 0).toFixed(2);
            const tot = (user.balUSD || 0) + ((user.balGBP || 0)*1.25) + ((user.balEUR || 0)*1.1) + ((user.balETB || 0)/120);
            document.getElementById('bal-total').innerText = tot.toFixed(2);
            const totEth = (user.balETB || 0) + ((user.balUSD || 0)*120) + ((user.balGBP || 0)*150) + ((user.balEUR || 0)*130);
            document.getElementById('bal-total-etb').innerText = totEth.toFixed(2);
        }

        async function saveProfile() {
            const n = document.getElementById('prof-name-edit').value; 
            const o = document.getElementById('old-pass').value; 
            const p = document.getElementById('new-pass').value; 
            const cp = document.getElementById('conf-pass').value;
            
            if(p && p !== cp) return showAlert("Passwords do not match", "error");
            if(o && o !== user.password) return showAlert("Old Password Wrong", "error");
            
            if(n) user.name = n; 
            if(p) user.password = p;
            
            // Update in Firebase
            const updated = await saveUserToFirebase(user);
            if(updated) {
                localStorage.setItem('fg_user', JSON.stringify(user));
                showAlert("Profile updated in Firebase!", "success");
            } else {
                showAlert("Failed to update profile.", "error");
            }
        }

        // --- KEEP ALL OTHER FUNCTIONS THE SAME ---
        // [All other functions remain the same - translations, UI, etc.]

        // --- TRANSLATIONS and other UI functions remain exactly the same ---
        const TXT = {
            // [Keep all translation objects exactly the same]
        };

        // [Keep all other functions exactly the same]
        // Only the data storage functions have been modified for Firebase

        // Initialize
        toggleLanguage(); 
        toggleLanguage();
        
        // Load data when page loads
        setTimeout(() => {
            loadAllData();
        }, 1000);

    </script>
</body>
</html>
