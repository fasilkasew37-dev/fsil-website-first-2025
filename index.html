·ã≤<!DOCTYPE html>
<html lang="am">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·çã·à≤·àç ·ãå·â• ·ä†·çï - Fasil Web App (Final Version)</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* --- General CSS --- */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            text-align: center; padding: 0; margin: 0;
            background-color: #f0f4f8; color: #333;
            padding-bottom: 90px;
        }
        .container { max-width: 700px; margin: 0 auto; padding: 5px; }
        
        /* Header */
        .top-header {
            display: flex; justify-content: space-between; align-items: center;
            background: #fff; padding: 5px 10px; border-bottom: 3px solid #007bff;
        }
        .header-icon-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; object-position: top; border: 2px solid #ccc; }
        .marquee-container-top { flex: 1; overflow: hidden; white-space: nowrap; margin: 0 10px; }
        .marquee-text-top { display: inline-block; padding-left: 100%; animation: marquee 15s linear infinite; color: #007bff; font-weight: bold; font-size: 16px; }
        
        /* Footer */
        .footer-wrapper { position: fixed; bottom: 0; left: 0; width: 100%; z-index: 1000; background: white; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); }
        .bottom-nav { display: flex; height: 55px; width: 100%; }
        .nav-btn { flex: 1; border: none; font-weight: bold; font-size: 14px; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .nav-home { background-color: #28a745; } .nav-live { background-color: #ffc107; color: black; } .nav-profile { background-color: #dc3545; }
        .bottom-marquee { background: #f0f0f0; color: #28a745; font-weight: bold; overflow: hidden; white-space: nowrap; height: 25px; line-height: 25px; font-size: 12px; }
        .bottom-marquee span { display: inline-block; padding-left: 100%; animation: marquee 12s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(0); } 100% { transform: translateX(-100%); } }

        /* Sections */
        .section { display: none; background: white; padding: 15px; border-radius: 8px; margin-top: 10px; min-height: 400px; }
        .show { display: block; animation: fadeIn 0.5s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        /* Welcome Split - Compacted */
        .split-container { display: flex; justify-content: space-between; gap: 5px; text-align: left; margin-bottom: 5px; }
        .split-left { width: 48%; color: #007bff; font-size: 10px; line-height: 1.2; padding: 2px; }
        .split-right { width: 48%; color: #d35400; font-size: 10px; font-weight: bold; line-height: 1.2; border-left: 1px solid #ccc; padding-left: 5px; padding: 2px; }
        .blue-spacer { height: 10px; background-color: #007bff; margin: 5px 0; border-radius: 5px; }
        #t-in, #t-po { font-size: 9px; }

        /* --- COMPLEX LOGO AREA UPDATED --- */
        .brand-area { display: flex; align-items: center; justify-content: space-between; margin-top: 15px; padding: 0 5px; }
        
        /* Updated Side Logos: Bigger + Blue Circle */
        .side-logo { 
            width: 60px; 
            height: 60px; 
            object-fit: cover; 
            border-radius: 50%; 
            border: 3px solid #007bff; /* The Blue Circle */
            padding: 2px;
            background: white;
        }
        
        /* The Central Logo Construction */
        .complex-logo { position: relative; width: 110px; height: 110px; margin: 0 auto; }
        .ring { position: absolute; border-radius: 50%; display: flex; align-items: center; justify-content: center; top: 50%; left: 50%; transform: translate(-50%, -50%); }
        
        /* Blue Outer */
        .ring-blue { width: 110px; height: 110px; border: 4px solid #00008b; background: transparent; z-index: 1; }
        
        /* Red Ring */
        .ring-red { width: 92px; height: 92px; border: 3px solid red; z-index: 2; }
        
        /* Items on Red/Yellow Ring (UPDATED SIZE) */
        .pos-item { position: absolute; width: 16px; height: 16px; object-fit: cover; border-radius: 50%; border: 1px solid rgba(255,255,255,0.7); }
        .p-n { top: -8px; left: 50%; transform: translateX(-50%); } 
        .p-s { bottom: -8px; left: 50%; transform: translateX(-50%); } 
        .p-e { right: -8px; top: 50%; transform: translateY(-50%); } 
        .p-w { left: -8px; top: 50%; transform: translateY(-50%); } 
        .p-ne { top: 12%; right: 12%; } .p-nw { top: 12%; left: 12%; }
        .p-se { bottom: 12%; right: 12%; } .p-sw { bottom: 12%; left: 12%; }

        /* Yellow Ring */
        .ring-yellow { width: 70px; height: 70px; border: 3px solid yellow; z-index: 3; }
        
        /* Green Ring (Enlarged for Lion) */
        .ring-green { width: 52px; height: 52px; background: green; border-radius: 50%; z-index: 4; position: relative; overflow: hidden; }
        
        /* Flashing Light Behind Dove */
        .flash-light { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: radial-gradient(circle, white, #007bff); opacity: 0.5; animation: flash 1s infinite alternate; z-index: 5; }
        @keyframes flash { from { opacity: 0.3; } to { opacity: 0.8; } }
        
        .center-dove { position: absolute; width: 40px; height: 40px; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 6; opacity: 0.6; }
        
        /* Central Lion (UPDATED SIZE - BIGGER & CLEAR) */
        .center-lion { 
            position: absolute; 
            width: 50px; 
            height: 50px; 
            top: 50%; left: 50%; 
            transform: translate(-50%, -50%); 
            z-index: 7; 
            object-fit: cover; 
            border-radius: 50%; 
            border: 1px solid white; 
        }

        /* Images */
        .lion-full-img { width: 100%; height: auto; max-height: 200px; object-fit: contain; margin-top: 10px; border-radius: 8px; }
        .eagle-dash-img { width: 50px; height: 50px; object-fit: cover; border-radius: 50%; vertical-align: middle; margin-right: 10px; }

        /* Dashboard Split */
        .dash-layout { display: flex; gap: 10px; align-items: flex-start; }
        .dash-left { width: 60%; text-align: left; } .dash-right { width: 40%; }
        
        /* UI Elements */
        input, select, textarea { width: 100%; padding: 10px; margin: 5px 0; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        button { width: 100%; padding: 12px; margin: 5px 0; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn-green { background: #28a745; } .btn-red { background: #dc3545; } .btn-blue { background: #007bff; } .btn-yellow { background: #ffc107; color: black; }
        .btn-small { padding: 8px; font-size: 12px; margin: 2px 0; }
        .btn-tiny { padding: 5px; font-size: 10px; margin: 1px; }
        .btn-admin { background: #333; color: white; display: none; }
        .lang-btn { background: #6c757d; color: white; padding: 4px 8px; font-size: 10px; border-radius: 4px; border:none; cursor: pointer; margin-top: 2px;}
        
        /* Modified Buttons */
        .btn-compact { padding: 8px; margin: 2px 0; font-size: 14px; margin-top: 15px; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal-box { background: white; padding: 20px; width: 85%; border-radius: 10px; text-align: center; max-height: 80vh; overflow-y: auto; }

        /* Post Card */
        .post-card { border: 1px solid #eee; background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 15px; text-align: left; }
        .post-header { display: flex; align-items: center; margin-bottom: 10px; border-bottom: 1px solid #f0f0f0; padding-bottom: 5px; }
        .post-header img { width: 35px; height: 35px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .post-actions { display: flex; justify-content: space-between; margin-top: 10px; padding-top: 10px; border-top: 1px solid #eee; flex-wrap: wrap; }
        .action-icon { background: none; border: none; color: #007bff; font-size: 12px; cursor: pointer; padding: 5px; margin: 0; width: auto; display: inline-flex; align-items: center; gap: 3px; }
        
        .user-item { display: flex; align-items: center; padding: 10px; border-bottom: 1px solid #eee; }
        .user-item img { width: 40px; height: 40px; border-radius: 50%; margin-right: 10px; object-fit: cover; }
        .user-item.bright-blue { background-color: #007bff; color: white; border-radius: 5px; }
        
        #live-video-element { width: 100%; height: 350px; background: #000; border-radius: 8px; object-fit: cover; }
        .hidden-input { display: none; }
        .hidden { display: none; }
        
        /* Admin Indicators */
        .banned-text { color: black !important; font-weight: bold; }
        .open-text { color: #007bff !important; font-weight: bold; }
        .banned-indicator { border: 2px solid black; background: #eee; }
    </style>
</head>
<body>

    <!-- Header -->
    <div class="top-header">
        <img src="eagle_image.jpg" class="header-icon-img" alt="Eagle">
        <div class="marquee-container-top"><span class="marquee-text-top" id="head-txt">·ä•·äï·ä≥·äï ·ãà·ã∞ ·çã·à≤·àç ·ãå·â• ·ä†·çï ·ã®·ä†·åà·àç·åç·àé·âµ ·àõ·ãï·ä®·àç ·â†·ã∞·àÖ·äì ·àò·å°!</span></div>
        <div style="text-align: right; display: flex; flex-direction: column; align-items: center;">
            <img src="lion_image.jpg" class="header-icon-img" alt="Lion">
            <button class="lang-btn" onclick="toggleLanguage()" id="lang-btn-txt">Language</button>
        </div>
    </div>

    <div class="container">

        <!-- Modals -->
        <div class="modal-overlay" id="custom-modal"><div class="modal-box"><h3 id="modal-title"></h3><p id="modal-msg"></p><button class="btn-blue" onclick="closeModal()">OK</button></div></div>
        
        <div class="modal-overlay" id="pass-modal"><div class="modal-box"><h3 id="pass-title">Password Required</h3><input type="password" id="pass-input" placeholder="Password" style="text-align:center;"><button class="btn-green" onclick="verifyPass()">Confirm</button><button class="btn-red" onclick="document.getElementById('pass-modal').style.display='none'">Cancel</button></div></div>

        <!-- Admin Action Password Modal -->
        <div class="modal-overlay" id="admin-action-modal"><div class="modal-box"><h3>Admin Verification</h3><input type="password" id="admin-act-pass" placeholder="Admin Code"><button class="btn-green" onclick="runAdminAction()">Verify</button><button class="btn-red" onclick="document.getElementById('admin-action-modal').style.display='none'">Cancel</button></div></div>

        <!-- Admin Change Pass Modal -->
        <div class="modal-overlay" id="admin-chg-modal"><div class="modal-box"><h3>Change Admin Password</h3>
            <input type="password" id="old-adm" placeholder="Old Admin Code">
            <input type="password" id="new-adm" placeholder="New (abc123456xyz)">
            <input type="password" id="conf-adm" placeholder="Confirm New">
            <button class="btn-green" onclick="saveNewAdminPass()">Change</button>
            <button class="btn-red" onclick="document.getElementById('admin-chg-modal').style.display='none'">Cancel</button>
        </div></div>

        <!-- Admin Premium Pay Modal -->
        <div class="modal-overlay" id="adm-prem-modal"><div class="modal-box"><h3>Premium Payment Receiver</h3>
            <button class="btn-blue" onclick="alert('PayPal/Intl Payment Gateway Open')">1. International (PayPal)</button>
            <button class="btn-green" onclick="alert('Local Method 1 Gateway Open')">2. Local Bank 1</button>
            <button class="btn-green" onclick="alert('Local Method 2 Gateway Open')">3. Local Bank 2</button>
            <button class="btn-red" onclick="document.getElementById('adm-prem-modal').style.display='none'">Close</button>
        </div></div>

        <!-- Comment Action Modal -->
        <div class="modal-overlay" id="comment-type-modal"><div class="modal-box"><h3 id="t-com-act">Action</h3>
            <button class="btn-blue" onclick="openComSub('give')">Give Comment</button>
            <button class="btn-blue" onclick="openComSub('view')">View Comments</button>
            <button class="btn-red" onclick="document.getElementById('comment-type-modal').style.display='none'">Cancel</button>
        </div></div>

        <!-- Give/View Sub Modal -->
        <div class="modal-overlay" id="comment-media-modal"><div class="modal-box"><h3 id="t-com-media">Select Type</h3>
            <button class="btn-blue" onclick="processComment('text')">Text</button>
            <button class="btn-blue" onclick="processComment('image')">Image</button>
            <button class="btn-blue" onclick="processComment('video')">Video</button>
            <button class="btn-blue" onclick="processComment('audio')">Voice</button>
            <button class="btn-red" onclick="document.getElementById('comment-media-modal').style.display='none'">Cancel</button>
        </div></div>

        <!-- View Comments List Modal -->
        <div class="modal-overlay" id="view-comments-list-modal"><div class="modal-box"><h3>Comments</h3><div id="comments-display-area" style="text-align:left; max-height:300px; overflow-y:auto;"></div><button class="btn-red" onclick="document.getElementById('view-comments-list-modal').style.display='none'">Close</button></div></div>

        <!-- Share Modal -->
        <div class="modal-overlay" id="share-modal"><div class="modal-box"><h3>Share To</h3>
            <button class="btn-blue" onclick="shareTo('telegram')">Telegram</button>
            <button class="btn-blue" onclick="shareTo('facebook')">Facebook</button>
            <button class="btn-blue" onclick="shareTo('tiktok')">TikTok</button>
            <button class="btn-blue" onclick="shareTo('youtube')">YouTube</button>
            <button class="btn-red" onclick="closeShare()">Close</button>
        </div></div>

        <div class="modal-overlay" id="admin-login-modal"><div class="modal-box"><h3>Admin Login</h3><input type="password" id="admin-pass-in" placeholder="Code (abc123456abd)"><button class="btn-green" onclick="adminLogin()">Enter</button><button class="btn-red" onclick="document.getElementById('admin-login-modal').style.display='none'">Cancel</button></div></div>

        <!-- Receipt Modal -->
        <div class="modal-overlay" id="receipt-modal"><div class="modal-box"><h3>Payment Receipt</h3>
            <p>Receipt Uploaded Successfully.</p>
            <div id="receipt-actions">
                <button class="btn-blue" onclick="downloadReceipt()">Save Receipt to Phone</button>
                <button class="btn-green" onclick="closeReceiptModal()">Receive Receipt (OK)</button>
            </div>
        </div></div>

        <!-- 1. AGREEMENT & WELCOME -->
        <div id="view-agreement" class="section show">
            <div id="welcome-content">
                <div class="split-container">
                    <div class="split-left">
                        <h4 id="t-w-s">·ä•·äï·ä≥·äï ·ã∞·àÖ·äì ·àò·å°</h4>
                        <p id="t-in">·ã≠·àÖ ·ã®·çã·à≤·àç ·ãå·â• ·ä†·çï ·â†·â∞·ä†·àõ·äí·äê·âµ ·ä•·äï·ã≤·à∞·à´ ·ã®·â∞·âÄ·ã®·à∞ ·ã≤·åÇ·â≥·àç ·àò·à®·åÉ ·àò·åã·à™·ã´ ·äê·ãç·ç¢ ·àÅ·àå·àù ·âµ·ä≠·ä≠·àà·äõ ·àò·à®·åÉ·ãé·âΩ·äï ·ã´·âÄ·à≠·â£·àç·ç¢</p>
                    </div>
                    <div class="split-right">
                        <h4 id="t-p-s">·å•·â•·âÖ ·àò·àò·à™·ã´</h4>
                        <p id="t-po">·çñ·àà·â≤·ä´·ç£ ·å•·àã·âª·ç£ ·ãò·à®·äù·äê·âµ ·ä•·äì ·àÄ·à∞·â∞·äõ ·àò·à®·åÉ ·àõ·âÖ·à®·â• ·â†·å•·â•·âÖ ·ã®·â∞·ä®·àà·ä®·àà ·äê·ãç·ç¢</p>
                    </div>
                </div>
                <div style="display: flex; gap: 10px; margin-top: 5px; justify-content: center;">
                    <button class="btn-green btn-tiny" onclick="handleAgree()" id="btn-agree">·ä•·àµ·àõ·àõ·àà·àÅ</button>
                    <button class="btn-red btn-tiny" onclick="showAlert('·ä†·àç·â∞·àµ·àõ·àô·àù', 'error')" id="btn-disagree">·ä†·àç·àµ·àõ·àõ·àù</button>
                </div>
                <div class="blue-spacer"></div>
                
                <!-- NEW BRANDING LOGO AREA -->
                <div class="brand-area">
                    <!-- Left: Eagle in Blue Circle -->
                    <img src="eagle_image.jpg" class="side-logo" alt="Eagle">
                    
                    <!-- Complex Logo Construction -->
                    <div class="complex-logo">
                        <div class="ring ring-blue">
                             <div class="ring ring-red">
                                 <!-- Lions on Red Ring -->
                                 <img src="lion_image.jpg" class="pos-item p-n" alt="L">
                                 <img src="lion_image.jpg" class="pos-item p-s" alt="L">
                                 <img src="lion_image.jpg" class="pos-item p-e" alt="L">
                                 <img src="lion_image.jpg" class="pos-item p-w" alt="L">
                                 <!-- Doves on Red Ring -->
                                 <img src="dove_image.jpg" class="pos-item p-ne" alt="D">
                                 <img src="dove_image.jpg" class="pos-item p-nw" alt="D">
                                 <img src="dove_image.jpg" class="pos-item p-se" alt="D">
                                 <img src="dove_image.jpg" class="pos-item p-sw" alt="D">
                                 
                                 <div class="ring ring-yellow">
                                     <!-- Eagles on Yellow Ring -->
                                     <img src="eagle_image.jpg" class="pos-item p-n" alt="E">
                                     <img src="eagle_image.jpg" class="pos-item p-s" alt="E">
                                     <img src="eagle_image.jpg" class="pos-item p-e" alt="E">
                                     <img src="eagle_image.jpg" class="pos-item p-w" alt="E">
                                     
                                     <div class="ring ring-green">
                                         <div class="flash-light"></div>
                                         <img src="dove_image.jpg" class="center-dove" alt="Dove">
                                         <!-- BIG LION IN CENTER -->
                                         <img src="lion_image.jpg" class="center-lion" alt="Center Lion">
                                     </div>
                                 </div>
                             </div>
                        </div>
                    </div>
                    
                    <!-- Right: Dove in Blue Circle -->
                    <img src="dove_image.jpg" class="side-logo" alt="Dove">
                </div>

            </div>
            <div id="auth-section" style="display:none;">
                <p style="color: green; font-weight: bold; font-size: 14px;" id="t-thx">·ä†·åà·àç·åç·àé·â≥·âΩ·äï·äï ·àµ·àà·àò·à®·å° ·ä•·äì·àò·à∞·åç·äì·àà·äï! ·ä†·ã≤·àµ ·ä®·àÜ·äë ·ã≠·àò·ãù·åà·â°·ç£ ·ä´·àà·ãé·âµ ·ã≠·åç·â°·ç¢</p>
                <div style="display:flex; gap:10px;"><button class="btn-red" onclick="showAuth('signup')" id="btn-sh-s">·àò·àò·ãù·åà·â¢·ã´</button><button class="btn-red" onclick="showAuth('login')" id="btn-sh-l">·àò·åç·â¢·ã´</button></div>
                
                <div id="form-signup" style="display:none; margin-top:10px; border: 1px solid #dc3545; padding: 10px; border-radius: 5px;">
                    <div id="signup-step-1">
                        <h3 style="color:#dc3545;" id="h-s">·àù·ãù·åà·â£ (·ä†·ã≤·àµ ·â•·âª)</h3>
                        <input type="text" id="reg-name" placeholder="Full Name">
                        <input type="text" id="reg-phone" placeholder="Phone (09... 10 digits)">
                        <input type="email" id="reg-email" placeholder="Email (@gmail.com only)">
                        <input type="password" id="reg-pass" placeholder="Password (6 digits)">
                        <button class="btn-green" onclick="preSignup()">Submit</button>
                    </div>
                    <div id="signup-step-2" style="display:none;">
                        <h3>Upload Profile Photo</h3>
                        <button class="btn-blue" onclick="promptUpload('profile')">Upload Photo</button>
                        <input type="file" id="file-profile" class="hidden-input" accept="image/*">
                        <button class="btn-green" onclick="finalSignup()">Complete Registration</button>
                    </div>
                </div>

                <div id="form-login" style="display:none; margin-top:10px; border: 1px solid #dc3545; padding: 10px; border-radius: 5px;">
                    <h3 style="color:#dc3545;" id="h-l">·àò·åç·â¢·ã´ (·äê·â£·à≠)</h3>
                    <input type="text" id="log-phone" placeholder="Phone">
                    <input type="password" id="log-pass" placeholder="Password">
                    <button class="btn-blue" onclick="doLogin()">Login</button>
                </div>
            </div>
        </div>

        <!-- 2. MAIN DASHBOARD -->
        <div id="view-home" class="section">
            <div style="display:flex; align-items:center; border-bottom:1px solid #ddd; padding-bottom:5px;">
                <img src="eagle_image.jpg" class="eagle-dash-img"><h2 id="t-d" style="margin:0;">·ã≥·àΩ·â¶·à≠·ãµ</h2>
            </div>
            <div class="dash-layout" style="margin-top:10px;">
                <div class="dash-left">
                    <button class="btn-green" style="border-radius: 0;" id="btn-fc" onclick="toggleList('free')">·ã®·äê·çÉ ·ä†·åà·àç·åç·àé·âµ ·àõ·ãï·ä®·àç</button>
                    <div id="list-free" style="display:none; padding-left: 10px;">
                        <button class="btn-green btn-small" onclick="navTo('view-info')" id="btn-lv">·àò·à®·åÉ ·àò·àò·àç·ä®·âµ</button>
                        <button class="btn-green btn-small" onclick="navTo('post-info')" id="btn-lp">·àò·à®·åÉ ·àò·àà·å†·çç</button>
                        <button class="btn-green btn-small" onclick="handleGroupCreate()" id="btn-lg">·åç·à©·çï ·àò·çç·å†·à≠</button>
                        <button class="btn-green btn-small" onclick="showMyGroups()" id="btn-lmg">·ã®·çà·å†·à©·âµ·äï ·åç·à©·çï ·àà·àò·àò·àç·ä®·âµ</button>
                        <button class="btn-green btn-small" onclick="handleChatList()" id="btn-lc">·âª·âµ</button>
                        <button class="btn-green btn-small" onclick="navTo('feedback-sec')" id="btn-lf">·àà·çã·à≤·àç ·ãå·â• ·ä†·çï ·çà·å£·à™ ·ä†·àµ·â∞·ã´·ã®·âµ ·àà·àò·àµ·å†·âµ ·ä•·äì ·àà·àò·àò·àç·ä®·âµ</button>
                        <button class="btn-green btn-small" onclick="showUserList(false)" id="btn-lu">·â∞·å†·âÉ·àö·ãé·âΩ</button>
                        <button class="btn-green btn-small" onclick="checkAuth('business-sec')" id="btn-lb">·â¢·ãù·äê·àµ</button>
                        <button class="btn-green btn-small" style="background-color:#333;" onclick="checkAuth('report-inbox')" id="btn-admin-rep">·à™·çñ·à≠·âµ ·àò·âÄ·â†·ã´ (Admin)</button>
                    </div>
                    <button class="btn-yellow" style="border-radius: 0; margin-top: 10px;" id="btn-pc" onclick="toggleList('prem')">·ã®·ä≠·çç·ã´ ·çï·à™·àö·ã®·àù ·ä†·åà·àç·åç·àé·âµ</button>
                    <div id="list-prem" style="display:none; padding-left: 10px;">
                        <!-- Premium buttons now lead to Premium feed -->
                        <button class="btn-yellow btn-small" onclick="navTo('view-info'); alert('Premium Video Feed (High Quality)')">·å•·à´·âµ ·ã´·àà·ãç ·â™·ã≤·ãÆ</button>
                        <button class="btn-yellow btn-small" onclick="navTo('view-info'); alert('Premium News Feed')">·ãú·äì (High Quality)</button>
                        <button class="btn-yellow btn-small" onclick="navTo('view-info'); alert('Premium Image Feed')">·àù·àµ·àç (High Quality)</button>
                        <button class="btn-yellow btn-small" onclick="openPrem('ppt')" id="btn-pp">PowerPoint</button>
                        <button class="btn-yellow btn-small" onclick="openPrem('pdf')" id="btn-ppdf">PDF</button>
                    </div>
                </div>
                <div class="dash-right"><img src="lion_image.jpg" class="lion-full-img"></div>
            </div>
            <button class="btn-red" style="margin-top:20px;" onclick="doLogout()" id="btn-out">·ãç·å£</button>
        </div>

        <!-- 3. SECTIONS -->

        <!-- Post -->
        <div id="post-info" class="section">
            <h3 id="t-ph">·àò·à®·åÉ ·àò·àà·å†·çç</h3>
            <div id="post-type-select">
                <button class="btn-blue" onclick="setupPost('text')" id="btn-pt">üìù Text</button>
                <button class="btn-blue" onclick="setupPost('image')" id="btn-pi">üì∑ Image</button>
                <button class="btn-blue" onclick="setupPost('video')" id="btn-pv">üé• Video</button>
                <button class="btn-blue" onclick="setupPost('audio')" id="btn-pa">üéôÔ∏è Audio</button>
            </div>
            <div id="post-form-area" style="display:none; border-top:1px solid #ccc; margin-top:10px; padding-top:10px;">
                <p id="post-instr" style="color:blue; font-size:12px;"></p>
                <div style="display:flex; gap:5px;">
                     <input type="text" id="p-title" placeholder="Title (Required)">
                     <button class="btn-red btn-tiny" onclick="clearPostForm()">·ä†·çÖ·ã≥ (Clear)</button>
                </div>
                <textarea id="p-content" placeholder="Details (Text Only)..." style="display:none;"></textarea>
                <input type="file" id="file-post" class="hidden-input">
                <button class="btn-green" onclick="submitPost()" id="btn-pnow">Post Now</button>
            </div>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk1">Back</button>
        </div>

        <!-- View -->
        <div id="view-info" class="section">
            <h3 id="t-vh">·àò·à®·åÉ ·àò·àò·àç·ä®·âµ</h3>
            <div style="display:flex; gap:5px;">
                <button class="btn-blue btn-small" onclick="renderPosts('text')" id="btn-vt">Text</button>
                <button class="btn-blue btn-small" onclick="renderPosts('image')" id="btn-vi">Image</button>
                <button class="btn-blue btn-small" onclick="renderPosts('video')" id="btn-vv">Video</button>
                <button class="btn-blue btn-small" onclick="renderPosts('audio')" id="btn-va">Audio</button>
            </div>
            <div id="feed-container" style="margin-top:10px;"></div>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk2">Back</button>
        </div>

        <!-- Admin Report Inbox -->
        <div id="report-inbox" class="section">
            <h3>·à™·çñ·à≠·âµ ·àò·âÄ·â†·ã´ (Admin)</h3>
            <div style="margin-bottom:10px; display:flex; flex-direction:column; gap:5px;">
                <button class="btn-blue btn-small" onclick="promptAdminAction('changePass')">1. Change Admin Pass</button>
                <button class="btn-blue btn-small" onclick="promptAdminAction('userStats')">2. User Activity Monitor</button>
                <button class="btn-green btn-small" onclick="promptAdminAction('premPay')">3. Premium Payment Receiver</button>
                <button class="btn-red btn-small" onclick="promptAdminAction('viewRep')">4. Receive Reports (Ban/Unban)</button>
            </div>
            <!-- Container for dynamic admin content -->
            <div id="admin-dynamic-content" style="text-align:left; margin-top:10px;"></div>
            <button class="btn-red btn-small" onclick="goBack()">Back</button>
        </div>

        <!-- Business -->
        <div id="business-sec" class="section">
            <h3 id="t-bh">·â¢·ãù·äê·àµ ·àõ·ãï·ä®·àç</h3>
            <div style="background:#f9f9f9; padding:10px; border:1px solid #ddd;">
                <p>USD: <b id="bal-usd">0.00</b> | GBP: <b id="bal-gbp" style="color:red;">0.00</b> | EUR: <b id="bal-eur" style="color:blue;">0.00</b></p>
                <p>ETB: <b id="bal-etb" style="color:green;">0.00</b></p>
                <hr>
                <p style="color:green; font-weight:bold;">Total (USD): <span id="bal-total">0.00</span></p>
                <p style="color:red; font-weight:bold;">Total (ETB): <span id="bal-total-etb">0.00</span></p>
            </div>
            <button class="btn-green" onclick="navTo('deposit-sec')" id="btn-bd">Deposit</button>
            <button class="btn-blue" onclick="navTo('withdraw-sec')" id="btn-bw">Withdraw</button>
            <button class="btn-yellow" onclick="navTo('intl-sec')" id="btn-bi">International Purchase</button>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk3">Back</button>
        </div>

        <!-- Deposit -->
        <div id="deposit-sec" class="section">
            <h3 id="t-dep-h">Deposit</h3>
            <div id="dep-step-1">
                <input type="number" id="dep-amt" placeholder="Amount (ETB)">
                <select id="dep-cur"><option value="ETB">ETB</option><option value="USD">USD</option><option value="GBP">GBP</option><option value="EUR">EUR</option></select>
                <button class="btn-green" onclick="preDeposit()">Submit</button>
            </div>
            <div id="dep-step-2" class="hidden">
                <button class="btn-blue" onclick="promptUpload('deposit')">Upload Receipt</button>
                <input type="file" id="file-deposit" class="hidden-input">
            </div>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk4">Back</button>
        </div>

        <!-- Withdraw -->
        <div id="withdraw-sec" class="section">
            <h3 id="t-with-h">Withdraw</h3>
            <select id="w-cur"><option value="USD">From USD</option><option value="GBP">From GBP</option><option value="EUR">From EUR</option><option value="ETB">From ETB</option></select>
            <select id="w-method" onchange="toggleReceiverInput()"><option value="Telebirr">Telebirr</option><option value="CBE">CBE</option><option value="PayPal">PayPal</option></select>
            <!-- Telebirr specific styling -->
            <input type="text" id="w-dest" placeholder="Phone/Account" style="display:none; margin-bottom: 2px; font-size: 13px;">
            <input type="number" id="w-amt" placeholder="Amount">
            
            <button class="btn-compact btn-blue" onclick="reqWithdraw()" id="btn-sub-with">Withdraw</button>
            <button class="btn-compact btn-red" onclick="goBack()" id="btn-bk5">Back</button>
        </div>

        <!-- Intl Purchase -->
        <div id="intl-sec" class="section">
            <h3 id="t-intl-h">International Purchase</h3>
            <button class="btn-blue" onclick="document.getElementById('intl-list').style.display='block'">·àù·à®·å• (Select)</button>
            <div id="intl-list" class="hidden" style="margin-top:10px;">
                <p>Select Service to Pay:</p>
                <div style="display:flex; flex-direction:column; gap:5px;">
                    <button class="btn-blue btn-small" onclick="triggerIntlPay('ChatGPT')">1. ChatGPT</button>
                    <button class="btn-blue btn-small" onclick="triggerIntlPay('Amazon')">2. Amazon</button>
                    <button class="btn-blue btn-small" onclick="triggerIntlPay('Hosting')">3. Hosting</button>
                    <button class="btn-blue btn-small" onclick="triggerIntlPay('Domain')">4. Domain</button>
                    <button class="btn-blue btn-small" onclick="triggerIntlPay('Netflix')">5. Netflix</button>
                </div>
                <input type="file" id="file-intl" class="hidden-input">
            </div>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk6">Back</button>
        </div>

        <!-- Premium Pay -->
        <div id="prem-pricing" class="section">
            <h3 id="t-pay-h">Payment</h3>
            <button class="btn-green" onclick="pay(5)">Daily (5 ETB)</button>
            <button class="btn-green" onclick="pay(25)">Weekly (25 ETB)</button>
            <button class="btn-green" onclick="pay(30)">Monthly (30 ETB)</button>
            <div id="pay-up-area" style="display:none;">
                <button class="btn-blue" onclick="promptUpload('pay')">Upload Receipt</button>
                <input type="file" id="file-pay" class="hidden-input">
                <button class="btn-green" onclick="finPay()">Confirm</button>
            </div>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk7">Back</button>
        </div>

        <!-- Feedback -->
        <div id="feedback-sec" class="section">
            <h3 id="t-fh">Feedback</h3>
            <p id="t-fb-sub">·àà·çã·à≤·àç ·ãå·â• ·ä†·çï ·çà·å£·à™ ·ä†·àµ·â∞·ã´·ã®·âµ ·àà·àò·àµ·å†·âµ</p>
            <button class="btn-blue" onclick="giveFb('text')" id="btn-fb-txt">Text</button>
            <button class="btn-yellow" onclick="openLiveCamera()" id="btn-fb-live">Live</button>
            <hr>
            <button class="btn-blue" onclick="viewFbs()" id="btn-view-fb">View Feedbacks</button>
            <div id="fb-list"></div>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk8">Back</button>
        </div>

        <!-- Chat / Group -->
        <div id="chat-sec" class="section">
            <h3 id="t-chat-h">Chat</h3>
            <div id="chat-box" style="height:200px; overflow-y:auto; border:1px solid #ddd; margin-bottom:5px;"></div>
            <input type="text" id="chat-in" placeholder="Message">
            <div style="display:flex; gap:5px; margin-top:5px;">
                <button class="btn-blue btn-small" onclick="sendChat('text')">Send</button>
                <button class="btn-yellow btn-small" onclick="promptUpload('chat-img')">üì∑</button>
                <button class="btn-yellow btn-small" onclick="promptUpload('chat-vid')">üé•</button>
                <button class="btn-yellow btn-small" onclick="promptUpload('chat-aud')">üéôÔ∏è</button>
                <button class="btn-red btn-small" onclick="openLiveCamera()">üî¥</button>
            </div>
            <input type="file" id="file-chat" class="hidden-input">
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk9">Back</button>
        </div>

        <!-- User List (Read Only) -->
        <div id="user-list-sec" class="section">
            <h3 id="t-users-h">Users</h3>
            <div id="ul-cont"></div>
            <button class="btn-green" id="btn-grp-done" style="display:none;" onclick="createGroup()">Done (5+)</button>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk10">Back</button>
        </div>

        <!-- My Groups -->
        <div id="my-groups-sec" class="section">
            <h3 id="t-mygrp-h">My Groups</h3>
            <div id="grp-list"></div>
            <button class="btn-red btn-small" onclick="goBack()" id="btn-bk11">Back</button>
        </div>

        <!-- Live View (Real Camera) -->
        <div id="view-live" class="section">
            <h2 id="t-live">·âÄ·å•·â≥ ·àµ·à≠·å≠·âµ (Live)</h2>
            <video id="live-video-element" autoplay playsinline></video>
            <button class="btn-red" onclick="stopLive()">Stop Live</button>
        </div>

        <!-- Profile -->
        <div id="view-profile" class="section">
            <h2 id="t-prof">·ã®·åç·àç ·àõ·ãï·ä®·àç</h2>
            <div style="text-align:left;">
                <p>Phone: <b id="prof-phone"></b> (Disabled)</p>
                <h4 id="t-edit-prof">Edit Profile</h4>
                <input type="text" id="prof-name-edit" placeholder="Name">
                <input type="password" id="old-pass" placeholder="Old Password">
                <input type="password" id="new-pass" placeholder="New Password">
                <input type="password" id="conf-pass" placeholder="Confirm Password">
                <button class="btn-blue" onclick="promptUpload('profile-edit')" id="btn-chg-pic">Change Photo</button>
                <input type="file" id="file-profile-edit" class="hidden-input" accept="image/*">
                <button class="btn-green" onclick="saveProfile()" id="btn-up-prof">Update</button>
            </div>
            <button class="btn-red" style="margin-top:10px;" onclick="doLogout()" id="btn-prof-out">Logout</button>
        </div>

    </div>

    <!-- Hidden Input for Comments -->
    <input type="file" id="comment-file-input" class="hidden-input">
    <input type="file" id="universal-file" class="hidden-input">

    <!-- Footer Wrapper with Marquee Below -->
    <div class="footer-wrapper">
        <div class="bottom-nav">
            <button class="nav-btn nav-home" onclick="navTab('home')"><i class="fas fa-home"></i> <span id="nav-h">Home</span></button>
            <button class="nav-btn nav-live" onclick="navTab('live')"><i class="fas fa-broadcast-tower"></i> <span id="nav-l">Live</span></button>
            <button class="nav-btn nav-profile" onclick="navTab('profile')"><i class="fas fa-user"></i> <span id="nav-p">Profile</span></button>
        </div>
        <div class="bottom-marquee">
            <span>·çã·à≤·àç ·ãå·â• ·ä†·çï - Fasil Web App (Service Center)</span>
        </div>
    </div>

    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDoc, updateDoc, deleteDoc, getDocs, query, orderBy, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAWS8PJ0kmu56hixesxV1KrMH8NRciH6U0",
            authDomain: "fasil-web-app-3a732.firebaseapp.com",
            projectId: "fasil-web-app-3a732",
            storageBucket: "fasil-web-app-3a732.firebasestorage.app",
            messagingSenderId: "239133072986",
            appId: "1:239133072986:web:0dcbd768e1e916b9b64263"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // --- DATA ---
        let user = JSON.parse(localStorage.getItem('fg_user')) || null;
        let users = [];
        let posts = [];
        let groups = [];
        let feedbacks = [];
        let reports = [];
        let adminPass = 'abc123456abc';
        
        let lang = 'am';
        let hasAgreed = false;
        let viewHistory = [];
        let activePostType = 'text';
        let activeChat = null;
        let activeCommentPostId = null;
        let pendingAct = null;
        let uploadTarget = '';
        let liveStream = null;
        let comMode = 'view'; 
        let pendingAdminAction = null;
        let lastReceiptUrl = '';

        const RATES = {USD:120, GBP:150, EUR:130};

        // --- FIREBASE FUNCTIONS ---
        async function loadAllData() {
            try {
                // Load users
                const usersSnapshot = await getDocs(collection(db, "users"));
                users = [];
                usersSnapshot.forEach(doc => {
                    users.push({ id: doc.id, ...doc.data() });
                });

                // Load posts
                const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
                const postsSnapshot = await getDocs(postsQuery);
                posts = [];
                postsSnapshot.forEach(doc => {
                    posts.push({ id: doc.id, ...doc.data() });
                });

                // Load groups
                const groupsSnapshot = await getDocs(collection(db, "groups"));
                groups = [];
                groupsSnapshot.forEach(doc => {
                    groups.push({ id: doc.id, ...doc.data() });
                });

                // Load feedbacks
                const feedbacksSnapshot = await getDocs(collection(db, "feedbacks"));
                feedbacks = [];
                feedbacksSnapshot.forEach(doc => {
                    feedbacks.push({ id: doc.id, ...doc.data() });
                });

                // Load reports
                const reportsSnapshot = await getDocs(collection(db, "reports"));
                reports = [];
                reportsSnapshot.forEach(doc => {
                    reports.push({ id: doc.id, ...doc.data() });
                });

                // Load admin password
                const adminDoc = await getDoc(doc(db, "settings", "admin"));
                if (adminDoc.exists()) {
                    adminPass = adminDoc.data().password || 'abc123456abc';
                }

                console.log("‚úÖ All data loaded from Firebase");
                
                // Setup real-time listeners
                setupRealtimeListeners();
                
            } catch (error) {
                console.error("‚ùå Error loading data:", error);
                showAlert("·ã®·àò·à®·åÉ ·å≠·äê·âµ ·ä†·àç·â∞·à≥·ä´·àù. ·ä•·â£·ä≠·ãé ·ä•·äï·ã∞·åà·äì ·ã≠·àû·ä≠·à©", "error");
            }
        }

        function setupRealtimeListeners() {
            // Posts real-time listener
            try {
                const postsQuery = query(collection(db, "posts"), orderBy("timestamp", "desc"));
                onSnapshot(postsQuery, (snapshot) => {
                    posts = [];
                    snapshot.forEach(doc => {
                        posts.push({ id: doc.id, ...doc.data() });
                    });
                    // Refresh posts if we're on the view-info section
                    if (document.getElementById('view-info').classList.contains('show')) {
                        renderPosts(activePostType);
                    }
                });
                
                console.log("‚úÖ Real-time posts listener active");
            } catch (error) {
                console.error("‚ùå Posts listener error:", error);
            }
        }

        async function saveUser(userData) {
            try {
                const userRef = doc(db, "users", userData.phone);
                await setDoc(userRef, userData);
                console.log("‚úÖ User saved to Firebase");
                return true;
            } catch (error) {
                console.error("‚ùå Error saving user:", error);
                return false;
            }
        }

        async function savePost(postData) {
            try {
                const postRef = doc(collection(db, "posts"));
                const postWithTimestamp = {
                    ...postData,
                    timestamp: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };
                await setDoc(postRef, postWithTimestamp);
                console.log("‚úÖ Post saved to Firebase");
                return postRef.id;
            } catch (error) {
                console.error("‚ùå Error saving post:", error);
                throw error;
            }
        }

        async function updatePost(postId, updates) {
            try {
                const postRef = doc(db, "posts", postId);
                await updateDoc(postRef, updates);
                console.log("‚úÖ Post updated in Firebase");
                return true;
            } catch (error) {
                console.error("‚ùå Error updating post:", error);
                return false;
            }
        }

        async function deletePost(postId) {
            try {
                const postRef = doc(db, "posts", postId);
                await deleteDoc(postRef);
                console.log("‚úÖ Post deleted from Firebase");
                return true;
            } catch (error) {
                console.error("‚ùå Error deleting post:", error);
                return false;
            }
        }

        async function saveGroup(groupData) {
            try {
                const groupRef = doc(collection(db, "groups"));
                const groupWithTimestamp = {
                    ...groupData,
                    createdAt: new Date().toISOString()
                };
                await setDoc(groupRef, groupWithTimestamp);
                console.log("‚úÖ Group saved to Firebase");
                return groupRef.id;
            } catch (error) {
                console.error("‚ùå Error saving group:", error);
                throw error;
            }
        }

        async function updateGroup(groupId, updates) {
            try {
                const groupRef = doc(db, "groups", groupId);
                await updateDoc(groupRef, updates);
                console.log("‚úÖ Group updated in Firebase");
                return true;
            } catch (error) {
                console.error("‚ùå Error updating group:", error);
                return false;
            }
        }

        async function saveFeedback(feedbackData) {
            try {
                const feedbackRef = doc(collection(db, "feedbacks"));
                const feedbackWithTimestamp = {
                    ...feedbackData,
                    timestamp: new Date().toISOString()
                };
                await setDoc(feedbackRef, feedbackWithTimestamp);
                console.log("‚úÖ Feedback saved to Firebase");
                return true;
            } catch (error) {
                console.error("‚ùå Error saving feedback:", error);
                return false;
            }
        }

        async function saveReport(reportData) {
            try {
                const reportRef = doc(collection(db, "reports"));
                const reportWithTimestamp = {
                    ...reportData,
                    timestamp: new Date().toISOString()
                };
                await setDoc(reportRef, reportWithTimestamp);
                console.log("‚úÖ Report saved to Firebase");
                return true;
            } catch (error) {
                console.error("‚ùå Error saving report:", error);
                return false;
            }
        }

        async function updateAdminPassword(newPassword) {
            try {
                const adminRef = doc(db, "settings", "admin");
                await setDoc(adminRef, { password: newPassword }, { merge: true });
                console.log("‚úÖ Admin password updated in Firebase");
                return true;
            } catch (error) {
                console.error("‚ùå Error updating admin password:", error);
                return false;
            }
        }

        // --- TRANSLATIONS (Strict 100%) ---
        const TXT = {
            'am': {
                'head-txt':'·ä•·äï·ä≥·äï ·ãà·ã∞ ·çã·à≤·àç ·ãå·â• ·ä†·çï ·ã®·ä†·åà·àç·åç·àé·âµ ·àõ·ãï·ä®·àç ·â†·ã∞·àÖ·äì ·àò·å°!', 'lang-btn-txt':'·ä•·äï·åç·àä·ãù·äõ (English)',
                't-w-s':'·ä•·äï·ä≥·äï ·ã∞·àÖ·äì ·àò·å°', 't-in':'·ã≠·àÖ ·ã®·çã·à≤·àç ·ãå·â• ·ä†·çï ·â†·â∞·ä†·àõ·äí·äê·âµ ·ä•·äï·ã≤·à∞·à´ ·ã®·â∞·âÄ·ã®·à∞ ·ã≤·åÇ·â≥·àç ·àò·à®·åÉ ·àò·åã·à™·ã´ ·äê·ãç·ç¢ ·àÅ·àå·àù ·âµ·ä≠·ä≠·àà·äõ ·àò·à®·åÉ·ãé·âΩ·äï ·ã´·âÄ·à≠·â£·àç·ç¢ ·ä•·ãç·äê·â∞·äõ ·àò·à®·åÉ·ãà·âΩ·äï ·àò·àò·àç·ä®·âµ ·ä•·äì ·àò·åã·à´·âµ ·ã≠·âΩ·àã·àâ ·â†·â∞·å®·àõ·à™·àù ·àå·àé·âΩ ·ã®·çì·ãà·à≠ ·çñ·ã≠·äï·âµ ·ã®·â¢·ãù·äê·àµ ·ä•·äì ·çí·ã≤·ä§·çç ·ä†·åà·àç·åç·àé·â∂·âΩ·äï ·ã´·åà·äõ·àâ ·ä•·äì·àò·à∞·åç·äì·àà·äï·ç¢',
                't-p-s':'·å•·â•·âÖ ·àò·àò·à™·ã´', 't-po':'·çñ·àà·â≤·ä´·ç£ ·å•·àã·âª·ç£ ·ãò·à®·äù·äê·âµ ·ä•·äì ·àÄ·à∞·â∞·äõ ·àò·à®·åÉ ·àõ·âÖ·à®·â• ·â†·å•·â•·âÖ ·ã®·â∞·ä®·àà·ä®·àà ·äê·ãç·ç¢ ·çñ·àä·à≤·ã´·âΩ·äï ·å•·à∞·ãç ·ä®·â∞·åà·äô ·â†·å•·â•·âÖ ·ã®·à≤·àµ·â∞·àù ·âÅ·å•·å•·à´·âΩ·äï ·ä•·äì ·â†·å•·â•·âÖ ·à≤·àµ·â∞·àõ·âΩ·äï ·â†·à´·àµ ·à∞·à≠ ·ä®·ä†·åà·àç·åç·àé·â≥·âΩ·äï ·à≤·àµ·â∞·àù ·àä·ã´·åç·ãµ·ãà·âµ ·ã≠·âΩ·àã·àç·ç¢',
                'btn-agree':'·ä•·àµ·àõ·àõ·àà·àÅ', 'btn-disagree':'·ä†·àç·àµ·àõ·àõ·àù',
                't-thx':'·ä†·åà·àç·åç·àé·â≥·âΩ·äï·äï ·àµ·àà·àò·à®·å° ·ä•·äì·àò·à∞·åç·äì·àà·äï! ·ä†·ã≤·àµ ·ä®·àÜ·äë ·ã≠·àò·ãù·åà·â°·ç£ ·ä´·àà·ãé·âµ ·ã≠·åç·â°·ç¢',
                'btn-sh-s':'·àò·àò·ãù·åà·â¢·ã´', 'btn-sh-l':'·àò·åç·â¢·ã´', 'h-s':'·àù·ãù·åà·â£', 'h-l':'·àò·åç·â¢·ã´',
                't-d':'·ã≥·àΩ·â¶·à≠·ãµ', 'btn-fc':'·ã®·äê·çÉ ·ä†·åà·àç·åç·àé·âµ ·àõ·ãï·ä®·àç', 'btn-pc':'·ã®·ä≠·çç·ã´ ·çï·à™·àö·ã®·àù ·ä†·åà·àç·åç·àé·âµ', 'btn-out':'·ãç·å£', 
                'btn-lv':'·àò·à®·åÉ ·àò·àò·àç·ä®·âµ', 'btn-lp':'·àò·à®·åÉ ·àò·àà·å†·çç', 'btn-lg':'·åç·à©·çï ·àò·çç·å†·à≠', 'btn-lmg':'·ã®·çà·å†·à©·âµ·äï ·åç·à©·çï',
                'btn-lc':'·âª·âµ', 'btn-lf':'·àà·çã·à≤·àç ·ãå·â• ·ä†·çï ·çà·å£·à™ ·ä†·àµ·â∞·ã´·ã®·âµ ·àà·àò·àµ·å†·âµ ·ä•·äì ·àà·àò·àò·àç·ä®·âµ', 'btn-lu':'·â∞·å†·âÉ·àö·ãé·âΩ', 'btn-lb':'·â¢·ãù·äê·àµ', 'btn-admin-rep':'·à™·çñ·à≠·âµ ·àò·âÄ·â†·ã´ (Admin)',
                'btn-pv':'·å•·à´·âµ ·â™·ã≤·ãÆ', 'btn-pn':'·ãú·äì', 'btn-pp':'PowerPoint', 'btn-ppdf':'PDF',
                't-ph':'·àò·à®·åÉ ·àò·àà·å†·çç', 't-vh':'·àò·à®·åÉ ·àò·àò·àç·ä®·âµ', 't-bh':'·â¢·ãù·äê·àµ ·àõ·ãï·ä®·àç', 't-dep-h':'·åà·äï·ãò·â• ·àõ·àµ·åà·â£·âµ',
                't-with-h':'·åà·äï·ãò·â• ·àõ·ãç·å£·âµ', 't-intl-h':'·ãì·àà·àù ·ä†·âÄ·çç ·åç·ã¢', 't-pay-h':'·ä≠·çç·ã´', 't-fb-h':'·ä†·àµ·â∞·ã´·ã®·âµ',
                't-chat-h':'·âª·âµ', 't-users-h':'·â∞·å†·âÉ·àö·ãé·âΩ', 't-mygrp-h':'·åç·à©·çñ·âΩ', 't-live':'·âÄ·å•·â≥ ·àµ·à≠·å≠·âµ', 't-prof':'·ã®·åç·àç ·àõ·ãï·ä®·àç',
                'nav-h':'·ãã·äì', 'nav-l':'·àã·ã≠·â≠', 'nav-p':'·çï·àÆ·çã·ã≠·àç', 'btn-back-1':'·â∞·àò·àà·àµ', 'btn-select':'·àù·à®·å•',
                'btn-p-txt':'üìù ·çÖ·àÅ·çç', 'btn-p-img':'üì∑ ·àù·àµ·àç', 'btn-p-vid':'üé• ·â™·ã≤·ãÆ', 'btn-p-aud':'üéôÔ∏è ·ãµ·àù·çÖ',
                'btn-v-txt':'·çÖ·àÅ·çç', 'btn-v-img':'·àù·àµ·àç', 'btn-v-vid':'·â™·ã≤·ãÆ', 'btn-v-aud':'·ãµ·àù·çÖ',
                'btn-post-now':'·àà·å•·çç', 'btn-dep':'·åà·äï·ãò·â• ·ä†·àµ·åà·â£', 'btn-with':'·åà·äï·ãò·â• ·ä†·ãç·å£', 'btn-intl':'·ä†·àà·àù ·ä†·âÄ·çç ·åç·ã¢',
                't-edit-prof':'·çï·àÆ·çã·ã≠·àç ·àò·âÄ·ã®·à≠', 'btn-chg-pic':'·çé·â∂ ·âÄ·ã≠·à≠', 'btn-up-prof':'·ä†·ãò·àù·äï (Update)', 'btn-prof-out':'·ãç·å£',
                't-fb-sub':'·àà·ä†·ãµ·àö·äï (Text / Live)', 'btn-fb-txt':'·â†·çÖ·àÅ·çç', 'btn-fb-live':'·àã·ã≠·â≠', 'btn-view-fb':'·ä†·àµ·â∞·ã´·ã®·âµ ·ã≠·àò·àç·ä®·â±',
                't-choose-com':'·äÆ·àò·äï·âµ ·ä†·ã≠·äê·âµ ·ã≠·àù·à®·å°', 't-post-instr':'·ä†·â£·ä≠·ãé ·àò·à®·åÉ·ãç·äï ·ã≠·çÉ·çâ', 't-com-act':'·ä†·àõ·à´·å≠', 't-com-media':'·ä†·ã≠·äê·âµ ·ã≠·àù·à®·å°'
            },
            'en': {
                'head-txt':'Welcome to Fasil Web App Service Center!', 'lang-btn-txt':'Amharic (·ä†·àõ·à≠·äõ)',
                't-w-s':'Welcome', 't-in':'Fasil Web App is a reliable digital sharing platform. You can share real information and access PPT/PDF services.',
                't-p-s':'Strict Policy', 't-po':'Political conflict, hatred, racism, and fake news are strictly prohibited. Violators will be automatically banned by our AI system.',
                'btn-agree':'I Agree', 'btn-disagree':'Disagree',
                't-thx':'Thank you! Register or Login.', 'btn-sh-s':'Signup', 'btn-sh-l':'Login', 'h-s':'Register', 'h-l':'Login',
                't-d':'Dashboard', 'btn-fc':'Free Services', 'btn-pc':'Premium Services', 'btn-out':'Logout',
                'btn-lv':'View Info', 'btn-lp':'Post Info', 'btn-lg':'Create Group', 'btn-lmg':'My Groups',
                'btn-lc':'Chat', 'btn-lf':'Feedback to Creator', 'btn-lu':'Users', 'btn-lb':'Business', 'btn-admin-rep':'Report Inbox',
                'btn-pv':'HD Video', 'btn-pn':'News', 'btn-pp':'PPT', 'btn-ppdf':'PDF',
                't-ph':'Post Info', 't-vh':'View Info', 't-bh':'Business Center', 't-dep-h':'Deposit',
                't-with-h':'Withdraw', 't-intl-h':'Intl Purchase', 't-pay-h':'Payment', 't-fb-h':'Feedback',
                't-chat-h':'Chat', 't-users-h':'Users', 't-mygrp-h':'My Groups', 't-live':'Live Stream', 't-prof':'Profile',
                'nav-h':'Home', 'nav-l':'Live', 'nav-p':'Profile', 'btn-back-1':'Back', 'btn-select':'Select',
                'btn-p-txt':'üìù Text', 'btn-p-img':'üì∑ Image', 'btn-p-vid':'üé• Video', 'btn-p-aud':'üéôÔ∏è Audio',
                'btn-v-txt':'Text', 'btn-v-img':'Image', 'btn-v-vid':'Video', 'btn-v-aud':'Audio',
                'btn-post-now':'Post', 'btn-dep':'Deposit', 'btn-with':'Withdraw', 'btn-intl':'Intl Purchase',
                't-edit-prof':'Edit Profile', 'btn-chg-pic':'Change Photo', 'btn-up-prof':'Update', 'btn-prof-out':'Logout',
                't-fb-sub':'To Admin (Text / Live)', 'btn-fb-txt':'Text', 'btn-fb-live':'Live', 'btn-view-fb':'View Feedbacks',
                't-choose-com':'Choose Comment Type', 't-post-instr':'Please enter content details', 't-com-act':'Action', 't-com-media':'Select Type'
            }
        };

        // --- CORE FUNCTIONS ---
        function toggleLanguage() {
            lang = lang==='am'?'en':'am';
            const t = TXT[lang];
            for(let k in t) { 
                if(document.getElementById(k)) {
                    document.getElementById(k).innerText = t[k];
                }
            }
            // Update language button text
            document.getElementById('lang-btn-txt').innerText = lang==='am'?'·ä•·äï·åç·àä·ãù·äõ (English)':'Amharic (·ä†·àõ·à≠·äõ)';
        }
        
        function showView(id) {
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('show'));
            document.getElementById(id).classList.add('show');
        }
        
        function navTo(id) {
            const current = document.querySelector('.section.show');
            if(current && current.id !== 'view-home') viewHistory.push('view-home');
            showView(id);
            if(id==='business-sec') upBal();
        }
        
        function goBack() {
            if(viewHistory.length > 0) showView(viewHistory.pop());
            else {
                if(user) showView('view-home'); else showView('view-agreement');
            }
        }
        
        function showAlert(m,t) {
            document.getElementById('modal-title').innerText=t==='error'?'‚ùå Error':'‚úÖ Success';
            document.getElementById('modal-msg').innerText=m;
            document.getElementById('custom-modal').style.display='flex';
        }
        
        function closeModal(){document.getElementById('custom-modal').style.display='none';}
        
        // --- NAV TABS PROTECT (NO WHITE SCREEN) ---
        function navTab(t) {
            if(t==='home') {
                if(!hasAgreed) return showAlert(lang==='am'?'·ä•·â£·ä≠·ãé ·àò·åÄ·àò·à™·ã´ ·çñ·àä·à≤·ãç·äï ·ã≠·àµ·àõ·àô':'Please agree to policy', "error");
                if(!user) return showAlert(lang==='am'?'·ä•·â£·ä≠·ãé ·ã≠·åç·â°/·ã≠·àò·ãù·åà·â°':'Please Login/Register', "error");
                showView('view-home');
                return;
            }

            if(!hasAgreed) return showAlert(lang==='am'?'·ä•·â£·ä≠·ãé ·àò·åÄ·àò·à™·ã´ ·çñ·àä·à≤·ãç·äï ·ã≠·àµ·àõ·àô':'Please agree to policy', "error");
            if(!user) return showAlert(lang==='am'?'·ä•·â£·ä≠·ãé ·ã≠·åç·â°/·ã≠·àò·ãù·åà·â°':'Please Login/Register', "error");
            
            document.querySelectorAll('.section').forEach(e=>e.classList.remove('show'));
            
            if(t==='live') openLiveCamera();
            else if(t==='profile') {
                showView('view-profile');
                document.getElementById('prof-phone').innerText=user.phone;
                document.getElementById('prof-name-edit').value=user.name;
            }
        }

        // --- AUTH ---
        function handleAgree() { 
            hasAgreed=true; 
            document.getElementById('welcome-content').style.display='none'; 
            document.getElementById('auth-section').style.display='block'; 
        }
        
        function showAuth(t) { 
            document.getElementById('form-signup').style.display = t==='signup'?'block':'none'; 
            document.getElementById('form-login').style.display = t==='login'?'block':'none'; 
        }
        
        // RECEIPT HANDLING
        let lastReceiptUrl = '';
        
        function triggerReceiptModal(url) {
            lastReceiptUrl = url;
            document.getElementById('receipt-modal').style.display='flex';
        }
        
        function downloadReceipt() {
            const a = document.createElement('a');
            a.href = lastReceiptUrl;
            a.download = "Fasil-Receipt.png";
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            showAlert(lang==='am'?'·ãà·ã∞ ·àµ·àç·ä≠·ãé ·â∞·âÄ·àù·åß·àç':'Saved to Phone!', "success");
        }
        
        function closeReceiptModal() {
            document.getElementById('receipt-modal').style.display='none';
            showAlert(lang==='am'?'·ä•·äì·àò·à∞·åç·äì·àà·äï':'Thank you', "success");
            if(uploadTarget === 'intl') navTo('view-home');
            else if(uploadTarget === 'deposit') {
                // Proceed with deposit verification
                finalizeDeposit();
            }
            else if(uploadTarget === 'pay') {
                // Proceed with payment verification
                finPay();
            }
        }

        function promptUpload(target) {
            uploadTarget = target;
            const fileInputMap = {
                'profile': 'file-profile',
                'post': 'file-post',
                'deposit': 'file-deposit',
                'intl': 'file-intl',
                'pay': 'file-pay',
                'chat-img': 'file-chat',
                'chat-vid': 'file-chat',
                'chat-aud': 'file-chat',
                'profile-edit': 'file-profile-edit',
                'comment': 'comment-file-input'
            };
            
            const fileInputId = fileInputMap[target];
            if (!fileInputId) {
                showAlert("Invalid upload target", "error");
                return;
            }
            
            const i = document.getElementById(fileInputId);
            
            // Set accept attribute based on target
            if(target === 'profile' || target === 'profile-edit') i.accept = 'image/*';
            else if(target === 'post') {
                if(activePostType === 'image') i.accept = 'image/*';
                else if(activePostType === 'video') i.accept = 'video/*';
                else if(activePostType === 'audio') i.accept = 'audio/*';
            }
            else if(target === 'chat-img') i.accept = 'image/*';
            else if(target === 'chat-vid') i.accept = 'video/*';
            else if(target === 'chat-aud') i.accept = 'audio/*';
            else if(target === 'comment') {
                if(activePostType === 'image') i.accept = 'image/*';
                else if(activePostType === 'video') i.accept = 'video/*';
                else if(activePostType === 'audio') i.accept = 'audio/*';
            }
            else if(target === 'deposit' || target === 'intl' || target === 'pay') {
                i.accept = 'image/*';
            }
            
            showAlert(lang==='am'?'·çã·ã≠·àç ·ã≠·àù·à®·å°':'Select File', "info");
            i.click();
            
            i.onchange = () => { 
                if(i.files.length === 0) return;
                
                showAlert(lang==='am'?'·â∞·àò·à≠·åß·àç':'Selected', "success");
                
                // Handle Receipt Flow for Money related uploads
                if(target==='deposit' || target==='intl' || target==='pay') {
                    const reader = new FileReader();
                    reader.onload = function(e) { 
                        triggerReceiptModal(e.target.result); 
                    }
                    reader.readAsDataURL(i.files[0]);
                    return;
                }

                if(target==='post') { 
                    document.getElementById('post-form-area').style.display='block'; 
                    document.getElementById('post-type-select').style.display='none';
                }
                if(target==='comment') {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        saveComment(activeCommentPostId, activePostType, e.target.result);
                    }
                    reader.readAsDataURL(i.files[0]);
                }
                if(target.startsWith('chat')) {
                    // Handle chat file upload
                    showAlert(lang==='am'?'·çã·ã≠·àâ ·â∞·å´·äó·àç':'File uploaded', "success");
                }
            };
        }
        
        async function preSignup() {
            const p=document.getElementById('reg-phone').value; 
            const e=document.getElementById('reg-email').value;
            
            if(!p.match(/^09\d{8}$/)) return showAlert(lang==='am'?'·àµ·àç·ä≠ 09 ·â†·àö·åÄ·àù·à≠ 10 ·ä†·àÉ·ãù ·àò·àÜ·äï ·ä†·àà·â†·âµ':'Phone must start with 09 (10 digits)', "error");
            if(!e.endsWith("@gmail.com")) return showAlert(lang==='am'?'·ä¢·àú·àç @gmail.com ·àò·å®·à®·àµ ·ä†·àà·â†·âµ':'Email must be @gmail.com', "error");
            
            // Check if user already exists in Firebase
            const userExists = users.some(u => u.phone === p || u.email === e);
            if (userExists) {
                return showAlert(lang==='am'?'·ã≠·àÖ ·àµ·àç·ä≠/·ä¢·àú·àç ·â∞·àò·ãù·åç·âß·àç':'Already Registered', "error");
            }

            document.getElementById('signup-step-1').style.display='none';
            document.getElementById('signup-step-2').style.display='block';
        }
        
        async function finalSignup() {
            const n=document.getElementById('reg-name').value; 
            const p=document.getElementById('reg-phone').value; 
            const e=document.getElementById('reg-email').value; 
            const pw=document.getElementById('reg-pass').value; 
            const f=document.getElementById('file-profile').files[0];
            
            if(!n || !p || !e || !pw) return showAlert(lang==='am'?'·àÅ·àâ·àù ·àò·àµ·äÆ·âΩ ·àò·àû·àã·âµ ·ä†·àà·â£·â∏·ãç':'All fields are required', "error");
            
            let photoData = '';
            if(f) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    photoData = e.target.result;
                };
                reader.readAsDataURL(f);
            }
            
            const newUser = {
                name: n,
                phone: p,
                email: e,
                password: pw,
                photo: photoData,
                balUSD: 0,
                balGBP: 0,
                balEUR: 0,
                balETB: 0,
                regDate: Date.now(),
                createdAt: new Date().toISOString()
            };
            
            try {
                const success = await saveUser(newUser);
                if(success) {
                    users.push(newUser);
                    showAlert(lang==='am'?'·â∞·àò·ãù·åç·â†·ãã·àç!':'Registered!', "success"); 
                    showAuth('login');
                    // Reset form
                    document.getElementById('signup-step-1').style.display='block';
                    document.getElementById('signup-step-2').style.display='none';
                    document.getElementById('reg-name').value = '';
                    document.getElementById('reg-phone').value = '';
                    document.getElementById('reg-email').value = '';
                    document.getElementById('reg-pass').value = '';
                    document.getElementById('file-profile').value = '';
                } else {
                    showAlert(lang==='am'?'·àù·ãù·åà·â£ ·ä†·àç·â∞·à≥·ä´·àù':'Registration failed', "error");
                }
            } catch (error) {
                showAlert(lang==='am'?'·àù·ãù·åà·â£ ·ä†·àç·â∞·à≥·ä´·àù: ':'Registration failed: ' + error.message, "error");
            }
        }
        
        async function doLogin() {
            const p=document.getElementById('log-phone').value; 
            const pw=document.getElementById('log-pass').value;
            
            if(!p || !pw) return showAlert(lang==='am'?'·àµ·àç·ä≠ ·ä•·äì ·ã®·ã≠·àà·çç ·âÉ·àç ·ã´·àµ·çà·àç·åã·àç':'Phone and password required', "error");
            
            // Refresh users list from Firebase
            await loadAllData();
            
            const u = users.find(x => x.phone === p && x.password === pw);
            if(u){ 
                user = u; 
                if(user.balETB === undefined) user.balETB = 0; 
                localStorage.setItem('fg_user', JSON.stringify(u)); 
                
                // Show admin button if user is admin
                if(user.name === 'Admin' || user.name === 'Fasil' || user.email === 'admin@gmail.com') {
                    document.getElementById('btn-admin-rep').style.display = 'block';
                }
                
                document.getElementById('view-agreement').classList.remove('show'); 
                showView('view-home'); 
                showAlert(lang==='am'?'·ä•·äï·ä≥·äï ·ã∞·àÖ·äì ·àò·å° ' + u.name + '!':'Welcome ' + u.name + '!', "success");
                
                // Reset login form
                document.getElementById('log-phone').value = '';
                document.getElementById('log-pass').value = '';
            } else {
                showAlert(lang==='am'?'·âµ·ä≠·ä≠·àç ·ã´·àç·àÜ·äê ·àµ·àç·ä≠ ·ãà·ã≠·àù ·ã®·ã≠·àà·çç ·âÉ·àç':'Invalid phone or password', "error");
            }
        }
        
        function doLogout(){ 
            user = null; 
            localStorage.removeItem('fg_user'); 
            showAlert(lang==='am'?'·â†·âµ·ä≠·ä≠·àç ·ãà·å•·â∞·ãã·àç':'Logged out successfully', "success");
            setTimeout(() => {
                location.reload();
            }, 1000);
        }
        
        function checkAuth(sec){ 
            if(!user) return showAlert(lang==='am'?'·àò·åÄ·àò·à™·ã´ ·ã≠·åç·â°':'Login First', "error");
            pendingAct = () => navTo(sec);
            document.getElementById('pass-modal').style.display='flex';
        }

        // --- DASHBOARD UI ---
        function toggleList(t) { 
            const l = document.getElementById('list-'+t); 
            l.style.display = l.style.display === 'none' ? 'block' : 'none'; 
        }

        // --- POSTS ---
        function clearPostForm() {
            document.getElementById('p-title').value = '';
            document.getElementById('p-content').value = '';
            document.getElementById('file-post').value = '';
            document.getElementById('post-form-area').style.display = 'none';
            document.getElementById('post-type-select').style.display = 'block';
        }
        
        function setupPost(t){ 
            activePostType = t; 
            if(t !== 'text') {
                promptUpload('post');
            } else {
                document.getElementById('post-form-area').style.display='block'; 
                document.getElementById('post-type-select').style.display='none';
                document.getElementById('p-content').style.display='block'; 
                document.getElementById('post-instr').textContent = lang==='am'?'·à≠·ãï·àµ ·ä•·äì ·ãù·à≠·ãù·à≠ ·ã´·àµ·çà·àç·åã·àç':'Title + Content Required';
            }
            if(t !== 'text') { 
                document.getElementById('p-content').style.display='none'; 
                document.getElementById('post-instr').textContent = lang==='am'?'·à≠·ãï·àµ ·ã´·àµ·çà·àç·åã·àç (·ãù·à≠·ãù·à≠ ·ä†·ã´·àµ·çà·àç·åç·àù)':'Title Required (No Details)'; 
            }
        }
        
        async function submitPost() {
            const t = document.getElementById('p-title').value; 
            const c = document.getElementById('p-content').value;
            
            if(!t) return showAlert(lang==='am'?'·à≠·ãï·àµ ·ã´·àµ·çà·àç·åã·àç':'Title required', "error");
            if(activePostType === 'text' && !c) return showAlert(lang==='am'?'·ãù·à≠·ãù·à≠ ·ã´·àµ·çà·àç·åã·àç':'Content required', "error");
            
            const forbidden = ['politics', 'hate', 'war', 'racism', '·çñ·àà·â≤·ä´', '·ãò·à®·äù·äê·âµ', '·å¶·à≠·äê·âµ', '·àΩ·â•·à≠'];
            if(forbidden.some(w => (t+' '+c).toLowerCase().includes(w))) {
                return showAlert(lang==='am'?'·ä®·çñ·àä·à≤·ã´·âΩ·äï ·ãç·å≠ ·äê·ãç ·àò·àà·å†·çç ·ä†·ã≠·âª·àç·àù':'Content violates policy', "error");
            }

            const save = async (mediaData) => {
                const postData = {
                    t: t,
                    c: c || '',
                    d: mediaData || null,
                    type: activePostType,
                    u: user.name,
                    uid: user.phone,
                    photo: user.photo || '',
                    likes: 0,
                    follows: 0,
                    isHidden: false,
                    comments: [],
                    timestamp: new Date().toISOString(),
                    createdAt: new Date().toISOString()
                };
                
                try {
                    await savePost(postData);
                    showAlert(lang==='am'?'·â∞·à≥·ä≠·â∑·àç!':'Success!', "success"); 
                    
                    // Clear and Reset
                    clearPostForm();
                    renderPosts(activePostType); 
                    navTo('view-info');
                } catch (error) {
                    showAlert(lang==='am'?'·àç·å•·çç ·ä†·àç·â∞·à≥·ä´·àù: ':'Post failed: ' + error.message, "error");
                }
            };
            
            if(activePostType !== 'text') { 
                const f = document.getElementById('file-post').files[0]; 
                if(f){ 
                    const reader = new FileReader(); 
                    reader.onload = e => save(e.target.result); 
                    reader.readAsDataURL(f); 
                } else {
                    save(null);
                }
            } else {
                save(null);
            }
        }
        
        function renderPosts(type) {
            const c = document.getElementById('feed-container'); 
            c.innerHTML = '';
            const fs = posts.filter(p => p.type === type && !p.isHidden);
            
            if(!fs.length) {
                c.innerHTML = '<p style="color: #666; text-align: center; padding: 20px;">' + 
                             (lang==='am'?'·àù·äï·àù ·àç·å•·çé·âΩ ·ã®·àâ·àù':'No posts available') + '</p>';
                return;
            }
            
            fs.forEach(p => {
                let mediaContent = '';
                if(p.d){ 
                    if(p.type === 'image') {
                        mediaContent = `<img src="${p.d}" style="max-width:100%; border-radius:5px; margin:10px 0;">`;
                    } else if(p.type === 'video') {
                        mediaContent = `<video src="${p.d}" controls playsinline style="max-width:100%; border-radius:5px; margin:10px 0;"></video>`;
                    } else if(p.type === 'audio') {
                        mediaContent = `<audio src="${p.d}" controls style="width:100%; margin:10px 0;"></audio>`;
                    }
                }
                
                const isMine = p.uid === user.phone;
                const deleteButton = isMine ? 
                    `<button class="btn-red btn-tiny" style="width:100%; margin-top:5px;" onclick="tryDelete('${p.id}', '${p.uid}')">` + 
                    (lang==='am'?'·àç·å•·çç ·à∞·à≠·ãù':'Delete Post') + '</button>' : '';
                
                c.innerHTML += `
                <div class="post-card">
                    <div class="post-header">
                        <img src="${p.photo || 'lion_image.jpg'}" alt="${p.u}">
                        <div>
                            <b>${p.u}</b><br>
                            <small style="color:#666;">${new Date(p.timestamp || p.createdAt).toLocaleString()}</small>
                        </div>
                    </div>
                    <h4>${p.t}</h4>
                    ${p.c ? `<p>${p.c}</p>` : ''}
                    ${mediaContent}
                    <div class="post-actions">
                        <button class="action-icon" onclick="likePost('${p.id}', this)">
                            <i class="fas fa-thumbs-up"></i> ${lang==='am'?'·ãç·ã∞·ãµ':'Like'} ${p.likes || 0}
                        </button>
                        <button class="action-icon" onclick="openComModal('${p.id}')">
                            <i class="fas fa-comment"></i> ${lang==='am'?'·ä†·àµ·â∞·ã´·ã®·âµ':'Comment'}
                        </button>
                        <button class="action-icon" onclick="sharePost()">
                            <i class="fas fa-share"></i> ${lang==='am'?'·ä†·åã·à´':'Share'}
                        </button>
                        <button class="action-icon" onclick="promptReport('${p.id}', '${p.u}')">
                            <i class="fas fa-flag"></i> ${lang==='am'?'·à™·çñ·à≠·âµ':'Report'}
                        </button>
                        <button class="action-icon" onclick="followUser('${p.id}', this)">
                            <i class="fas fa-user-plus"></i> ${lang==='am'?'·â∞·ä®·â∞·àç':'Follow'} ${p.follows || 0}
                        </button>
                    </div>
                    ${deleteButton}
                </div>`;
            });
        }
        
        async function tryDelete(id, uid){ 
            if(uid === user.phone) { 
                if(confirm(lang==='am'?'·ã≠·àÖ·äï ·àç·å•·çç ·àò·à∞·à®·ãù ·ã≠·çà·àç·åã·àâ?':'Are you sure you want to delete this post?')) {
                    try {
                        const success = await deletePost(id);
                        if(success) {
                            showAlert(lang==='am'?'·â∞·à∞·à≠·ãü·àç':'Deleted', 'success'); 
                            renderPosts(activePostType); 
                        } else {
                            showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ ·â∞·ä®·àµ·â∑·àç':'Error occurred', 'error');
                        }
                    } catch (error) {
                        showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, 'error');
                    }
                }
            } else {
                showAlert(lang==='am'?'·ã≠·àÖ ·àç·å•·çç ·ã®·ä•·à≠·àµ·ãé ·ä†·ã≠·ã∞·àà·àù':'This post is not yours', 'error');
            }
        }
        
        async function likePost(id, btn) { 
            const p = posts.find(x => x.id === id); 
            if (!p) return;
            
            const newLikes = (p.likes || 0) + 1;
            try {
                const success = await updatePost(id, { likes: newLikes });
                if(success) {
                    p.likes = newLikes;
                    btn.innerHTML = `<i class="fas fa-thumbs-up"></i> ${lang==='am'?'·ãç·ã∞·ãµ':'Like'} ${newLikes}`;
                }
            } catch (error) {
                console.error("Error updating likes:", error);
            }
        }
        
        async function followUser(id, btn) { 
            const p = posts.find(x => x.id === id); 
            if (!p) return;
            
            const newFollows = (p.follows || 0) + 1;
            try {
                const success = await updatePost(id, { follows: newFollows });
                if(success) {
                    p.follows = newFollows;
                    btn.innerHTML = `<i class="fas fa-user-plus"></i> ${lang==='am'?'·â∞·ä®·â∞·àç':'Follow'} ${newFollows}`;
                }
            } catch (error) {
                console.error("Error updating follows:", error);
            }
        }
        
        function sharePost() { 
            document.getElementById('share-modal').style.display='flex'; 
        }
        
        function closeShare() { 
            document.getElementById('share-modal').style.display='none'; 
        }
        
        function shareTo(platform) {
            const txt = lang==='am'?'·ã≠·àÖ·äï ·àç·å•·çç ·â†·çã·à≤·àç ·ãå·â• ·ä†·çï ·ã≠·àò·àç·ä®·â±!':'Check this post on Fasil Web App!';
            let url = "";
            
            switch(platform) {
                case 'telegram': url = `https://telegram.me/share/url?url=${encodeURIComponent(window.location.href)}&text=${encodeURIComponent(txt)}`; break;
                case 'facebook': url = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(window.location.href)}&quote=${encodeURIComponent(txt)}`; break;
                case 'tiktok': url = `https://www.tiktok.com/`; break;
                case 'youtube': url = `https://www.youtube.com/`; break;
            }
            
            if(url) {
                window.open(url, '_blank', 'noopener,noreferrer');
            }
            closeShare();
            showAlert(lang==='am'?'·àõ·åã·à´·âµ ·â∞·åÄ·àù·àØ·àç':'Sharing started', "success");
        }
        
        // Comment System
        function openComModal(id){ 
            activeCommentPostId = id; 
            document.getElementById('comment-type-modal').style.display='flex'; 
        }
        
        function openComSub(mode){ 
            comMode = mode; 
            document.getElementById('comment-type-modal').style.display='none'; 
            document.getElementById('comment-media-modal').style.display='flex';
        }
        
        function processComment(type){
            document.getElementById('comment-media-modal').style.display='none';
            if(comMode === 'give'){
                if(type === 'text') {
                    const txt = prompt(lang==='am'?'·ä†·àµ·â∞·ã´·ã®·âµ·ãé·äï ·ã≠·çÉ·çâ':'Enter your comment:');
                    if(!txt) return showAlert(lang==='am'?'·ä†·àµ·â∞·ã´·ã®·âµ ·ã´·àµ·çà·àç·åã·àç':'Comment required', "error");
                    saveComment(activeCommentPostId, type, txt);
                } else {
                    activePostType = type; 
                    const inp = document.getElementById('comment-file-input');
                    inp.accept = type + '/*';
                    inp.click();
                }
            } else {
                const p = posts.find(x => x.id === activeCommentPostId);
                const coms = (p?.comments || []).filter(c => c.type === type);
                const disp = document.getElementById('comments-display-area');
                
                if(coms.length === 0) {
                    disp.innerHTML = `<p style="color:#666; text-align:center; padding:20px;">` + 
                                    (lang==='am'?'·àù·äï·àù ·ä†·àµ·â∞·ã´·ã®·â∂·âΩ ·ã®·àâ·àù':'No comments available') + `</p>`;
                } else {
                    disp.innerHTML = coms.map(c => {
                        let content = c.txt;
                        if(c.type === 'image') content = `<img src="${c.txt}" style="max-width:100%; border-radius:5px;">`;
                        else if(c.type === 'video') content = `<video src="${c.txt}" controls style="max-width:100%; border-radius:5px;"></video>`;
                        else if(c.type === 'audio') content = `<audio src="${c.txt}" controls style="width:100%;"></audio>`;
                        
                        return `<div style="margin-bottom:15px; padding:10px; border-bottom:1px solid #eee;">
                            <b>${c.u}:</b><br>
                            <div style="margin-top:5px;">${content}</div>
                        </div>`;
                    }).join('');
                }
                document.getElementById('view-comments-list-modal').style.display='flex';
            }
        }
        
        async function saveComment(pid, type, txt) {
            const p = posts.find(x => x.id === pid);
            if(!p) {
                showAlert(lang==='am'?'·àç·å•·çâ ·ä†·àç·â∞·åà·äò·àù':'Post not found', "error");
                return;
            }
            
            if(!p.comments) p.comments = [];
            p.comments.push({
                u: user.name,
                type: type,
                txt: txt,
                timestamp: new Date().toISOString()
            });
            
            try {
                const success = await updatePost(pid, { comments: p.comments });
                if(success) {
                    showAlert(lang==='am'?'·ä†·àµ·â∞·ã´·ã®·âµ·ãé ·âÄ·à≠·âß·àç!':'Comment sent!', "success");
                } else {
                    showAlert(lang==='am'?'·ä†·àµ·â∞·ã´·ã®·âµ ·àò·àã·ä≠ ·ä†·àç·â∞·à≥·ä´·àù':'Failed to send comment', "error");
                }
            } catch (error) {
                showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
            }
        }

        // --- ADMIN FUNCTIONS ---
        function promptAdminLogin(){ 
            document.getElementById('admin-login-modal').style.display='flex'; 
        }
        
        function adminLogin(){
            const code = document.getElementById('admin-pass-in').value;
            if(code === adminPass){ 
                document.getElementById('admin-login-modal').style.display='none'; 
                navTo('report-inbox');
                document.getElementById('admin-pass-in').value = '';
            } else {
                showAlert(lang==='am'?'·âµ·ä≠·ä≠·àà·äõ ·ã´·àç·àÜ·äê ·äÆ·ãµ':'Wrong code', "error");
            }
        }
        
        function promptAdminAction(action) {
            pendingAdminAction = action;
            document.getElementById('admin-action-modal').style.display='flex';
        }
        
        async function runAdminAction() {
            const p = document.getElementById('admin-act-pass').value;
            if(p === adminPass) {
                document.getElementById('admin-action-modal').style.display='none';
                document.getElementById('admin-act-pass').value = '';
                
                if(pendingAdminAction === 'changePass') {
                    document.getElementById('admin-chg-modal').style.display='block';
                } else if(pendingAdminAction === 'userStats') {
                    showUserStats();
                } else if(pendingAdminAction === 'premPay') {
                    document.getElementById('adm-prem-modal').style.display='block';
                } else if(pendingAdminAction === 'viewRep') {
                    renderReports();
                }
            } else {
                showAlert(lang==='am'?'·âµ·ä≠·ä≠·àà·äõ ·ã´·àç·àÜ·äê ·ä†·ãµ·àö·äï ·äÆ·ãµ':'Wrong admin code', "error");
            }
        }

        // 1. Change Password
        async function saveNewAdminPass() {
            const old = document.getElementById('old-adm').value;
            const newP = document.getElementById('new-adm').value;
            const confP = document.getElementById('conf-adm').value;
            
            if(old !== adminPass) return showAlert(lang==='am'?'·àå·àã ·ã®·ãµ·àÆ ·ã®·ã≠·àà·çç ·âÉ·àç':'Old password is wrong', "error");
            if(newP !== confP) return showAlert(lang==='am'?'·ä†·ã≤·àµ ·ã®·ã≠·àà·çç ·âÉ·àç ·ä†·àç·å£·àò·à®·àù':'New passwords do not match', "error");
            
            // Strictly 12 characters: 3 letters, 6 numbers, 3 letters
            const regex = /^[a-z]{3}\d{6}[a-z]{3}$/;
            if(!regex.test(newP)) return showAlert(lang==='am'?'·âÖ·à≠·çÖ: 3 ·âµ·äï·àΩ ·çä·ã∞·àã·âµ + 6 ·âÅ·å•·àÆ·âΩ + 3 ·âµ·äï·àΩ ·çä·ã∞·àã·âµ':'Format: 3 small letters + 6 numbers + 3 small letters', "error");
            
            try {
                const success = await updateAdminPassword(newP);
                if(success) {
                    adminPass = newP;
                    showAlert(lang==='am'?'·ã®·ã≠·àà·çç ·âÉ·àç ·â∞·âÄ·ã≠·àØ·àç!':'Password changed!', "success");
                    document.getElementById('admin-chg-modal').style.display='none';
                    // Clear fields
                    document.getElementById('old-adm').value = '';
                    document.getElementById('new-adm').value = '';
                    document.getElementById('conf-adm').value = '';
                } else {
                    showAlert(lang==='am'?'·ã®·ã≠·àà·çç ·âÉ·àç ·àõ·àª·àª·àç ·ä†·àç·â∞·à≥·ä´·àù':'Failed to update password', "error");
                }
            } catch (error) {
                showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
            }
        }

        // 2. User Stats
        function showUserStats(){ 
            let html = '';
            
            if(users.length === 0) {
                html = '<p style="color:#666; text-align:center;">' + (lang==='am'?'·àù·äï·àù ·â∞·å†·âÉ·àö·ãé·âΩ ·ã®·àâ·àù':'No users found') + '</p>';
            } else {
                users.forEach(u => {
                    const userPosts = posts.filter(p => p.uid === u.phone);
                    const totalLikes = userPosts.reduce((sum, p) => sum + (p.likes || 0), 0);
                    const totalFollows = userPosts.reduce((sum, p) => sum + (p.follows || 0), 0);
                    const regTime = u.regDate ? u.regDate : Date.now();
                    const days = Math.floor((Date.now() - regTime) / (1000 * 60 * 60 * 24));
                    
                    const vids = userPosts.filter(p => p.type === 'video').length;
                    const imgs = userPosts.filter(p => p.type === 'image').length;
                    const auds = userPosts.filter(p => p.type === 'audio').length;

                    html += `<div class="post-card">
                        <div style="display:flex; align-items:center; margin-bottom:10px;">
                            <img src="${u.photo || 'lion_image.jpg'}" width="40" height="40" style="border-radius:50%; margin-right:10px;">
                            <div>
                                <b>${u.name}</b><br>
                                <small>${u.phone}</small>
                            </div>
                        </div>
                        <div style="font-size:14px;">
                            <div>${lang==='am'?'·ã®·â∞·àò·ãò·åà·â°·âµ ·âÄ·äì·âµ':'Registration Days'}: <b>${days}</b></div>
                            <div>${lang==='am'?'·ã®·â∞·âÄ·â†·àâ·âµ ·ãç·ã∞·ãµ':'Likes Received'}: <b>${totalLikes}</b></div>
                            <div>${lang==='am'?'·ã®·â∞·âÄ·â†·àâ·âµ ·â∞·ä®·â≥·â≥·ã≠':'Follows Received'}: <b>${totalFollows}</b></div>
                            <div>${lang==='am'?'·àç·å•·çé·âΩ':'Posts'}: ${lang==='am'?'·â™·ã≤·ãÆ':'Video'} (${vids}), ${lang==='am'?'·àù·àµ·àç':'Image'} (${imgs}), ${lang==='am'?'·ãµ·àù·çÖ':'Audio'} (${auds})</div>
                        </div>
                    </div>`;
                });
            }
            
            document.getElementById('admin-dynamic-content').innerHTML = html;
        }

        // 4. Reports
        async function promptReport(id, uname){ 
            const r = prompt(lang==='am'?'·àù·ä≠·äï·ã´·âµ ·ã≠·çÉ·çâ':'Enter reason:'); 
            if(r){ 
                const p = posts.find(x => x.id === id);
                const reportData = {
                    postId: id,
                    reason: r,
                    reporter: user.name,
                    reporterPhone: user.phone,
                    target: uname,
                    postContent: p?.t || '',
                    timestamp: new Date().toISOString()
                };
                
                try {
                    const success = await saveReport(reportData);
                    if(success) {
                        reports.push({ id: Date.now().toString(), ...reportData });
                        showAlert(lang==='am'?'·â∞·à™·çñ·à≠·âµ ·â∞·ã∞·à≠·åì·àç':'Report submitted', "success"); 
                    } else {
                        showAlert(lang==='am'?'·à™·çñ·à≠·âµ ·àõ·àµ·åà·â£·âµ ·ä†·àç·â∞·à≥·ä´·àù':'Failed to submit report', "error");
                    }
                } catch (error) {
                    showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
                }
            } 
        }
        
        function renderReports() {
            const c = document.getElementById('admin-dynamic-content'); 
            c.innerHTML = '';
            
            if(reports.length === 0) { 
                c.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">' + 
                             (lang==='am'?'·àù·äï·àù ·à™·çñ·à≠·â∂·âΩ ·ã®·àâ·àù':'No reports available') + '</p>'; 
                return; 
            }
            
            reports.forEach(r => {
                const p = posts.find(x => x.id === r.postId);
                const isBanned = p ? p.isHidden : false;
                const statusClass = isBanned ? 'banned-text' : 'open-text';
                const containerClass = isBanned ? 'banned-indicator' : '';
                const statusTxt = isBanned ? 
                    (lang==='am'?'·â≥·åç·ã∑·àç (·å•·âÅ·à≠)':'BANNED (Black)') : 
                    (lang==='am'?'·ä≠·çç·âµ (·à∞·àõ·ã´·ãä)':'OPEN (Blue)');

                c.innerHTML += `<div class="post-card ${containerClass}">
                    <div style="margin-bottom:10px;">
                        <b>${lang==='am'?'·ã®·à™·çñ·à≠·âµ ·ä†·ã∞·à´·åÖ':'Reporter'}:</b> ${r.reporter} (${r.reporterPhone})<br>
                        <b>${lang==='am'?'·ã®·àç·å•·çç ·à≠·ãï·àµ':'Post Title'}:</b> ${r.postContent || 'N/A'}<br>
                        <b>${lang==='am'?'·àù·ä≠·äï·ã´·âµ':'Reason'}:</b> ${r.reason}<br>
                        <b>${lang==='am'?'·àÅ·äî·â≥':'Status'}:</b> <span class="${statusClass}">${statusTxt}</span><br>
                        <small style="color:#666;">${new Date(r.timestamp).toLocaleString()}</small>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-red btn-small" onclick="banPost('${r.postId}')">${lang==='am'?'·ä†·åç·ãµ':'Ban'}</button>
                        <button class="btn-blue btn-small" onclick="unbanPost('${r.postId}')">${lang==='am'?'·ä≠·çç·âµ ·ä†·ãµ·à≠·åç':'Unban'}</button>
                        <button class="btn-yellow btn-small" onclick="deleteReport('${r.id}')">${lang==='am'?'·à™·çñ·à≠·âµ ·à∞·à≠·ãù':'Delete Report'}</button>
                    </div>
                </div>`;
            });
        }
        
        async function banPost(id) { 
            const p = posts.find(x => x.id === id); 
            if(p) {
                try {
                    const success = await updatePost(id, { isHidden: true });
                    if(success) {
                        p.isHidden = true;
                        showAlert(lang==='am'?'·â≥·åç·ã∑·àç':'Banned', "success"); 
                        renderReports();
                    } else {
                        showAlert(lang==='am'?'·àõ·åà·ãµ ·ä†·àç·â∞·à≥·ä´·àù':'Failed to ban', "error");
                    }
                } catch (error) {
                    showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
                }
            }
        }
        
        async function unbanPost(id) { 
            const p = posts.find(x => x.id === id); 
            if(p) {
                try {
                    const success = await updatePost(id, { isHidden: false });
                    if(success) {
                        p.isHidden = false;
                        showAlert(lang==='am'?'·ä≠·çç·âµ ·â∞·ã∞·à®·åà':'Unbanned', "success"); 
                        renderReports();
                    } else {
                        showAlert(lang==='am'?'·ä≠·çç·âµ ·àõ·ãµ·à®·åç ·ä†·àç·â∞·à≥·ä´·àù':'Failed to unban', "error");
                    }
                } catch (error) {
                    showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
                }
            }
        }
        
        async function deleteReport(reportId) {
            try {
                const reportRef = doc(db, "reports", reportId);
                await deleteDoc(reportRef);
                reports = reports.filter(r => r.id !== reportId);
                showAlert(lang==='am'?'·à™·çñ·à≠·âµ ·â∞·à∞·à≠·ãü·àç':'Report deleted', "success");
                renderReports();
            } catch (error) {
                console.error("Error deleting report:", error);
            }
        }

        // --- BUSINESS ---
        function upBal(){
            if(!user) return;
            
            document.getElementById('bal-usd').innerText = user.balUSD.toFixed(2);
            document.getElementById('bal-gbp').innerText = user.balGBP.toFixed(2);
            document.getElementById('bal-eur').innerText = user.balEUR.toFixed(2);
            document.getElementById('bal-etb').innerText = user.balETB.toFixed(2);
            
            const tot = user.balUSD + (user.balGBP * 1.25) + (user.balEUR * 1.1) + (user.balETB / 120);
            document.getElementById('bal-total').innerText = tot.toFixed(2);
            
            const totEth = user.balETB + (user.balUSD * 120) + (user.balGBP * 150) + (user.balEUR * 130);
            document.getElementById('bal-total-etb').innerText = totEth.toFixed(2);
        }
        
        function preDeposit(){ 
            document.getElementById('dep-step-1').style.display='none'; 
            document.getElementById('dep-step-2').style.display='block'; 
        }
        
        async function finalizeDeposit(){
            const a = parseFloat(document.getElementById('dep-amt').value); 
            const c = document.getElementById('dep-cur').value;
            
            if(isNaN(a) || a <= 0) return showAlert(lang==='am'?'·âµ·ä≠·ä≠·àà·äõ ·àò·å†·äï ·ã´·àµ·åà·â°':'Enter valid amount', "error");
            
            const minAmount = c === 'ETB' ? 100 : 1;
            if(a < minAmount) return showAlert(lang==='am'?'·ãù·âÖ·â∞·äõ·ãç ·àò·å†·äï ' + minAmount + ' ·äê·ãç':'Minimum amount is ' + minAmount, "error");
            
            // Update user balance
            if(c === 'USD') user.balUSD += a;
            else if(c === 'GBP') user.balGBP += a;
            else if(c === 'EUR') user.balEUR += a;
            else user.balETB += a;
            
            try {
                const success = await saveUser(user);
                if(success) {
                    localStorage.setItem('fg_user', JSON.stringify(user));
                    showAlert(lang==='am'?'·åà·äï·ãò·â• ·â∞·å†·àù·â∑·àç!':'Deposit successful!', "success"); 
                    
                    // Reset form
                    document.getElementById('dep-amt').value = '';
                    document.getElementById('dep-step-1').style.display = 'block';
                    document.getElementById('dep-step-2').style.display = 'none';
                    
                    upBal();
                    navTo('business-sec');
                } else {
                    // Revert balance change on failure
                    if(c === 'USD') user.balUSD -= a;
                    else if(c === 'GBP') user.balGBP -= a;
                    else if(c === 'EUR') user.balEUR -= a;
                    else user.balETB -= a;
                    
                    showAlert(lang==='am'?'·ã®·åà·äï·ãò·â• ·àõ·àµ·åà·â£·âµ ·ä†·àç·â∞·à≥·ä´·àù':'Deposit failed', "error");
                }
            } catch (error) {
                // Revert balance change on error
                if(c === 'USD') user.balUSD -= a;
                else if(c === 'GBP') user.balGBP -= a;
                else if(c === 'EUR') user.balEUR -= a;
                else user.balETB -= a;
                
                showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
            }
        }
        
        function toggleReceiverInput(){
            const m = document.getElementById('w-method').value;
            const i = document.getElementById('w-dest');
            i.style.display = 'block';
            
            if(m === 'PayPal') {
                i.placeholder = lang==='am'?'·ä¢·àú·ã≠·àç (@gmail)':'Email (@gmail)';
            } else if(m === 'CBE') {
                i.placeholder = lang==='am'?'1000... (13 ·ä†·àÉ·ãù)':'1000... (13 digit)';
            } else {
                i.placeholder = lang==='am'?'·àµ·àç·ä≠ 09...':'Phone 09...';
            }
        }
        
        async function reqWithdraw(){
            const m = document.getElementById('w-method').value; 
            const d = document.getElementById('w-dest').value;
            const a = parseFloat(document.getElementById('w-amt').value);
            const c = document.getElementById('w-cur').value;
            
            if(!d) return showAlert(lang==='am'?'·ã®·â∞·âÄ·â£·ã≠ ·àò·à®·åÉ ·ã´·àµ·çà·àç·åã·àç':'Receiver information required', "error");
            if(isNaN(a) || a <= 0) return showAlert(lang==='am'?'·âµ·ä≠·ä≠·àà·äõ ·àò·å†·äï ·ã´·àµ·åà·â°':'Enter valid amount', "error");
            
            // Validation based on method
            if(m === 'Telebirr' && !/^09\d{8}$/.test(d)) {
                return showAlert(lang==='am'?'·â¥·àå·â•·à≠ 09 ·â†·àö·åÄ·àù·à≠ 10 ·ä†·àÉ·ãù ·àò·àÜ·äï ·ä†·àà·â†·âµ':'Telebirr must be 09... (10 digits)', "error");
            }
            if(m === 'PayPal' && !d.endsWith('@gmail.com')) {
                return showAlert(lang==='am'?'@gmail.com ·ä¢·àú·ã≠·àç ·ã´·àµ·çà·àç·åã·àç':'@gmail.com email required', "error");
            }
            if(m === 'CBE' && (!d.match(/^(1000|10000)\d{9}$/) || d.length !== 13)) {
                return showAlert(lang==='am'?'·âµ·ä≠·ä≠·àà·äõ ·ã´·àç·àÜ·äê ·à≤·â¢·ä¢ ·ä†·ä´·ãç·äï·âµ':'Invalid CBE account', "error");
            }
            
            // Check balance
            let balance = 0;
            if(c === 'USD') balance = user.balUSD;
            else if(c === 'GBP') balance = user.balGBP;
            else if(c === 'EUR') balance = user.balEUR;
            else balance = user.balETB;
            
            if(a > balance) {
                return showAlert(lang==='am'?'·â†·âÇ ·àö·ãõ·äï ·ã®·àà·àù. ·ã®·ä•·à≠·àµ·ãé ·àö·ãõ·äï: ' + balance.toFixed(2):
                                 'Insufficient balance. Your balance: ' + balance.toFixed(2), "error");
            }
            
            document.getElementById('pass-modal').style.display='flex';
            pendingAct = async () => {
                // Deduct from balance
                if(c === 'USD') user.balUSD -= a;
                else if(c === 'GBP') user.balGBP -= a;
                else if(c === 'EUR') user.balEUR -= a;
                else user.balETB -= a;
                
                try {
                    const success = await saveUser(user);
                    if(success) {
                        localStorage.setItem('fg_user', JSON.stringify(user));
                        showAlert(lang==='am'?'·åà·äï·ãò·â• ·â∞·ãà·åç·ã∑·àç! ·ãà·ã∞ ' + d + ' ·ä•·ã®·â∞·àã·ä® ·äê·ãç':'Withdrawal successful! Sending to ' + d, "success"); 
                        
                        // Reset form
                        document.getElementById('w-amt').value = '';
                        document.getElementById('w-dest').value = '';
                        document.getElementById('w-dest').style.display = 'none';
                        
                        upBal();
                        navTo('business-sec');
                    } else {
                        // Revert on failure
                        if(c === 'USD') user.balUSD += a;
                        else if(c === 'GBP') user.balGBP += a;
                        else if(c === 'EUR') user.balEUR += a;
                        else user.balETB += a;
                        
                        showAlert(lang==='am'?'·ã®·åà·äï·ãò·â• ·àõ·ãç·å£·âµ ·ä†·àç·â∞·à≥·ä´·àù':'Withdrawal failed', "error");
                    }
                } catch (error) {
                    // Revert on error
                    if(c === 'USD') user.balUSD += a;
                    else if(c === 'GBP') user.balGBP += a;
                    else if(c === 'EUR') user.balEUR += a;
                    else user.balETB += a;
                    
                    showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
                }
            };
        }
        
        function triggerIntlPay(item) {
            showAlert(lang==='am'?'·àà' + item + ' ·ä≠·çç·ã´':'Payment for ' + item, "info");
            document.getElementById('pass-modal').style.display='flex';
            pendingAct = () => { 
                promptUpload('intl'); 
            };
        }
        
        function verifyPass(){ 
            const passInput = document.getElementById('pass-input').value;
            if(passInput === user.password){ 
                document.getElementById('pass-modal').style.display='none'; 
                document.getElementById('pass-input').value = '';
                if(pendingAct) pendingAct(); 
            } else {
                showAlert(lang==='am'?'·âµ·ä≠·ä≠·àà·äõ ·ã´·àç·àÜ·äê ·ã®·ã≠·àà·çç ·âÉ·àç':'Wrong password', "error");
            }
        }

        // --- PREMIUM ---
        function openPrem(t) { 
            showAlert(lang==='am'?'·çï·à™·àö·ã®·àù ' + t + ' ·ä†·åà·àç·åç·àé·âµ':'Premium ' + t + ' service', "info");
            navTo('prem-pricing'); 
        }
        
        function pay(a) { 
            showAlert(lang==='am'?'·ä≠·çç·ã´ ·àà·àò·å®·à®·àµ ·ã®·â∞·âÄ·â†·àç ·ã∞·à®·à∞·äù ·ã≠·å´·äë':'Click upload receipt to complete payment', "info");
            document.getElementById('pay-up-area').style.display='block'; 
        }
        
        function finPay() { 
            showAlert(lang==='am'?'·çï·à™·àö·ã®·àù ·ä†·åà·àç·åç·àé·âµ ·â∞·åÄ·àù·àØ·àç!':'Premium service activated!', "success"); 
            document.getElementById('pay-up-area').style.display='none';
            goBack(); 
        }

        // --- CHAT & USER ---
        function handleGroupCreate() { 
            showUserList(true); 
        }
        
        function showUserList(selMode){
            const c = document.getElementById('ul-cont'); 
            c.innerHTML = '';
            
            if(users.length <= 1) {
                c.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">' + 
                             (lang==='am'?'·àå·àé·âΩ ·â∞·å†·âÉ·àö·ãé·âΩ ·ã®·àâ·àù':'No other users available') + '</p>';
                return;
            }
            
            users.forEach(u => {
                if(u.phone === user.phone) return;
                
                c.innerHTML += `
                <div class="user-item" onclick="${selMode ? 'togBlue(this)' : 'openChat(\'' + u.phone + '\')'}">
                    <img src="${u.photo || 'lion_image.jpg'}" alt="${u.name}">
                    <div>
                        <b>${u.name}</b><br>
                        <small style="color:#666;">${u.phone}</small>
                    </div>
                </div>`;
            });
            
            document.getElementById('btn-grp-done').style.display = selMode ? 'block' : 'none';
            navTo('user-list-sec');
        }
        
        function togBlue(el){ 
            el.classList.toggle('bright-blue'); 
            checkGrpCount(); 
        }
        
        function checkGrpCount(){
            const cnt = document.querySelectorAll('.bright-blue').length;
            document.getElementById('btn-grp-done').style.display = cnt >= 5 ? 'block' : 'none';
        }
        
        async function createGroup(){
            const n = prompt(lang==='am'?'·ã®·åç·à©·çë ·àµ·àù ·ã´·àµ·åà·â°':'Enter group name:'); 
            if(!n) return;
            
            const selectedUsers = Array.from(document.querySelectorAll('.bright-blue'))
                .map(item => {
                    const name = item.querySelector('b').textContent;
                    const phone = item.querySelector('small').textContent;
                    return { name, phone };
                });
            
            if(selectedUsers.length < 5) {
                return showAlert(lang==='am'?'·â¢·ã´·äï·àµ 5 ·â∞·å†·âÉ·àö·ãé·âΩ ·àõ·à∞·â£·à∞·â• ·ä†·àà·â•·ãé·âµ':'You need at least 5 users', "error");
            }
            
            const groupData = {
                name: n, 
                creator: user.phone,
                creatorName: user.name,
                members: selectedUsers,
                msgs: [],
                createdAt: new Date().toISOString()
            };
            
            try {
                const groupId = await saveGroup(groupData);
                groups.push({ id: groupId, ...groupData });
                showAlert(lang==='am'?'·åç·à©·çï ·â∞·çà·å•·àØ·àç!':'Group created!', "success"); 
                goBack();
            } catch (error) {
                showAlert(lang==='am'?'·åç·à©·çï ·àò·çç·å†·à≠ ·ä†·àç·â∞·à≥·ä´·àù: ':'Failed to create group: ' + error.message, "error");
            }
        }
        
        function showMyGroups(){
            const c = document.getElementById('grp-list'); 
            c.innerHTML = '';
            
            const myGroups = groups.filter(g => g.creator === user.phone || 
                (g.members && g.members.some(m => m.phone === user.phone)));
            
            if(myGroups.length === 0) {
                c.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">' + 
                             (lang==='am'?'·àù·äï·àù ·åç·à©·çñ·âΩ ·ã®·àâ·àù':'No groups available') + '</p>';
                return;
            }
            
            myGroups.forEach(g => {
                const isCreator = g.creator === user.phone;
                const memberCount = g.members ? g.members.length : 0;
                const lastMsg = g.msgs && g.msgs.length > 0 ? g.msgs[g.msgs.length-1] : null;
                
                c.innerHTML += `
                <div class="user-item" onclick="openGrp('${g.id}')">
                    <div style="flex-grow:1;">
                        <b>${g.name}</b><br>
                        <small style="color:#666;">
                            ${memberCount} ${lang==='am'?'·â∞·å†·âÉ·àö·ãé·âΩ':'members'} | 
                            ${isCreator ? lang==='am'?'·ä•·à≠·àµ·ãé ·çà·å£·à™':'You created' : lang==='am'?'·ä†·â£·àç':'Member'} |
                            ${lastMsg ? lang==='am'?'·ã®·àò·å®·à®·àª ·àò·àç·ãï·ä≠·âµ: ':'Last: ' + lastMsg.u + ': ' + (lastMsg.t.length > 20 ? lastMsg.t.substring(0,20)+'...' : lastMsg.t) : lang==='am'?'·àù·äï·àù ·àò·àç·ãï·ä≠·âµ ·ã®·àà·àù':'No messages'}
                        </small>
                    </div>
                    <i class="fas fa-chevron-right" style="color:#ccc;"></i>
                </div>`;
            });
            
            navTo('my-groups-sec');
        }
        
        function handleChatList(){ 
            showUserList(false); 
        }
        
        function openChat(ph){ 
            activeChat = { type: 'p', id: ph }; 
            navTo('chat-sec'); 
            renderChat(); 
        }
        
        function openGrp(id){ 
            activeChat = { type: 'g', id: id }; 
            navTo('chat-sec'); 
            renderChat(); 
        }
        
        async function sendChat(type){
            const txt = document.getElementById('chat-in').value; 
            if(!txt.trim() && type === 'text') return;
            
            const msg = {
                u: user.name,
                uid: user.phone,
                t: txt,
                type: type,
                timestamp: new Date().toISOString()
            };
            
            if(activeChat.type === 'p'){ 
                showAlert(lang==='am'?'·ã®·âÄ·å•·â≥ ·âª·âµ ·â†·âÖ·à≠·â° ·ã≠·åà·äõ·àç':'Direct chat coming soon', "info");
                document.getElementById('chat-in').value = '';
            } else { 
                const g = groups.find(x => x.id === activeChat.id);
                if(g) {
                    if(!g.msgs) g.msgs = [];
                    g.msgs.push(msg);
                    
                    try {
                        const success = await updateGroup(g.id, { msgs: g.msgs });
                        if(success) {
                            renderChat();
                            document.getElementById('chat-in').value = '';
                        } else {
                            showAlert(lang==='am'?'·àò·àç·ãï·ä≠·âµ ·àò·àã·ä≠ ·ä†·àç·â∞·à≥·ä´·àù':'Failed to send message', "error");
                        }
                    } catch (error) {
                        showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
                    }
                }
            }
        }
        
        function renderChat(){
            const c = document.getElementById('chat-box'); 
            let msgs = [];
            
            if(activeChat.type === 'p') { 
                // For direct chats (simulated)
                msgs = [
                    { u: 'System', t: lang==='am'?'·ã®·âÄ·å•·â≥ ·âª·âµ ·â†·âÖ·à≠·â° ·ã≠·åà·äõ·àç':'Direct chat coming soon', timestamp: new Date().toISOString() }
                ];
            } else {
                const g = groups.find(x => x.id === activeChat.id);
                msgs = g ? (g.msgs || []) : [];
            }
            
            c.innerHTML = '';
            msgs.forEach(m => {
                const isMe = m.uid === user.phone;
                const time = m.timestamp ? new Date(m.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                
                c.innerHTML += `
                <div style="margin-bottom:10px; text-align:${isMe ? 'right' : 'left'}">
                    <div style="font-size:12px; color:#666; margin-bottom:2px;">
                        ${isMe ? lang==='am'?'·ä•·à≠·àµ·ãé':'You' : m.u} ‚Ä¢ ${time}
                    </div>
                    <div style="background:${isMe ? '#007bff' : '#f0f0f0'}; color:${isMe ? 'white' : 'black'}; 
                        display:inline-block; padding:8px 12px; border-radius:15px; max-width:70%; 
                        word-wrap:break-word; text-align:left;">
                        ${m.t}
                    </div>
                </div>`;
            });
            
            // Scroll to bottom
            c.scrollTop = c.scrollHeight;
        }
        
        // --- LIVE ---
        function openLiveCamera() {
            showView('view-live');
            if(navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true, audio: true })
                    .then(stream => {
                        liveStream = stream;
                        document.getElementById('live-video-element').srcObject = stream;
                        showAlert(lang==='am'?'·âÄ·å•·â≥ ·àµ·à≠·å≠·âµ ·â∞·åÄ·àù·àØ·àç!':'Live stream started!', "success");
                    })
                    .catch(err => {
                        console.error("Error accessing camera:", err);
                        showAlert(lang==='am'?'·ä´·àú·à´ ·àò·ãµ·à®·àµ ·ä†·àç·â∞·à≥·ä´·àù':'Could not access camera', "error");
                        goBack();
                    });
            } else {
                showAlert(lang==='am'?'·ä´·àú·à´ ·ä†·ã≠·ã∞·åà·çç·àù':'Camera not supported', "error");
                goBack();
            }
        }
        
        function stopLive() {
            if(liveStream) {
                liveStream.getTracks().forEach(track => track.stop());
                showAlert(lang==='am'?'·âÄ·å•·â≥ ·àµ·à≠·å≠·âµ ·â∞·âÜ·àù·â∑·àç':'Live stream stopped', "success");
            }
            goBack();
        }

        // --- PROFILE ---
        async function saveProfile() {
            const n = document.getElementById('prof-name-edit').value; 
            const o = document.getElementById('old-pass').value; 
            const p = document.getElementById('new-pass').value; 
            const cp = document.getElementById('conf-pass').value;
            
            if(p && p !== cp) return showAlert(lang==='am'?'·ä†·ã≤·àµ ·ã®·ã≠·àà·çç ·âÉ·àç ·ä†·àç·å£·àò·à®·àù':'New passwords do not match', "error");
            if(o && p && o !== user.password) return showAlert(lang==='am'?'·ã®·ãµ·àÆ ·ã®·ã≠·àà·çç ·âÉ·àç ·âµ·ä≠·ä≠·àç ·ä†·ã≠·ã∞·àà·àù':'Old password is incorrect', "error");
            
            let updates = {};
            if(n && n !== user.name) updates.name = n;
            if(p) updates.password = p;
            
            // Handle photo update if a new photo was selected
            const fileInput = document.getElementById('file-profile-edit');
            if(fileInput.files.length > 0) {
                const reader = new FileReader();
                reader.onload = async function(e) {
                    updates.photo = e.target.result;
                    await completeProfileUpdate(updates);
                };
                reader.readAsDataURL(fileInput.files[0]);
            } else {
                await completeProfileUpdate(updates);
            }
        }
        
        async function completeProfileUpdate(updates) {
            if(Object.keys(updates).length === 0) {
                showAlert(lang==='am'?'·àù·äï·àù ·àà·ãç·å• ·ä†·àç·â∞·ã∞·à®·åà·àù':'No changes made', "info");
                return;
            }
            
            // Update user object
            Object.assign(user, updates);
            
            try {
                const success = await saveUser(user);
                if(success) {
                    localStorage.setItem('fg_user', JSON.stringify(user));
                    showAlert(lang==='am'?'·çï·àÆ·çã·ã≠·àç ·â∞·ãò·àù·äó·àç!':'Profile updated!', "success");
                    
                    // Clear form
                    document.getElementById('old-pass').value = '';
                    document.getElementById('new-pass').value = '';
                    document.getElementById('conf-pass').value = '';
                    document.getElementById('file-profile-edit').value = '';
                } else {
                    showAlert(lang==='am'?'·çï·àÆ·çã·ã≠·àç ·àõ·ãò·àò·äï ·ä†·àç·â∞·à≥·ä´·àù':'Failed to update profile', "error");
                }
            } catch (error) {
                showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
            }
        }

        // --- FEEDBACK ---
        async function giveFb(t) {
            if(t === 'live') {
                openLiveCamera();
            } else { 
                const x = prompt(lang==='am'?'·ä†·àµ·â∞·ã´·ã®·âµ·ãé·äï ·ã≠·çÉ·çâ':'Enter your feedback:'); 
                if(x){ 
                    const feedbackData = {
                        u: user.name,
                        uPhone: user.phone,
                        c: x,
                        type: t,
                        timestamp: new Date().toISOString()
                    };
                    
                    try {
                        const success = await saveFeedback(feedbackData);
                        if(success) {
                            feedbacks.push({ id: Date.now().toString(), ...feedbackData });
                            showAlert(lang==='am'?'·ä†·àµ·â∞·ã´·ã®·âµ·ãé ·âÄ·à≠·âß·àç!':'Feedback sent!', "success"); 
                        } else {
                            showAlert(lang==='am'?'·ä†·àµ·â∞·ã´·ã®·âµ ·àò·àã·ä≠ ·ä†·àç·â∞·à≥·ä´·àù':'Failed to send feedback', "error");
                        }
                    } catch (error) {
                        showAlert(lang==='am'?'·àµ·àÖ·â∞·âµ: ':'Error: ' + error.message, "error");
                    }
                } 
            }
        }
        
        function viewFbs(){ 
            const fbList = document.getElementById('fb-list');
            fbList.innerHTML = '';
            
            if(feedbacks.length === 0) {
                fbList.innerHTML = '<p style="color:#666; text-align:center; padding:20px;">' + 
                                 (lang==='am'?'·àù·äï·àù ·ä†·àµ·â∞·ã´·ã®·â∂·âΩ ·ã®·àâ·àù':'No feedback available') + '</p>';
                return;
            }
            
            feedbacks.forEach(f => {
                fbList.innerHTML += `
                <div class="post-card" style="margin-bottom:10px;">
                    <div style="display:flex; align-items:center; margin-bottom:5px;">
                        <img src="lion_image.jpg" width="30" height="30" style="border-radius:50%; margin-right:10px;">
                        <div>
                            <b>${f.u}</b><br>
                            <small style="color:#666;">${f.uPhone} ‚Ä¢ ${new Date(f.timestamp).toLocaleString()}</small>
                        </div>
                    </div>
                    <div style="padding:10px; background:#f9f9f9; border-radius:5px;">
                        ${f.c}
                    </div>
                    ${f.type ? `<small style="color:#007bff; display:block; margin-top:5px;">${lang==='am'?'·ä†·ã≠·äê·âµ':'Type'}: ${f.type}</small>` : ''}
                </div>`;
            });
        }

        // Initialize the app
        async function initApp() {
            console.log("üöÄ Initializing Fasil Web App...");
            
            try {
                // Test Firebase connection
                const testRef = doc(collection(db, "test"));
                await setDoc(testRef, { 
                    test: "connection", 
                    time: new Date().toISOString(),
                    app: "Fasil Web App"
                });
                
                // Verify connection
                const testDoc = await getDoc(testRef);
                if(testDoc.exists()) {
                    console.log("‚úÖ Firebase connection successful");
                    
                    // Clean up test document
                    await deleteDoc(testRef);
                    
                    // Load all data
                    await loadAllData();
                    
                    // Initialize UI
                    toggleLanguage();
                    
                    // Show welcome message
                    console.log("üéâ Fasil Web App initialized successfully!");
                    
                    // Check if user is already logged in
                    if(user) {
                        console.log("üë§ User already logged in:", user.name);
                        // Refresh user data from Firebase
                        const currentUser = users.find(u => u.phone === user.phone);
                        if(currentUser) {
                            user = currentUser;
                            localStorage.setItem('fg_user', JSON.stringify(user));
                        }
                        
                        // Show admin button if user is admin
                        if(user.name === 'Admin' || user.name === 'Fasil' || user.email === 'admin@gmail.com') {
                            document.getElementById('btn-admin-rep').style.display = 'block';
                        }
                        
                        // Show dashboard
                        document.getElementById('view-agreement').classList.remove('show');
                        showView('view-home');
                    }
                }
            } catch (error) {
                console.error("‚ùå Firebase initialization error:", error);
                showAlert(lang==='am'?'·ã®·çã·ã®·à≠·â§·ãù ·åç·äï·äô·äê·âµ ·ä†·àç·â∞·à≥·ä´·àù. ·ä•·â£·ä≠·ãé ·ä¢·äï·â∞·à≠·äî·âµ ·ã´·à®·åã·åç·å°':'Firebase connection failed. Please check internet', "error");
            }
        }

        // Start the app when page loads
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
